<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiraeth Ancestry Builder</title>
    <style>
        /* Basic Reset & Root Variables */
        :root {
            --bg-color-light: #f8f9fa;
            --text-color-light: #212529;
            --card-bg-light: #ffffff;
            --border-color-light: #dee2e6;
            --primary-color-light: #0d6efd;
            --primary-hover-light: #0b5ed7;
            --secondary-color-light: #6c757d;
            --secondary-hover-light: #5c636a;
            --danger-color-light: #dc3545;
            --danger-hover-light: #bb2d3b;
            --success-color-light: #198754;
            --success-hover-light: #157347;
            --link-color-light: #0d6efd;
            --subtle-text-light: #6c757d;

            --bg-color-dark: #212529;
            --text-color-dark: #f8f9fa;
            --card-bg-dark: #343a40;
            --border-color-dark: #495057;
            --primary-color-dark: #0d6efd; /* Keeping primary blue for contrast */
            --primary-hover-dark: #3b82f6;
            --secondary-color-dark: #6c757d;
            --secondary-hover-dark: #8d969e;
            --danger-color-dark: #dc3545;
            --danger-hover-dark: #e74c5b;
            --success-color-dark: #198754;
            --success-hover-dark: #20c997;
            --link-color-dark: #6ea8fe;
            --subtle-text-dark: #adb5bd;

            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            --border-radius: 0.375rem;
            --spacing: 1rem;
            --transition-speed: 0.2s;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --primary-color: var(--primary-color-light);
            --primary-hover: var(--primary-hover-light);
            --secondary-color: var(--secondary-color-light);
            --secondary-hover: var(--secondary-hover-light);
            --danger-color: var(--danger-color-light);
            --danger-hover: var(--danger-hover-light);
            --success-color: var(--success-color-light);
            --success-hover: var(--success-hover-light);
            --link-color: var(--link-color-light);
            --subtle-text: var(--subtle-text-light);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-color-dark);
            --primary-color: var(--primary-color-dark);
            --primary-hover: var(--primary-hover-dark);
            --secondary-color: var(--secondary-color-dark);
            --secondary-hover: var(--secondary-hover-dark);
            --danger-color: var(--danger-color-dark);
            --danger-hover: var(--danger-hover-dark);
            --success-color: var(--success-color-dark);
            --success-hover: var(--success-hover-dark);
            --link-color: var(--link-color-dark);
            --subtle-text: var(--subtle-text-dark);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            padding: var(--spacing);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        /* Header & Controls */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--spacing) * 1.5);
            padding-bottom: var(--spacing);
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.75rem;
        }

        .theme-switcher button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem 0.8rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        .theme-switcher button:hover {
            background-color: var(--card-bg);
            border-color: var(--primary-color);
        }

        .config-section {
            display: flex;
            gap: var(--spacing);
            margin-bottom: calc(var(--spacing) * 1.5);
            align-items: flex-end;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .config-section label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .config-section select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius);
            min-width: 150px; /* Ensure dropdowns have some width */
        }

        .ap-tracker {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 0.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-left: auto; /* Push AP tracker to the right */
        }
        .ap-tracker.over-limit {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
         .ap-tracker.at-limit {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive columns */
            gap: calc(var(--spacing) * 1.5);
        }

        .column h2 {
            margin-bottom: var(--spacing);
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.25rem;
        }

        /* Trait Styling */
        .trait-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 60vh; /* Limit height and allow scrolling */
            overflow-y: auto;
            padding-right: 0.5rem; /* Space for scrollbar */
        }

        .trait-item {
            position: relative; /* Needed for absolute positioning of source tag */
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing);
            padding: var(--spacing);
            padding-bottom: calc(var(--spacing) * 1.8); /* Extra space for source tag */
            transition: border-color var(--transition-speed);
        }
        .trait-item:hover {
            border-color: var(--primary-color);
        }

        .trait-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .trait-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 0.5rem; /* Space before AP cost */
        }

        .trait-ap {
            font-weight: 500;
            padding: 0.2rem 0.5rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-color); /* Slightly different background */
            border: 1px solid var(--border-color);
            white-space: nowrap; /* Prevent AP cost wrapping */
        }
        .trait-ap.positive { color: var(--primary-color); }
        .trait-ap.negative { color: var(--success-color); } /* Green for negative cost (gain) */
        .trait-ap.zero { color: var(--secondary-color); }

        .trait-desc {
            margin-bottom: 0.8rem;
            font-size: 0.95rem;
        }
        .trait-desc.long {
             white-space: pre-wrap; /* Preserve formatting */
             margin-top: 0.5rem;
             padding-top: 0.5rem;
             border-top: 1px dashed var(--border-color);
        }
        .trait-desc.hidden {
            display: none;
        }

        .trait-actions {
            margin-top: 0.8rem;
            display: flex;
            gap: 0.5rem; /* Space between buttons */
        }

        .trait-actions button {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed);
        }

        .btn-add {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-add:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        .btn-add:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-remove {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-remove:hover {
            background-color: var(--danger-hover);
        }

        .btn-details {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-details:hover {
            background-color: var(--secondary-hover);
        }

        .trait-source-tag {
            position: absolute;
            bottom: 0.5rem;
            right: 0.8rem;
            font-size: 0.8rem;
            color: var(--subtle-text);
            font-style: italic;
        }

        /* Suboption Radio List */
        .suboption-list {
            list-style: none;
            padding: 0;
            margin-top: 0.8rem;
            margin-bottom: 0.5rem;
            border-top: 1px dashed var(--border-color);
            padding-top: 0.8rem;
        }
        .suboption-list li {
            margin-bottom: 0.6rem;
        }
        .suboption-list input[type="radio"] {
            margin-right: 0.5rem;
            vertical-align: middle; /* Align radio button with text */
        }
        .suboption-list label {
            font-weight: 500;
            vertical-align: middle;
        }
        .suboption-list .suboption-item-desc {
            font-size: 0.9rem;
            margin-left: 1.5rem; /* Indent description under radio/label */
            color: var(--subtle-text);
            display: block; /* Ensure it takes its own line */
            margin-top: 0.2rem;
        }


        /* Selected Traits Categories */
        .selected-traits-category {
            margin-top: 1.5rem;
            padding-top: 0.5rem;
            border-top: 2px solid var(--primary-color);
        }
        .selected-traits-category:first-child {
            margin-top: 0;
            border-top: none;
        }
        .selected-traits-category h3 {
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }


        /* Summary Section */
        .summary-section {
            margin-top: calc(var(--spacing) * 2);
            padding-top: var(--spacing);
            border-top: 1px solid var(--border-color);
        }

        .summary-section h2 {
             margin-bottom: var(--spacing);
        }

        .summary-controls {
            display: flex;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .summary-controls button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color var(--transition-speed);
        }

        .btn-summarize {
            background-color: var(--success-color);
            color: white;
        }
        .btn-summarize:hover {
            background-color: var(--success-hover);
        }

        .btn-copy {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-copy:hover {
            background-color: var(--secondary-hover);
        }

        #summary-output {
            width: 100%;
            min-height: 200px;
            padding: var(--spacing);
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius);
            font-family: monospace; /* Good for preformatted text */
            white-space: pre-wrap; /* Preserve line breaks */
            resize: vertical; /* Allow vertical resizing */
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .config-section {
                flex-direction: column;
                align-items: stretch;
            }
            .ap-tracker {
                margin-left: 0;
                margin-top: var(--spacing);
                text-align: center;
            }
            .main-layout {
                 grid-template-columns: 1fr; /* Stack columns */
            }
            .trait-list {
                max-height: none; /* Remove height limit on small screens */
                overflow-y: visible;
            }
        }

    </style>
</head>
<body data-theme="light">

    <div class="container">
        <header class="header">
            <h1>Hiraeth Ancestry Builder</h1>
            <div class="theme-switcher">
                <button id="theme-toggle">Toggle Dark/Light Mode</button>
            </div>
        </header>

        <section class="config-section">
            <div>
                <label for="ancestry1">Primary Ancestry:</label>
                <select id="ancestry1">
                    <option value="">-- Select --</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div>
                <label for="ancestry2">Secondary Ancestry (Optional):</label>
                <select id="ancestry2">
                    <option value="">-- None --</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="ap-tracker" id="ap-tracker">AP: 0 / 5</div>
        </section>

        <main class="main-layout">
            <section class="column available-traits">
                <h2>Available Traits</h2>
                <ul id="available-traits-list" class="trait-list">
                    <!-- Traits populated by JS -->
                    <li class="trait-item">Select one or two ancestries above.</li>
                </ul>
            </section>

            <section class="column selected-traits">
                <h2>Selected Traits</h2>
                <div id="selected-traits-list">
                    <!-- Traits populated and categorized by JS -->
                     <div class="trait-item">No traits selected yet.</div>
                </div>
            </section>
        </main>

        <section class="summary-section">
            <h2>Character Summary</h2>
            <div class="summary-controls">
                <button id="generate-summary" class="btn-summarize">Generate Summary</button>
                <button id="copy-summary" class="btn-copy">Copy Summary</button>
            </div>
            <textarea id="summary-output" readonly placeholder="Click 'Generate Summary' to see the results here..."></textarea>
        </section>

    </div>

    <script>
        const ancestryData = {
    "human": {
        name: "Human",
        description: "Humans are the most adaptable and widespread people. With no singular defining trait beyond their boundless ambition, humans thrive through sheer determination, curiosity, and flexibility.",
        base_stats_override: {}, // Uses defaults: Medium, 30ft Speed, Humanoid
        base_ability_scores: {
            description: "+1 to any two different ability scores, -1 to any one ability score."
        },
        traits: [
            // Default Package Meta-Trait
            {
                id: "human-default-package",
                name: "Default Human Package",
                ap: 5, // Total cost of components
                category: "default_package",
                short_desc: "A balanced set including ASI, Determination, Magic Awareness, and Undying.",
                long_desc: "Selects the following traits for 5 AP:\n- Ability Score Increase (2 AP)\n- Human Determination (1 AP)\n- Magical Awareness (0 AP - Minor)\n- Undying (2 AP)",
                is_default_package: true,
                default_package_traits: ["human-ability-score-increase", "human-determination", "human-magical-awareness", "human-undying"]
            },
            // Default Package Components (also available individually)
            {
                id: "human-ability-score-increase",
                name: "Ability Score Increase",
                ap: 2,
                category: "default_component", // Can be part of default or expanded
                short_desc: "+2 to one ability score.",
                long_desc: "Choose one ability score. It increases by 2. (Note: This stacks with the base Human +1s, but cannot exceed the normal maximum of 20 unless otherwise stated). Remember the base Human rule: +1 to two different scores, -1 to one score."
            },
            {
                id: "human-determination",
                name: "Human Determination",
                ap: 1,
                category: "default_component",
                short_desc: "Use reaction to add 1d4 to a roll.",
                long_desc: "Once per long rest, when you or another creature you can see within 30 feet makes an attack roll, ability check, or saving throw, you can use your reaction to add 1d4 to the roll."
            },
            {
                id: "human-magical-awareness",
                name: "Magical Awareness",
                ap: 0,
                category: "minor", // Also part of default
                short_desc: "Sense strong magic within 30 ft.",
                long_desc: "You can sense the presence of strong magic (active spells of 1st level or higher, or magic items) within 30 feet of you, though you don't know its location or nature. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)"
            },
            {
                id: "human-undying",
                name: "Undying",
                ap: 2,
                category: "default_component",
                short_desc: "Succeed death saves on 9+.",
                long_desc: "When you make a death saving throw, you succeed on a roll of 9 or higher."
            },
            // Expanded Traits
            {
                id: "human-versatile-training",
                name: "Versatile Training",
                ap: 1,
                category: "expanded",
                short_desc: "Proficiency in 1 skill, 1 tool, 1 weapon.",
                long_desc: "You gain proficiency in one skill, one tool, and one simple or martial weapon of your choice."
            },
            {
                id: "human-unbreakable",
                name: "Unbreakable",
                ap: 2,
                category: "expanded",
                short_desc: "Adv. on death saves, regain extra HP when stabilized.",
                long_desc: "You have advantage on death saving throws. When you are stabilized or regain hit points at 0 HP, you regain additional hit points equal to your level plus your proficiency bonus."
            },
            {
                id: "human-quick-learner",
                name: "Quick Learner",
                ap: 1,
                category: "expanded",
                short_desc: "Proficiency in one additional skill or tool.",
                long_desc: "You gain proficiency in one additional skill or tool of your choice."
            },
            {
                id: "human-cultural-memory",
                name: "Cultural Memory",
                ap: 1,
                category: "expanded",
                short_desc: "Learn two additional languages.",
                long_desc: "You learn two additional languages of your choice."
            },
            {
                id: "human-explorers-tenacity",
                name: "Explorer’s Tenacity",
                ap: 1,
                category: "expanded",
                short_desc: "Ignore non-magical difficult terrain, adv. vs travel exhaustion.",
                long_desc: "You ignore the effects of non-magical difficult terrain. You have advantage on Constitution saving throws made to resist exhaustion from forced marches or environmental travel hazards (like extreme heat or cold)."
            },
            {
                id: "human-arcane-curiosity",
                name: "Arcane Curiosity",
                ap: 1,
                category: "expanded",
                short_desc: "Learn one Wizard cantrip (Cha casting).",
                long_desc: "Learn one cantrip of your choice from the Wizard spell list. Charisma is your spellcasting ability for this spell."
            },
            {
                id: "human-spell-dabbler",
                name: "Spell Dabbler",
                ap: 2,
                category: "expanded",
                short_desc: "Learn one 1st-level Wizard spell (Cha casting, 1/LR).",
                long_desc: "Learn one 1st-level spell of your choice from the Wizard spell list. You can cast it once per long rest without expending a spell slot. Charisma is your spellcasting ability for this spell."
            },
             {
                id: "human-channel-spark",
                name: "Channel Spark",
                ap: 1,
                category: "expanded",
                short_desc: "1/LR, add d4 to spell attack or DC.",
                long_desc: "Once per long rest, when you cast a spell that requires an attack roll or forces a saving throw, you can roll a d4 and add it to one attack roll or increase the spell save DC by the number rolled for one target."
            },
            {
                id: "human-counter-instinct",
                name: "Counter-Instinct",
                ap: 1,
                category: "expanded",
                short_desc: "1/SR, use reaction for adv. on save vs magic.",
                long_desc: "Once per short rest, when you are forced to make a saving throw against a spell or magical effect, you can use your reaction to gain advantage on that saving throw."
            },
            {
                id: "human-multi-magical",
                name: "Multi Magical",
                ap: 3,
                category: "expanded",
                short_desc: "+1 spell prepared/known for one class.",
                long_desc: "Increase the number of spells you can prepare (if you prepare spells) or the number of spells you know (if you learn spells) by one. This applies to one spellcasting class you have levels in."
            },
            {
                id: "human-magical-mimicery",
                name: "Magical Mimicery",
                ap: 3,
                category: "expanded",
                short_desc: "Learn spells from another class list.",
                long_desc: "Choose one spell list from a class other than your own. You can learn spells from that list as if they were on your class spell list. You learn one such spell at 2nd level, and another every two levels thereafter (4th, 6th, etc.). These spells must be of a level you can cast."
            },
            // Negative Traits
            {
                id: "human-overconfident",
                name: "Overconfident",
                ap: -1,
                category: "negative",
                short_desc: "Nat 1 gives disadvantage on next similar roll.",
                long_desc: "When you roll a natural 1 on an attack roll or ability check, you have disadvantage on your next attack roll or ability check of the same type (attack or specific skill) before the end of your next turn."
            },
            {
                id: "human-impetuous",
                name: "Impetuous",
                ap: -1,
                category: "negative",
                short_desc: "Disadvantage on initiative rolls.",
                long_desc: "You have disadvantage on initiative rolls."
            },
            {
                id: "human-cultural-disregard",
                name: "Cultural Disregard",
                ap: -1,
                category: "negative",
                short_desc: "Disadv. on social checks with different cultures.",
                long_desc: "You have disadvantage on Wisdom (Insight) or Charisma (Persuasion/Deception) checks involving interactions with cultures significantly different from your own (GM's discretion), unless you share a language with them."
            }
        ]
    },
    "aasimar": {
        name: "Aasimar",
        description: "Aasimar descend from mortals infused with divine power. Their divine heritage manifests through glowing birthmarks and celestial symbols.",
        base_stats_override: {}, // Uses defaults: Medium, 30ft Speed, Humanoid
        base_ability_scores: {
            description: "+1 Dex, +1 Cha, -1 Con"
        },
        traits: [
            // Default Package Meta-Trait
            {
                id: "aasimar-default-package",
                name: "Default Aasimar Package",
                ap: 5,
                category: "default_package",
                short_desc: "Includes Resistance, Revelation, Darkvision, Presence, and Healing Hands.",
                long_desc: "Selects the following traits for 5 AP:\n- Celestial Resistance (2 AP)\n- Celestial Revelation (1 AP - Requires choice)\n- Darkvision (1 AP)\n- Divine Presence (1 AP)\n- Healing Hands (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["aasimar-celestial-resistance", "aasimar-celestial-revelation", "aasimar-darkvision", "aasimar-divine-presence", "aasimar-healing-hands"]
            },
            // Default Package Components
            {
                id: "aasimar-celestial-resistance",
                name: "Celestial Resistance",
                ap: 2,
                category: "default_component",
                short_desc: "Resistance to Radiant and Necrotic damage.",
                long_desc: "You have Resistance to Radiant and Necrotic damage."
            },
            {
                id: "aasimar-celestial-revelation",
                name: "Celestial Revelation",
                ap: 1,
                category: "default_component",
                short_desc: "1/LR bonus action transformation (1 min). Choose type.",
                long_desc: "Once per Long Rest, as a bonus action, undergo a celestial transformation lasting 1 minute. Choose ONE specific Revelation type below.",
                suboptions: [
                    { id: "radiant-soul", name: "Radiant Soul", description: "Gain Flying Speed = walking speed; once/turn, deal extra radiant damage = prof bonus." },
                    { id: "radiant-consumption", name: "Radiant Consumption", description: "Emit light (10ft bright/20ft dim). Creatures within 10ft take radiant dmg = prof bonus at end of your turn; once/turn, deal extra radiant dmg = prof bonus." },
                    { id: "necrotic-shroud", name: "Necrotic Shroud", description: "Creatures within 10ft make Cha save (DC 8 + Prof + Cha) or Frightened until end of your next turn; once/turn, deal extra necrotic dmg = prof bonus." },
                    { id: "dawns-light", name: "Dawn's Light", description: "Emit light (20ft bright/20ft dim); allies starting turn in bright light gain Temp HP = prof bonus." },
                    { id: "twilight-veil", name: "Twilight Veil", description: "You and allies within 10ft ignore difficult terrain & have Adv. on Stealth." },
                    { id: "solar-flare", name: "Solar Flare", description: "Creatures within 10ft make Con save (DC 8 + Prof + Cha) or Blinded until end of your next turn; once/turn, deal extra radiant dmg = prof bonus." },
                    { id: "lunar-shield", name: "Lunar Shield", description: "Gain Temp HP = Level + Cha mod; chosen enemies within 10ft have Disadv. on attacks vs you." },
                    { id: "starfall", name: "Starfall", description: "Create difficult terrain (10ft radius) for enemies; once/turn, deal extra radiant dmg = prof bonus." },
                    { id: "storm-fury", name: "Storm Fury", description: "Gain Flying Speed = walking speed; once/turn, deal extra lightning or thunder dmg (your choice) = prof bonus." },
                    { id: "earthen-guard", name: "Earthen Guard", description: "Gain Resistance to nonmagical B/P/S damage; skin appears stone-like." }
                ]
            },
            {
                id: "aasimar-darkvision",
                name: "Darkvision",
                ap: 1,
                category: "default_component",
                short_desc: "See 60ft in dim/darkness.",
                long_desc: "You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if it were dim light."
            },
            {
                id: "aasimar-divine-presence",
                name: "Divine Presence",
                ap: 1,
                category: "default_component",
                short_desc: "Adv. on Influence checks with respectful beings.",
                long_desc: "Gain Advantage on Influence Checks (like Persuasion or Intimidation) to interact positively with those respectful of divine beings."
            },
            {
                id: "aasimar-healing-hands",
                name: "Healing Hands",
                ap: 0,
                category: "minor", // Also part of default
                short_desc: "1/LR action touch heal (Level + Con mod) HP.",
                long_desc: "Once per Long Rest, you can spend an action to touch a creature, restoring Hit Points equal to your level plus your Constitution modifier. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)"
            },
            // Expanded Traits
            {
                id: "aasimar-virtuous-symbol",
                name: "Virtuous Symbol",
                ap: 0,
                category: "minor",
                short_desc: "Glowing symbol appears when using divine abilities.",
                long_desc: "When you use divine abilities or your Celestial Revelation, a glowing celestial virtue symbol appears above you. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)"
            },
            {
                id: "aasimar-celestial-grace",
                name: "Celestial Grace",
                ap: 1,
                category: "expanded",
                short_desc: "Adv. on saves vs Charmed or Frightened.",
                long_desc: "Gain Advantage on Saving Throws against being Charmed or Frightened."
            },
            {
                id: "aasimar-radiant-pulse",
                name: "Radiant Pulse",
                ap: 1,
                category: "expanded",
                short_desc: "1/Combat reaction when dropping to 0 HP: heal allies 1 HP.",
                long_desc: "Once per Combat, when you are reduced to 0 HP but not killed outright, you may use your reaction to release a burst of radiant energy. All creatures of your choice within 10 feet regain 1 HP. You then fall Unconscious."
            },
            {
                id: "aasimar-virtue-of-mercy",
                name: "Virtue of Mercy",
                ap: 1,
                category: "expanded",
                short_desc: "Stabilized creatures regain HP; 1/LR Stabilize as Free Action.",
                long_desc: "When you successfully Stabilize a creature, they also regain HP equal to half your level (rounded up). Once per Long Rest, you can Stabilize a creature as a Free Action when adjacent."
            },
            {
                id: "aasimar-celestial-tongue",
                name: "Celestial Tongue",
                ap: 1,
                category: "expanded",
                short_desc: "Speak Celestial; Adv. on divine History/Religion checks.",
                long_desc: "You can speak, read, and write Celestial. Additionally, you have Advantage on Intelligence (History) or Intelligence (Religion) checks involving divine beings or celestial planar creatures."
            },
            {
                id: "aasimar-aura-of-warmth",
                name: "Aura of Warmth",
                ap: 1,
                category: "expanded",
                short_desc: "Allies within 10ft gain Adv. on saves vs cold/Frightened.",
                long_desc: "Allies within 10 feet of you gain Advantage on Saving Throws made to resist the effects of extreme cold and effects that cause the Frightened condition."
            },
            {
                id: "aasimar-sacred-legacy",
                name: "Sacred Legacy",
                ap: 1,
                category: "expanded",
                short_desc: "Cast one 1st-level Cleric/Paladin spell 1/LR (Cha).",
                long_desc: "Choose one 1st-level spell from the Cleric or Paladin spell list. You can cast it once per Long Rest without expending a spell slot. Your spellcasting ability for this spell is Charisma."
            },
            {
                id: "aasimar-seraphic-endurance",
                name: "Seraphic Endurance",
                ap: 1,
                category: "expanded",
                short_desc: "Adv. on saves vs Exhaustion; recover 1 level on Short Rest.",
                long_desc: "You have Advantage on Saving Throws to avoid gaining Exhaustion. You recover 1 level of Exhaustion automatically at the end of a Short Rest."
            },
            {
                id: "aasimar-beacon-of-hope",
                name: "Beacon of Hope",
                ap: 1,
                category: "expanded",
                short_desc: "1/LR reaction: allow ally within 25ft to reroll failed save.",
                long_desc: "Once per Long Rest, when an ally within 25 feet fails a Saving Throw, you can use your reaction to allow them to reroll the save. They must use the new result."
            },
            {
                id: "aasimar-luminous-recovery",
                name: "Luminous Recovery",
                ap: 1,
                category: "expanded",
                short_desc: "First time regaining HP in combat, gain Temp HP.",
                long_desc: "The first time you regain HP from a spell, effect, or class feature during a Combat encounter, you also gain Temporary HP equal to your level plus your Constitution modifier."
            },
            {
                id: "aasimar-wings-of-grace",
                name: "Wings of Grace",
                ap: 2,
                category: "expanded",
                short_desc: "Gain Fly Speed = Movement Speed; Controlled Falling.",
                long_desc: "You have manifested spectral wings.\n- You gain a Fly Speed equal to your Movement Speed.\n- While airborne and not Incapacitated, you benefit from Controlled Falling: You take no damage from falling as long as you are conscious."
            },
            // Negative Traits
            {
                id: "aasimar-burden-of-legacy",
                name: "Burden of Legacy",
                ap: -1,
                category: "negative",
                short_desc: "Visible birthmarks impose Disadv. on Stealth.",
                long_desc: "Your visible celestial birthmarks attract unwanted attention, imposing Disadvantage on Dexterity (Stealth) Checks."
            },
            {
                id: "aasimar-divine-expectation",
                name: "Divine Expectation",
                ap: -1,
                category: "negative",
                short_desc: "1/session Disadv. on first check/save defying tradition.",
                long_desc: "Family or community expectations weigh heavily; once per game session, suffer Disadvantage on the first ability check or saving throw related to defying tradition or expectation."
            },
            {
                id: "aasimar-overwhelming-radiance",
                name: "Overwhelming Radiance",
                ap: -1,
                category: "negative",
                short_desc: "Cannot Hide unless heavily obscured/invisible.",
                long_desc: "Your aura of divine energy is hard to suppress. You cannot benefit from the Hide Action unless you are heavily obscured or under the effect of magical concealment like invisibility."
            },
            {
                id: "aasimar-marked-by-destiny",
                name: "Marked by Destiny",
                ap: -1,
                category: "negative",
                short_desc: "Disadv. on first Death Save each session.",
                long_desc: "Your fate feels predetermined. You have Disadvantage on the first Death Saving Throw you make each game session."
            },
            {
                id: "aasimar-celestial-isolation",
                name: "Celestial Isolation",
                ap: -1,
                category: "negative",
                short_desc: "Disadv. on Persuasion/Deception with non-religious NPCs (unless Insight check).",
                long_desc: "Your divine presence unnerves common folk. You have Disadvantage on Charisma (Persuasion) and Charisma (Deception) checks with non-religious NPCs unless you succeed on a DC 10 Wisdom (Insight) check first to gauge their reaction."
            },
            {
                id: "aasimar-heavens-burden",
                name: "Heaven’s Burden",
                ap: -1,
                category: "negative",
                short_desc: "Require 8 hours uninterrupted rest for Long Rest benefits.",
                long_desc: "Your divine energy is taxing. You must rest for at least 8 uninterrupted hours to gain the benefits of a Long Rest (instead of the usual 6 for most features)."
            }
        ]
    },
    "elf": {
        name: "Elf",
        description: "Elves are a diverse and ancient people, known for their grace, martial discipline, and deep cultural traditions.",
        base_stats_override: {}, // Medium, 30ft Speed, Humanoid
        base_ability_scores: {
            description: "+1 Int, +1 Wis, -1 Str"
        },
        traits: [
            // Base Minor Trait (can be replaced by subrace packages)
            {
                id: "elf-fey-ancestry",
                name: "Fey Ancestry",
                ap: 0,
                category: "minor",
                short_desc: "Adv. on saves vs. Charmed, magic can't sleep you.",
                long_desc: "You have advantage on saving throws against being Charmed, and magic can’t put you to sleep. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source. Some subrace packages may replace this)."
            },
            // Base Darkvision (can be modified/replaced by subraces)
            {
                id: "elf-darkvision-base",
                name: "Darkvision (Base)",
                ap: 1, // Assigning AP cost as it's a significant ability
                category: "default_component", // Treat as a core component
                short_desc: "See 60ft in dim/darkness.",
                long_desc: "You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if it were dim light. (Note: Some subraces modify or replace this)."
            },

            // --- Subrace Default Packages (as Meta-Traits) ---
            {
                id: "elf-wood-elf-package",
                name: "Default Wood Elf Package",
                ap: 5, // 0 + 1 + 1 + 2 + 1
                category: "default_package",
                short_desc: "Focuses on forest agility and stealth. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Darkvision (Base) (1 AP)\n- Forest Dweller (1 AP)\n- Mask of the Wild (2 AP)\n- Elven Weapon Training (1 AP)",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-darkvision-base", "elf-forest-dweller", "elf-mask-of-the-wild", "elf-elven-weapon-training"]
            },
            {
                id: "elf-sun-elf-package",
                name: "Default Sun Elf Package",
                ap: 5, // 0 + 2 + 2 + 1
                category: "default_package",
                short_desc: "Tropical adaptation, loses Darkvision. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Born in the Sun (2 AP - Replaces Darkvision)\n- Fisher-Folk (2 AP)\n- Multi-Lingual (1 AP)",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-born-in-the-sun", "elf-fisher-folk", "elf-multi-lingual"]
            },
            {
                id: "elf-snow-elf-package",
                name: "Default Snow Elf Package",
                ap: 5, // 0 + 2 + 1 + 2
                category: "default_package",
                short_desc: "Arctic adaptation, loses Darkvision. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Resilient Senses (2 AP - Replaces Darkvision)\n- Snow-born (1 AP)\n- Rime-Wielder (2 AP)",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-resilient-senses", "elf-snow-born", "elf-rime-wielder"]
            },
            {
                id: "elf-high-drow-package",
                name: "Default High Drow Package",
                ap: 5, // 0 + 3 + 2
                category: "default_package",
                short_desc: "Underdark magic, superior vision. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Drow Magic (3 AP)\n- Superior Darkvision (2 AP - Replaces Base Darkvision)\n(Note: Often taken with Sunlight Sensitivity [-1 AP] to balance points).",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-drow-magic", "elf-superior-darkvision"] // Negative trait added separately
            },
             {
                id: "elf-low-drow-package",
                name: "Default Low Drow Package",
                ap: 5, // 0 + 2 + 2 + 1
                category: "default_package",
                short_desc: "Infravision, stealthy evasion. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Infravision (2 AP - Replaces Darkvision)\n- Easily Missed (2 AP)\n- Nimble Evasion (1 AP)\n(Note: Often taken with Sunlight Sensitivity [-1 AP] to balance points).",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-infravision", "elf-easily-missed", "elf-nimble-evasion"] // Negative trait added separately
            },
             {
                id: "elf-deep-drow-package",
                name: "Default Deep Drow Package",
                ap: 4, // 0 + 2 - 1 + 2 + 1 = 4 (Needs 1 more AP)
                category: "default_package",
                short_desc: "Blindsight, aggressive movement. Includes Fey Ancestry & Sunlight Sensitivity.",
                long_desc: "Selects the following traits for 4 AP (needs +1 AP from another source):\n- Fey Ancestry (0 AP - Minor)\n- Dwellers in Darkness (2 AP - Replaces Vision)\n- Sunlight Sensitivity (-1 AP)\n- Aggressive (2 AP)\n- Echo Sense (1 AP)",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-dwellers-in-darkness", "elf-sunlight-sensitivity", "elf-aggressive", "elf-echo-sense"]
            },
             {
                id: "elf-moon-elf-package",
                name: "Default Moon Elf Package",
                ap: 5, // 0 + 1 + 2 + 1 + 1
                category: "default_package",
                short_desc: "Flight, earthen connection, mystic ties. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Darkvision (Base) (1 AP)\n- Wings (2 AP)\n- Earthen Song (1 AP)\n- Elven Weapon Training (1 AP)",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-darkvision-base", "elf-wings", "elf-earthen-song", "elf-elven-weapon-training"]
            },
             {
                id: "elf-sea-elf-package",
                name: "Default Sea Elf Package",
                ap: 5, // 0 + 1 + 2 + 1 + 1
                category: "default_package",
                short_desc: "Aquatic adaptation and combat. Includes Fey Ancestry.",
                long_desc: "Selects the following traits for 5 AP:\n- Fey Ancestry (0 AP - Minor)\n- Darkvision (Base) (1 AP)\n- Child of the Sea (2 AP)\n- Friend of the Sea (1 AP)\n- Aquatic Combat Training (1 AP)",
                is_default_package: true,
                default_package_traits: ["elf-fey-ancestry", "elf-darkvision-base", "elf-child-of-the-sea", "elf-friend-of-the-sea", "elf-aquatic-combat-training"]
            },

            // --- Subrace/Component Traits (also available individually) ---
            {
                id: "elf-elven-weapon-training", name: "Elven Weapon Training", ap: 1, category: "expanded",
                short_desc: "Proficiency with longsword, shortsword, shortbow, longbow.", long_desc: "You have proficiency with the longsword, shortsword, shortbow, and longbow."
            },
            // Wood Elf
            {
                id: "elf-forest-dweller", name: "Forest Dweller", ap: 1, category: "expanded",
                short_desc: "Gain Climb Speed = walking speed.", long_desc: "You have a Climb Speed equal to your walking speed."
            },
            {
                id: "elf-ambush-predator", name: "Ambush Predator", ap: 2, category: "expanded",
                short_desc: "Proficient with blowgun, apply poison easily.", long_desc: "You gain proficiency with the blowgun. You can apply poison to up to three blowgun darts as a bonus action without risk of poisoning yourself."
            },
            {
                id: "elf-mask-of-the-wild", name: "Mask of the Wild", ap: 2, category: "expanded",
                short_desc: "Can Hide when lightly obscured by nature.", long_desc: "You can attempt to Hide even when you are lightly obscured by foliage, heavy rain, falling snow, mist, and other natural phenomena."
            },
            // Sun Elf
            {
                id: "elf-born-in-the-sun", name: "Born in the Sun", ap: 2, category: "expanded",
                short_desc: "Lose Darkvision, gain Light cantrip (sunlight).", long_desc: "You lose the Darkvision trait but gain the Light cantrip. When cast using this trait, the light shed is considered sunlight."
            },
            {
                id: "elf-fisher-folk", name: "Fisher-Folk", ap: 2, category: "expanded",
                short_desc: "Proficient with nets, finesse with spear/trident.", long_desc: "You gain proficiency with nets. When wielding a spear or trident, you can use Dexterity instead of Strength for the attack and damage rolls (it gains the finesse property for you)."
            },
            {
                id: "elf-multi-lingual", name: "Multi-Lingual", ap: 1, category: "expanded",
                short_desc: "Learn one additional language.", long_desc: "You learn one additional language of your choice."
            },
            // Snow Elf
            {
                id: "elf-resilient-senses", name: "Resilient Senses", ap: 2, category: "expanded",
                short_desc: "Lose Darkvision, see through natural obscurement (60ft), adv. vs Blinded/Deafened.", long_desc: "You lose the Darkvision trait but can see clearly through natural obscurement like blizzards or heavy mist up to 60 feet. You have advantage on saving throws against being Blinded or Deafened by environmental effects."
            },
            {
                id: "elf-snow-born", name: "Snow-born", ap: 1, category: "expanded",
                short_desc: "Adv. on saves vs extreme cold, tolerate cold longer.", long_desc: "You have advantage on Constitution saving throws made to resist the effects of extreme cold. You can tolerate exposure to frigid temperatures below freezing for twice as long (typically 2 hours instead of 1) before needing to make saving throws."
            },
            {
                id: "elf-rime-wielder", name: "Rime-Wielder", ap: 2, category: "expanded",
                short_desc: "Resistance to cold damage, deal extra cold damage after taking cold damage.", long_desc: "You have resistance to cold damage. After you take cold damage, the next time you hit with a weapon attack before the end of your next turn, the target takes an additional 1d6 cold damage."
            },
            // High Drow
            {
                id: "elf-drow-magic", name: "Drow Magic", ap: 3, category: "expanded",
                short_desc: "Dancing Lights, Faerie Fire (3rd), Darkness (5th) 1/LR (Cha).", long_desc: "You know the Dancing Lights cantrip. At 3rd level, you can cast Faerie Fire once per long rest. At 5th level, you can cast Darkness once per long rest. Charisma is your spellcasting ability for these spells."
            },
            {
                id: "elf-superior-darkvision", name: "Superior Darkvision", ap: 2, category: "expanded",
                short_desc: "Darkvision radius becomes 120 feet.", long_desc: "Your Darkvision has a radius of 120 feet. (Replaces base Darkvision)."
            },
            // Low Drow
            {
                id: "elf-infravision", name: "Infravision", ap: 2, category: "expanded",
                short_desc: "Perceive heat signatures within 60ft.", long_desc: "You can perceive heat signatures within 60 feet, allowing you to \"see\" living creatures or recently active heat sources. This vision penetrates fog or darkness but is blocked by 1 inch of wood, 1 foot of stone, or thin sheets of metal. Heat signatures linger briefly, allowing for short-term tracking. (Replaces Darkvision)."
            },
            {
                id: "elf-easily-missed", name: "Easily Missed", ap: 2, category: "expanded",
                short_desc: "Adv. on Stealth in caverns/underground.", long_desc: "You gain advantage on Dexterity (Stealth) checks made to move silently or hide in natural caverns or underground terrain."
            },
            {
                id: "elf-nimble-evasion", name: "Nimble Evasion", ap: 1, category: "expanded",
                short_desc: "1/SR reaction: move 10ft (no OA) when missed by melee attack.", long_desc: "Once per short rest, when a creature misses you with a melee attack, you can use your reaction to move up to 10 feet without provoking opportunity attacks."
            },
            // Deep Drow
            {
                id: "elf-dwellers-in-darkness", name: "Dwellers in Darkness", ap: 2, category: "expanded",
                short_desc: "Lose normal vision/Darkvision, gain Blindsight 60ft.", long_desc: "You lose normal vision and Darkvision. You gain Blindsight out to 60 feet. You are blind beyond this radius."
            },
            {
                id: "elf-aggressive", name: "Aggressive", ap: 2, category: "expanded",
                short_desc: "Bonus action: move speed towards hostile creature.", long_desc: "As a bonus action on your turn, you can move up to your speed toward a hostile creature that you can perceive."
            },
            {
                id: "elf-echo-sense", name: "Echo Sense", ap: 1, category: "expanded",
                short_desc: "Detect creatures behind cover by sound (30ft), adv. on hearing checks.", long_desc: "You can detect the presence of creatures behind full cover or thin barriers if they make any sound within 30 feet. You gain advantage on Wisdom (Perception) checks that rely on hearing."
            },
            // Moon Elf
            {
                id: "elf-wings", name: "Wings", ap: 2, category: "expanded",
                short_desc: "Flying speed 30ft (no medium/heavy armor).", long_desc: "You gain a flying speed of 30 feet. You cannot use this flying speed if you are wearing medium or heavy armor."
            },
            {
                id: "elf-earthen-song", name: "Earthen Song", ap: 1, category: "expanded",
                short_desc: "1/LR action on natural ground: gain adv. on next ability check.", long_desc: "Once per long rest, while standing on natural earth, stone, or metal, you may use an action to focus your connection. You gain advantage on the next ability check you make within the next minute."
            },
            {
                id: "elf-mystic-ties", name: "Mystic Ties", ap: 2, category: "expanded",
                short_desc: "Proficiency in Arcana, learn one additional language.", long_desc: "You gain proficiency in the Arcana skill and learn one additional language of your choice."
            },
            // Sea Elf
            {
                id: "elf-child-of-the-sea", name: "Child of the Sea", ap: 2, category: "expanded",
                short_desc: "Swimming speed 30ft, breathe air and water.", long_desc: "You have a swimming speed of 30 feet, and you can breathe both air and water."
            },
            {
                id: "elf-friend-of-the-sea", name: "Friend of the Sea", ap: 1, category: "expanded",
                short_desc: "Communicate simple ideas to swimming beasts.", long_desc: "Using gestures and sounds, you can communicate simple ideas to beasts that have an innate swimming speed. They can understand your general meaning, though you cannot understand them in return without magic."
            },
            {
                id: "elf-aquatic-combat-training", name: "Aquatic Combat Training", ap: 1, category: "expanded", // Renamed/Adjusted from Aquatic Fighter
                short_desc: "Proficient with trident, net, spear.", long_desc: "You are proficient with the trident, net, and spear."
            },

            // --- General Expanded Traits ---
            {
                id: "elf-elven-will", name: "Elven Will", ap: 1, category: "expanded",
                short_desc: "Adv. on saves vs Charmed/magical sleep (Redundant w/ Fey Ancestry).", long_desc: "You have advantage on saving throws against being Charmed or magically put to sleep. (Note: Redundant with Fey Ancestry Minor Trait unless that trait is replaced)."
            },
            {
                id: "elf-nimble", name: "Nimble", ap: 2, category: "expanded",
                short_desc: "Dodge action becomes Full Dodge.", long_desc: "When you take the Dodge Action, you instead gain the benefits of the Full Dodge Action (enemies have disadvantage on attacks against you, and you have advantage on Dexterity saving throws until the start of your next turn)."
            },
            {
                id: "elf-agile-explorer", name: "Agile Explorer", ap: 2, category: "expanded",
                short_desc: "Moving through non-magical difficult terrain costs no extra movement.", long_desc: "Moving through non-magical difficult terrain costs you no extra movement."
            },
            {
                id: "elf-peerless-sight", name: "Peerless Sight", ap: 1, category: "expanded",
                short_desc: "No disadvantage on ranged attacks at long range.", long_desc: "You do not suffer disadvantage on attack rolls with ranged weapons due to attacking at long range."
            },
            {
                id: "elf-plant-knowledge", name: "Plant Knowledge", ap: 1, category: "expanded",
                short_desc: "Adv. on Survival/Nature checks for plants in forests/jungles/swamps.", long_desc: "While in forests, jungles, or swamps, you have advantage on Wisdom (Survival) checks to navigate or forage, and on Intelligence (Nature) checks to recall information about plants."
            },
            {
                id: "elf-climb-speed", name: "Climb Speed", ap: 1, category: "expanded",
                short_desc: "Gain Climb Speed = walking speed.", long_desc: "You gain a Climb Speed equal to your walking speed."
            },
            {
                id: "elf-speed-increase", name: "Speed Increase", ap: 2, category: "expanded",
                short_desc: "Walking speed increases by 5 feet.", long_desc: "Your walking speed increases by 5 feet."
            },
            {
                id: "elf-trade-expertise", name: "Trade Expertise (Elf)", ap: 1, category: "expanded",
                short_desc: "Choose a Trade; Mastery Cap & Level +1.", long_desc: "Choose a Trade. Your Mastery Cap and Mastery Level in that trade both increase by 1."
            },
            {
                id: "elf-silent-step", name: "Silent Step", ap: 1, category: "expanded",
                short_desc: "Move full speed while Stealthing in natural terrain.", long_desc: "You can move at your full speed while using Dexterity (Stealth) without penalty in natural terrain (forests, mountains, underground, etc.)."
            },
            {
                id: "elf-fey-mind", name: "Fey Mind", ap: 1, category: "expanded",
                short_desc: "Proficiency in Arcana, learn Prestidigitation cantrip (Int).", long_desc: "You gain proficiency in the Arcana skill, and you learn the Prestidigitation cantrip. Intelligence is your spellcasting ability for this cantrip."
            },
            {
                id: "elf-elven-accuracy", name: "Elven Accuracy", ap: 2, category: "expanded",
                short_desc: "Prereq: 13+ Dex/Int/Wis/Cha. Reroll one die when attacking with Adv.", long_desc: "Prerequisite: Dexterity, Intelligence, Wisdom, or Charisma score of 13 or higher. When you have advantage on an attack roll using Dexterity, Intelligence, Wisdom, or Charisma, you can reroll one of the dice once."
            },
            {
                id: "elf-ancient-tongue", name: "Ancient Tongue", ap: 1, category: "expanded",
                short_desc: "Learn 2 languages (1 ancient/rare), adv. on elven History checks.", long_desc: "You learn two additional languages, one of which must be an ancient or rare dialect (GM’s discretion, e.g., Ancient Elvish, Sylvan, Draconic). You also have advantage on Intelligence (History) checks related to elven artifacts or lore."
            },
            {
                id: "elf-meditative-focus", name: "Meditative Focus", ap: 1, category: "expanded",
                short_desc: "1/LR after Trance: regain 1 Superiority die or 1st-level spell slot.", long_desc: "Once per long rest, after completing a short rest using your Trance feature (if applicable, standard Elves trance instead of sleep), you can choose to either regain one expended Superiority die (if you have any) or regain one expended 1st-level spell slot."
            },
            {
                id: "elf-fey-step", name: "Fey Step", ap: 2, category: "expanded",
                short_desc: "1/SR or LR bonus action: teleport 30ft.", long_desc: "Once per short or long rest, as a bonus action, you can teleport up to 30 feet to an unoccupied space you can see. You leave behind a brief shimmer of natural energy (leaves, mist, moonlight, etc.)."
            },
            {
                id: "elf-spirit-touched", name: "Spirit-Touched", ap: 1, category: "expanded",
                short_desc: "Communicate with spirits, adv. on fey/spirit Arcana/Nature checks.", long_desc: "You can attempt to communicate with willing spirits of beasts, fey, or the recently departed during rituals or in places of deep natural or spiritual power (GM's discretion). Gain advantage on Intelligence (Arcana) or Intelligence (Nature) checks related to fey and ancestral spirits."
            },
            {
                id: "elf-wild-intuition", name: "Wild Intuition", ap: 1, category: "expanded",
                short_desc: "Use Wis instead of Int for Arcana/Nature checks.", long_desc: "You may use your Wisdom modifier instead of your Intelligence modifier when making Intelligence (Arcana) or Intelligence (Nature) checks."
            },
            {
                id: "elf-graceful-fall", name: "Graceful Fall", ap: 1, category: "expanded",
                short_desc: "Reaction: reduce falling damage by 5 x prof bonus.", long_desc: "When you fall, you can use your reaction to reduce any falling damage you take by an amount equal to five times your proficiency bonus."
            },
            {
                id: "elf-refined-duelist", name: "Refined Duelist", ap: 1, category: "expanded",
                short_desc: "Proficient with rapiers, +1 AC with single 1H weapon/no shield.", long_desc: "You gain proficiency with rapiers. While you are wielding a single one-handed melee weapon and no shield, you gain a +1 bonus to your AC."
            },
            {
                id: "elf-trance-knowledge", name: "Trance Knowledge", ap: 4, category: "expanded",
                short_desc: "During Trance, gain temp proficiency in one skill/tool until next LR.", long_desc: "During a long rest (using Trance), you can focus your meditation to gain temporary proficiency in one skill or tool of your choice. This proficiency lasts until you finish your next long rest."
            },
            {
                id: "elf-arcane-reflexes", name: "Arcane Reflexes", ap: 1, category: "expanded",
                short_desc: "Reaction on initiative (if not surprised): cast a cantrip.", long_desc: "When you roll initiative, if you are not surprised, you can use your reaction to cast a cantrip you know that has a casting time of 1 action. The target must be within range."
            },

            // --- Negative Traits ---
             {
                id: "elf-sunlight-sensitivity", name: "Sunlight Sensitivity", ap: -1, category: "negative",
                short_desc: "Disadv. on attacks/Perception in direct sunlight.", long_desc: "You have disadvantage on attack rolls and on Wisdom (Perception) checks that rely on sight when you, the target of your attack, or whatever you are trying to perceive is in direct sunlight."
            },
            {
                id: "elf-frail", name: "Frail", ap: -1, category: "negative",
                short_desc: "HP maximum reduced by level.", long_desc: "Your hit point maximum is reduced by an amount equal to your level."
            },
            {
                id: "elf-might-decrease", name: "Might Decrease", ap: -1, category: "negative",
                short_desc: "Strength score decreases by 2 (min 1).", long_desc: "Your Strength score decreases by 2 (minimum score of 1)."
            },
            {
                id: "elf-aloof", name: "Aloof", ap: -1, category: "negative",
                short_desc: "Disadv. on Persuasion with non-friendly non-elves.", long_desc: "You have disadvantage on Charisma (Persuasion) checks when interacting with non-elves who are not already friendly towards you."
            },
            {
                id: "elf-fragile-focus", name: "Fragile Focus", ap: -1, category: "negative",
                short_desc: "Disadv. on Con saves to maintain concentration when damaged.", long_desc: "You have disadvantage on Constitution saving throws made to maintain concentration on spells when you take damage."
            },
            {
                id: "elf-prideful", name: "Prideful", ap: -1, category: "negative",
                short_desc: "Cannot benefit from Help action after failing a save vs creature.", long_desc: "If you fail a saving throw against an effect caused by another creature, you cannot benefit from the Help action on your next turn."
            },
            {
                id: "elf-ethereal-disconnect", name: "Ethereal Disconnect", ap: -1, category: "negative",
                short_desc: "Disadv. on saves vs banishment/forced teleport.", long_desc: "You have disadvantage on saving throws against effects that would banish you to another plane of existence or teleport you against your will."
            },
            {
                id: "elf-arrogant-legacy", name: "Arrogant Legacy", ap: -1, category: "negative",
                short_desc: "Fail contested check vs non-elf: -1d4 on next check with same skill.", long_desc: "When you fail an ability check contested by a non-elf, you must subtract 1d4 from your next ability check using the same skill before the end of your next turn."
            },
            {
                id: "elf-arcane-fragility", name: "Arcane Fragility", ap: -1, category: "negative",
                short_desc: "Disadv. on saves vs psychic or force damage.", long_desc: "You have disadvantage on saving throws against spells or effects that deal psychic or force damage."
            },
            {
                id: "elf-blood-of-starlight", name: "Blood of Starlight", ap: -1, category: "negative",
                short_desc: "Disadv. on Stealth vs blindsight/tremorsense within 30ft.", long_desc: "You emit faint, almost imperceptible magical energy. You have disadvantage on Dexterity (Stealth) checks made to hide from creatures with blindsight or tremorsense within 30 feet."
            },
            {
                id: "elf-lone-tradition", name: "Lone Tradition", ap: -1, category: "negative",
                short_desc: "Cannot benefit from Help on Arcana/Insight checks.", long_desc: "You may not benefit from an ally’s Help action when making Intelligence (Arcana) or Wisdom (Insight) checks."
            },
            {
                id: "elf-fey-aversion", name: "Fey Aversion", ap: -1, category: "negative",
                short_desc: "Disadv. on initial Animal Handling/Persuasion with Beasts/Fey/Celestials.", long_desc: "Mundane Beasts, Fey creatures, and Celestials are subtly unnerved by your presence unless you prove friendly. You have disadvantage on Charisma (Animal Handling) checks with Beasts and initial Charisma (Persuasion) checks with Fey and Celestials."
            },
            {
                id: "elf-vulnerable-roots", name: "Vulnerable Roots", ap: -1, category: "negative",
                short_desc: "1/LR: Drop to 0 HP on natural ground -> auto-fail first death save.", long_desc: "Once per long rest, if you are reduced to 0 HP while standing on natural earth or amidst living plants, you automatically fail your first death saving throw as your spirit feels a painful severing from ancient ties."
            },
            {
                id: "elf-entitled-duelist", name: "Entitled Duelist", ap: -1, category: "negative",
                short_desc: "Enemy attacks ally instead of you -> disadv. on next attack vs that enemy.", long_desc: "When an enemy engaged in melee with you chooses to attack one of your allies instead of you, you have disadvantage on your next attack roll against that enemy before the end of your next turn."
            }
        ]
    },
    "dwarf": {
        name: "Dwarf",
        description: "Dwarves are a hardy and deeply traditional people, forged in stone and strengthened by the weight of legacy.",
        base_stats_override: { // Override default speed
            speed: 25
        },
        base_ability_scores: {
            description: "+1 Con, +1 Str, -1 Cha"
        },
        traits: [
            // Base Traits (Considered Core Components)
            {
                id: "dwarf-darkvision", name: "Darkvision", ap: 1, category: "default_component",
                short_desc: "See 60ft in dim/darkness.", long_desc: "You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if it were dim light."
            },
            {
                id: "dwarf-dwarven-resilience", name: "Dwarven Resilience", ap: 2, category: "default_component", // Cost reflects adv + resistance
                short_desc: "Adv. on saves vs poison, resistance to poison damage.", long_desc: "You have advantage on saving throws against poison, and you have resistance against poison damage."
            },

            // --- Default/Subrace Packages (as Meta-Traits) ---
            {
                id: "dwarf-iron-mountain-package", name: "Default Iron Mountain Package", ap: 5, category: "default_package",
                short_desc: "Classic hardy dwarf. Includes Darkvision & Resilience.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Dwarven Resilience (2 AP)\n- Tough (1 AP)\n- Dwarven Combat Training (1 AP)\n- Tool Proficiency (0 AP - Minor - Requires choice)",
                is_default_package: true,
                default_package_traits: ["dwarf-darkvision", "dwarf-dwarven-resilience", "dwarf-tough", "dwarf-dwarven-combat-training", "dwarf-tool-proficiency"]
            },
             {
                id: "dwarf-ironbash-package", name: "Default Ironbash Package", ap: 5, category: "default_package",
                short_desc: "Resilient defender. Includes Darkvision & Resilience.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Dwarven Resilience (2 AP)\n- Rock Stepper (2 AP)\n- Iron Stomach (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["dwarf-darkvision", "dwarf-dwarven-resilience", "dwarf-rock-stepper", "dwarf-iron-stomach"]
            },
             {
                id: "dwarf-auroran-package", name: "Default Auroran Package", ap: 5, category: "default_package",
                short_desc: "Psionic/Aberration focus. Includes Darkvision & Resilience.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Dwarven Resilience (2 AP)\n- Deep Delver (2 AP)\n- Iron Stomach (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["dwarf-darkvision", "dwarf-dwarven-resilience", "dwarf-deep-delver", "dwarf-iron-stomach"]
            },
             {
                id: "dwarf-mountain-package", name: "Default Mountain Package", ap: 5, category: "default_package",
                short_desc: "Defensive mountaineer. Includes Darkvision & Resilience.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Dwarven Resilience (2 AP)\n- Mountaineer (2 AP)\n- Iron Stomach (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["dwarf-darkvision", "dwarf-dwarven-resilience", "dwarf-mountaineer", "dwarf-iron-stomach"]
            },
             {
                id: "dwarf-hill-package", name: "Default Hill Package", ap: 5, category: "default_package",
                short_desc: "Tough and social. Includes Darkvision & Resilience.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Dwarven Resilience (2 AP)\n- Dwarven Toughness (2 AP)\n- Iron Stomach (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["dwarf-darkvision", "dwarf-dwarven-resilience", "dwarf-dwarven-toughness", "dwarf-iron-stomach"]
            },
             {
                id: "dwarf-cave-package", name: "Default Cave Package", ap: 4, category: "default_package", // Still 4 AP after negative
                short_desc: "Underground specialist. Includes Resilience & Sunlight Sensitivity.",
                long_desc: "Selects the following traits for 4 AP (needs +1 AP from another source):\n- Dwarven Resilience (2 AP)\n- Superior Darkvision (Dwarf) (2 AP - Replaces Base Darkvision)\n- Barren Acclimation (1 AP)\n- Sunlight Sensitivity (Dwarf) (-1 AP)\n- Iron Stomach (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["dwarf-dwarven-resilience", "dwarf-superior-darkvision", "dwarf-barren-acclimation", "dwarf-sunlight-sensitivity", "dwarf-iron-stomach"]
            },
             {
                id: "dwarf-magma-package", name: "Default Magma Package", ap: 5, category: "default_package",
                short_desc: "Fire resistant crafter. Includes Darkvision & Resilience.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Dwarven Resilience (2 AP)\n- Lavawalking (2 AP)\n- Iron Stomach (0 AP - Minor)",
                is_default_package: true,
                default_package_traits: ["dwarf-darkvision", "dwarf-dwarven-resilience", "dwarf-lavawalking", "dwarf-iron-stomach"]
            },

            // --- Component/Expanded Traits ---
            // Iron Mountain Components
            {
                id: "dwarf-tough", name: "Tough", ap: 1, category: "expanded",
                short_desc: "+1 HP per level.", long_desc: "Your hit point maximum increases by 1, and it increases by 1 every time you gain a level."
            },
            {
                id: "dwarf-dwarven-combat-training", name: "Dwarven Combat Training", ap: 1, category: "expanded",
                short_desc: "Proficiency with battleaxe, handaxe, light hammer, warhammer.", long_desc: "You have proficiency with the battleaxe, handaxe, light hammer, and warhammer."
            },
            {
                id: "dwarf-tool-proficiency", name: "Tool Proficiency", ap: 0, category: "minor", // Made minor for Iron Mountain package
                short_desc: "Proficiency with smith's, brewer's, or mason's tools.",
                long_desc: "You gain proficiency with one type of artisan’s tools. Choose one below.",
                suboptions: [
                    { id: "smiths", name: "Smith's Tools", description: "Proficiency with smith's tools." },
                    { id: "brewers", name: "Brewer's Supplies", description: "Proficiency with brewer's supplies." },
                    { id: "masons", name: "Mason's Tools", description: "Proficiency with mason's tools." }
                ]
            },
            {
                id: "dwarf-stonecunning", name: "Stonecunning", ap: 1, category: "expanded", // Was part of Iron Mountain, now expanded
                short_desc: "Double proficiency bonus on History checks for stonework.", long_desc: "Whenever you make an Intelligence (History) check related to the origin of stonework, you are considered proficient in the History skill and add double your proficiency bonus to the check, instead of your normal proficiency bonus."
            },
            {
                id: "dwarf-iron-stomach", name: "Iron Stomach", ap: 0, category: "minor", // Changed to 0 AP Minor
                short_desc: "Adv. on saves vs ingested poisons/diseases.", long_desc: "You have advantage on saving throws against ill effects from consuming food or drink (like ingested poisons or diseases). (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)"
            },
             // Ironbash Components
            {
                id: "dwarf-rock-stepper", name: "Rock Stepper", ap: 2, category: "expanded",
                short_desc: "Ignore difficult terrain from rubble/stone.", long_desc: "You ignore difficult terrain caused by rubble, stone, or broken ground."
            },
            {
                id: "dwarf-reactive-skin", name: "Reactive Skin", ap: 2, category: "expanded",
                short_desc: "1/LR gain resistance to first nonmagical B/P/S damage type taken.", long_desc: "The first time you take bludgeoning, piercing, or slashing damage from a nonmagical attack after finishing a long rest, you gain resistance to that specific damage type from nonmagical attacks until your next long rest."
            },
            {
                id: "dwarf-weapon-mastery", name: "Weapon Mastery", ap: 1, category: "expanded", // Was part of Ironbash
                short_desc: "Proficiency with one martial weapon.", long_desc: "You gain proficiency with one martial weapon of your choice."
            },
            // Auroran Components
            {
                id: "dwarf-deep-delver", name: "Deep Delver", ap: 2, category: "expanded",
                short_desc: "Adv. on saves vs Aberrations, adv. on Int checks about them.", long_desc: "You have advantage on saving throws against spells and abilities used by Aberrations. You also have advantage on Intelligence checks to identify or recall information about Aberrations."
            },
            {
                id: "dwarf-intense-focus", name: "Intense Focus", ap: 2, category: "expanded", // Was part of Auroran
                short_desc: "Adv. on Con saves to maintain concentration.", long_desc: "You have advantage on Constitution saving throws that you make to maintain your concentration on a spell when you take damage."
            },
            {
                id: "dwarf-mental-adaptations", name: "Mental Adaptations", ap: 1, category: "expanded", // Was part of Auroran
                short_desc: "Message cantrip, Dissonant Whispers (3rd), Detect Thoughts (5th) 1/LR (Wis).", long_desc: "You learn the Message cantrip. At 3rd level, you can cast Dissonant Whispers once per long rest. At 5th level, you can cast Detect Thoughts once per long rest. Wisdom is your spellcasting ability for these spells."
            },
            // Mountain Components
            {
                id: "dwarf-mountaineer", name: "Mountaineer", ap: 2, category: "expanded",
                short_desc: "Climb speed 25ft, adv. vs prone/move in mountains, know north.", long_desc: "You gain a Climb Speed of 25 feet. You have advantage on saving throws against being knocked prone or moved against your will while on rocky or mountainous terrain. You always know which way is north while underground or in mountains."
            },
            {
                id: "dwarf-stout-defender", name: "Stout Defender", ap: 2, category: "expanded", // Was part of Mountain
                short_desc: "Gain Protection Fighting Style (requires shield).", long_desc: "You gain the Protection Fighting Style: When a creature you can see attacks a target other than you that is within 5 feet of you, you can use your reaction to impose disadvantage on the attack roll. You must be wielding a shield."
            },
            // Hill Components
            {
                id: "dwarf-dwarven-toughness", name: "Dwarven Toughness", ap: 2, category: "expanded", // Reduced cost from 3 to 2
                short_desc: "HP maximum increases by level.", long_desc: "Your hit point maximum increases by an amount equal to your level."
            },
            {
                id: "dwarf-mercantile-mindset", name: "Mercantile Mindset", ap: 2, category: "expanded", // Was part of Hill
                short_desc: "Proficiency in Persuasion and Insight.", long_desc: "You gain proficiency in the Persuasion and Insight skills."
            },
            // Cave Components
            {
                id: "dwarf-superior-darkvision", name: "Superior Darkvision (Dwarf)", ap: 2, category: "expanded",
                short_desc: "Darkvision radius becomes 120 feet.", long_desc: "Your Darkvision has a radius of 120 feet. (Replaces base Darkvision)."
            },
            {
                id: "dwarf-barren-acclimation", name: "Barren Acclimation", ap: 1, category: "expanded",
                short_desc: "Need half food/water, adv. on Survival to find food/water underground.", long_desc: "You require only half as much food and water per day as normal. You have advantage on Wisdom (Survival) checks made to find food or water in underground environments."
            },
            {
                id: "dwarf-underground-combatant", name: "Underground Combatant", ap: 2, category: "expanded", // Was part of Cave
                short_desc: "Attacks vs you have disadv. when adjacent to 2+ stone walls/structures.", long_desc: "When you are adjacent to a stone wall or structure on two or more sides, attack rolls made against you have disadvantage."
            },
            // Magma Components
            {
                id: "dwarf-lavawalking", name: "Lavawalking", ap: 2, category: "expanded",
                short_desc: "Resistance to fire damage, walk on lava.", long_desc: "You have resistance to fire damage. You can walk across lava or magma as if it were solid ground, taking no damage from the contact (though you may still suffer from extreme heat)."
            },
            {
                id: "dwarf-master-craftsman", name: "Master Craftsman", ap: 2, category: "expanded", // Was part of Magma
                short_desc: "Proficiency with 2 artisan tools, 1/SR or LR adv. on check with one.", long_desc: "You gain proficiency with two types of artisan’s tools of your choice. Once per short or long rest, you may gain advantage on one ability check made using one of these tool proficiencies."
            },
            {
                id: "dwarf-molten-memory", name: "Molten Memory", ap: 1, category: "expanded", // Was part of Magma
                short_desc: "Identify metal type/origin by touch.", long_desc: "You can identify the type of metal and approximate origin (if known) of any forged metal item by touch alone, even if it's broken or partially melted."
            },

            // --- General Expanded Traits ---
            {
                id: "dwarf-thick-skinned", name: "Thick-Skinned (Dwarf)", ap: 1, category: "expanded",
                short_desc: "+1 PD when not wearing Heavy Armor (Requires PD).", long_desc: "Your Physical Defense (PD) increases by 1 while you're not wearing Heavy Armor. (Requires GM definition of PD)."
            },
            {
                id: "dwarf-natural-combatant", name: "Natural Combatant", ap: 1, category: "expanded",
                short_desc: "Proficiency with Heavy Armor and all Shields.", long_desc: "You gain proficiency with Heavy Armor and all Shields."
            },
            {
                id: "dwarf-stone-blood", name: "Stone Blood", ap: 1, category: "expanded",
                short_desc: "Adv. on saves vs Bleeding, spend HD to end Bleeding.", long_desc: "You have advantage on saving throws against effects that cause the Bleeding condition (if used in your game). You may spend 1 Hit Die during a short rest to end the Bleeding condition on yourself without regaining hit points from that die."
            },
            {
                id: "dwarf-minor-tremorsense", name: "Minor Tremorsense", ap: 1, category: "expanded",
                short_desc: "Tremorsense 15ft while on ground vs creatures on ground.", long_desc: "While in contact with the ground, you have Tremorsense out to 15 feet against creatures also in contact with the ground."
            },
            {
                id: "dwarf-stubborn", name: "Stubborn", ap: 2, category: "expanded",
                short_desc: "Adv. on saves vs Taunt or forced movement.", long_desc: "You have advantage on saving throws against being Taunted (if used in your game) or effects that would forcibly move you against your will."
            },
            {
                id: "dwarf-trade-expertise", name: "Trade Expertise (Dwarf)", ap: 1, category: "expanded",
                short_desc: "Choose Crafting/Services Trade; Mastery Cap & Level +1.", long_desc: "Choose a Crafting or Services Trade. Your Mastery Cap and Mastery Level in the chosen Trade both increase by 1. (Requires GM definition of Trades/Mastery)."
            },
            {
                id: "dwarf-earthen-knowledge", name: "Earthen Knowledge", ap: 1, category: "expanded",
                short_desc: "Adv. on Survival/Nature checks underground/mountains.", long_desc: "While underground or in mountainous terrain, you have advantage on Wisdom (Survival) checks to navigate, and Intelligence (Nature) checks related to rocks, crystals, or minerals."
            },
            {
                id: "dwarf-physically-sturdy", name: "Physically Sturdy", ap: 2, category: "expanded",
                short_desc: "Adv. on saves vs Impaired, Deafened, Petrified.", long_desc: "You have advantage on saving throws against being Impaired, Deafened, or Petrified. (Requires GM definition of Impaired)."
            },
            {
                id: "dwarf-encumbered-speed", name: "Encumbered Speed", ap: 0, category: "minor",
                short_desc: "Speed not reduced by Heavy Armor or first level of encumbrance.", long_desc: "Your speed is not reduced by wearing Heavy Armor or by the first level of encumbrance. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)"
            },

            // --- Negative Traits ---
             {
                id: "dwarf-sunlight-sensitivity", name: "Sunlight Sensitivity (Dwarf)", ap: -1, category: "negative",
                short_desc: "Disadv. on attacks/Perception in direct sunlight.", long_desc: "You have disadvantage on attack rolls and on Wisdom (Perception) checks that rely on sight when you, the target of your attack, or whatever you are trying to perceive is in direct sunlight."
            },
            {
                id: "dwarf-charisma-decrease", name: "Charisma Decrease", ap: -1, category: "negative",
                short_desc: "Charisma score decreases by 1 (min 1).", long_desc: "Your Charisma score decreases by 1 (minimum score of 1). (Note: Redundant with base ability score decrease)."
            },
            {
                id: "dwarf-short-legged", name: "Short-Legged", ap: -2, category: "negative",
                short_desc: "Speed decreases by 5 feet.", long_desc: "Your speed decreases by 5 feet." // Note: Base speed is already 25ft
            },
            {
                id: "dwarf-tunnel-vision", name: "Tunnel Vision", ap: -1, category: "negative",
                short_desc: "Disadv. on Perception checks for things behind/above.", long_desc: "You have disadvantage on Wisdom (Perception) checks made to notice things using sight or sound originating from directly behind or above you."
            },
            {
                id: "dwarf-grudgebearer", name: "Grudgebearer", ap: -1, category: "negative",
                short_desc: "Disadv. on Persuasion/Insight vs creature who wronged you.", long_desc: "When a creature significantly wrongs you (attacks you unfairly, breaks a sworn oath, deeply insults your clan - GM discretion), you have disadvantage on Charisma (Persuasion) and Wisdom (Insight) checks involving that creature until you feel the grudge has been addressed or avenged."
            },
            {
                id: "dwarf-ancestral-pressure", name: "Ancestral Pressure", ap: -1, category: "negative",
                short_desc: "Disadv. on saves vs Frightened when isolated.", long_desc: "You have disadvantage on saving throws against the Frightened condition when you are the only conscious ally within 15 feet (i.e., when isolated or your nearby allies are down)."
            }
        ]
    },
    "aerimpi": {
        name: "Aerimpi",
        description: "Aerimpi are a small but agile people who have adapted to life in the skies, living on suspended platforms within the Ravine.",
        base_stats_override: {
            size: "Small",
            speed: 25
        },
        base_ability_scores: {
            description: "+1 Dex, +1 Wis, -1 Str"
        },
        traits: [
            // --- Subrace Default Packages ---
            {
                id: "aerimpi-sky-dancer-package", name: "Default Sky Dancer Package", ap: 5, category: "default_package",
                short_desc: "Acrobatic performers, resistant to wind.",
                long_desc: "Selects the following traits for 5 AP:\n- Dazzling Acrobat (2 AP)\n- Breeze Rider (2 AP)\n- Light on Your Feet (1 AP)",
                is_default_package: true,
                default_package_traits: ["aerimpi-dazzling-acrobat", "aerimpi-breeze-rider", "aerimpi-light-on-your-feet"]
            },
            {
                id: "aerimpi-wind-warden-package", name: "Default Wind Warden Package", ap: 5, category: "default_package",
                short_desc: "Perceptive guardians, steady in high places.",
                long_desc: "Selects the following traits for 5 AP:\n- Guardian of the Winds (2 AP)\n- Wind-Sense (2 AP)\n- Anchor Stance (1 AP)",
                is_default_package: true,
                default_package_traits: ["aerimpi-guardian-of-the-winds", "aerimpi-wind-sense", "aerimpi-anchor-stance"]
            },
            {
                id: "aerimpi-hillhome-package", name: "Default Hillhome Package", ap: 5, category: "default_package",
                short_desc: "Hardy and friendly, resistant to fear/exhaustion.",
                long_desc: "Selects the following traits for 5 AP:\n- Hearthbound Fortitude (2 AP)\n- Well-Fed (2 AP)\n- Friendly Face (1 AP)",
                is_default_package: true,
                default_package_traits: ["aerimpi-hearthbound-fortitude", "aerimpi-well-fed", "aerimpi-friendly-face"]
            },
            {
                id: "aerimpi-glimmergrove-package", name: "Default Glimmergrove Package", ap: 5, category: "default_package",
                short_desc: "Nature-attuned, stealthy watchers.",
                long_desc: "Selects the following traits for 5 AP:\n- Nature’s Friend (2 AP)\n- Blend with the Boughs (2 AP)\n- Watcher on the Wind (1 AP)",
                is_default_package: true,
                default_package_traits: ["aerimpi-natures-friend", "aerimpi-blend-with-the-boughs", "aerimpi-watcher-on-the-wind"]
            },

            // --- Component/Expanded Traits ---
            // Sky Dancer Components
            { id: "aerimpi-dazzling-acrobat", name: "Dazzling Acrobat", ap: 2, category: "expanded", short_desc: "Proficiency in Performance (Dex-based for acrobatics).", long_desc: "You gain proficiency in Performance, and can use Dexterity instead of Charisma when performing aerial or acrobatic displays." },
            { id: "aerimpi-breeze-rider", name: "Breeze Rider", ap: 2, category: "expanded", short_desc: "Adv. on balance checks and vs high wind.", long_desc: "You gain advantage on all checks and saving throws related to balance and resisting high wind effects." },
            { id: "aerimpi-light-on-your-feet", name: "Light on Your Feet", ap: 1, category: "expanded", short_desc: "Move through larger creatures' space (difficult terrain).", long_desc: "You can move through the space of any creature larger than you as if it were difficult terrain." },
            // Wind Warden Components
            { id: "aerimpi-guardian-of-the-winds", name: "Guardian of the Winds", ap: 2, category: "expanded", short_desc: "Proficiency in Perception, adv. vs flying creatures.", long_desc: "You gain proficiency in Perception. You have advantage on attack rolls against creatures that are flying or airborne." },
            { id: "aerimpi-wind-sense", name: "Wind-Sense", ap: 2, category: "expanded", short_desc: "Adv. on initiative, cannot be surprised while flying/suspended.", long_desc: "You have advantage on initiative rolls and cannot be surprised while flying or suspended above the ground." },
            { id: "aerimpi-anchor-stance", name: "Anchor Stance", ap: 1, category: "expanded", short_desc: "Cannot be knocked prone/moved on narrow surfaces.", long_desc: "While standing on rope bridges, platforms, or other narrow surfaces, you cannot be knocked prone or forcibly moved unless you are unconscious." },
            // Hillhome Components
            { id: "aerimpi-hearthbound-fortitude", name: "Hearthbound Fortitude", ap: 2, category: "expanded", short_desc: "Adv. on saves vs Frightened or Exhausted.", long_desc: "You have advantage on saving throws against being Frightened or Exhausted." },
            { id: "aerimpi-well-fed", name: "Well-Fed", ap: 2, category: "expanded", short_desc: "During short rest with own food, reroll one hit die.", long_desc: "During a short rest, if you consume a meal or snack you prepared yourself, you may reroll one of your hit dice and take the higher result." },
            { id: "aerimpi-friendly-face", name: "Friendly Face", ap: 1, category: "expanded", short_desc: "Proficiency in Persuasion, 1/LR add d4 to Persuasion check.", long_desc: "You gain proficiency in Persuasion. Once per long rest, when making a Persuasion check, you can roll a d4 and add it to the result." },
            // Glimmergrove Components
            { id: "aerimpi-natures-friend", name: "Nature’s Friend", ap: 2, category: "expanded", short_desc: "Communicate simple ideas with Beasts, adv. on Animal Handling (small/flying).", long_desc: "You can communicate simple ideas with Beasts and gain advantage on Animal Handling checks with small or flying animals." },
            { id: "aerimpi-blend-with-the-boughs", name: "Blend with the Boughs", ap: 2, category: "expanded", short_desc: "Can Hide when lightly obscured by nature, adv. on outdoor Stealth.", long_desc: "You can attempt to Hide even when only lightly obscured by natural features (leaves, mist, etc.). You also have advantage on Stealth checks made outdoors in natural terrain." },
            { id: "aerimpi-watcher-on-the-wind", name: "Watcher on the Wind", ap: 1, category: "expanded", short_desc: "Proficiency in Perception, cannot be surprised in nature.", long_desc: "You gain proficiency in Perception, and you cannot be surprised while in natural environments." },

            // General Expanded
            { id: "aerimpi-elusive", name: "Elusive", ap: 2, category: "expanded", short_desc: "Disengage Action becomes Full Disengage.", long_desc: "When you take the Disengage Action, you instead gain the benefits of the Full Disengage Action." },
            { id: "aerimpi-halfling-bravery", name: "Halfling Bravery", ap: 2, category: "expanded", short_desc: "Adv. on saves vs Intimidated, Rattled, Frightened.", long_desc: "You have advantage on saving throws against being Intimidated, Rattled, or Frightened." },
            { id: "aerimpi-halfling-endurance", name: "Halfling Endurance", ap: 1, category: "expanded", short_desc: "Adv. on saves vs Exhaustion.", long_desc: "You have advantage on saving throws to resist gaining Exhaustion." },
            { id: "aerimpi-deft-footwork", name: "Deft Footwork", ap: 1, category: "expanded", short_desc: "Move through hostile creature space (1 size larger) as difficult terrain.", long_desc: "You can move through the space of a hostile creature one size larger as if it were difficult terrain." },
            { id: "aerimpi-beast-whisperer", name: "Beast Whisperer", ap: 0, category: "minor", short_desc: "Speak limitedly to Beasts.", long_desc: "You can speak to Beasts in a limited manner. They can understand the meaning of simple words, concepts, or emotions. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)" },
            { id: "aerimpi-beast-insight", name: "Beast Insight", ap: 1, category: "expanded", short_desc: "Understand Beast sounds/body language.", long_desc: "You can understand the meaning of a Beast's sounds and body language. You do not gain the ability to speak with them." },
            { id: "aerimpi-critter-knowledge", name: "Critter Knowledge", ap: 1, category: "expanded", short_desc: "Adv. on checks involving Small or smaller creatures.", long_desc: "You have advantage on Nature, Survival, and Animal Handling checks involving Small or smaller creatures." },
            { id: "aerimpi-burst-of-bravery", name: "Burst of Bravery", ap: 1, category: "expanded", short_desc: "1/combat end Intimidated/Rattled/Frightened for free.", long_desc: "Once per combat, you can end the Intimidated, Rattled, or Frightened condition on yourself for free at any time." },
            { id: "aerimpi-trade-expertise", name: "Trade Expertise (Aerimpi)", ap: 1, category: "expanded", short_desc: "Choose Trade; Mastery Cap & Level +1.", long_desc: "Choose a Trade. Your Mastery Cap and Mastery Level in that Trade both increase by 1." },
            { id: "aerimpi-aerial-adaptation", name: "Aerial Adaptation", ap: 1, category: "expanded", short_desc: "Proficiency with air vehicles, adv. on aerial Acrobatics.", long_desc: "You gain proficiency with air vehicles and have advantage on Acrobatics checks to maintain balance or perform aerial maneuvers." },
            { id: "aerimpi-skyward-leap", name: "Skyward Leap", ap: 2, category: "expanded", short_desc: "1/SR or LR double jump distance, no fall damage from jump.", long_desc: "Once per short or long rest, you can double your jump distance and take no fall damage from that jump." },
            { id: "aerimpi-cloudcraft", name: "Cloudcraft", ap: 2, category: "expanded", short_desc: "Gust cantrip, Levitate (3rd) 1/LR (Int).", long_desc: "You know the Gust cantrip. At 3rd level, you can cast Levitate once per long rest. Intelligence is your spellcasting ability for these spells." },

            // Negative Traits
            { id: "aerimpi-small-sized", name: "Small-Sized", ap: -1, category: "negative", short_desc: "Your size is Small.", long_desc: "Your size is Small. This affects what mounts you can ride and how you interact with size-based mechanics. (Note: This is redundant with base Aerimpi size)." },
            { id: "aerimpi-short-legged", name: "Short-Legged", ap: -2, category: "negative", short_desc: "Movement speed decreases by 5 feet.", long_desc: "Your movement speed decreases by 5 feet." }, // Base speed is already 25ft
            { id: "aerimpi-intellectually-naive", name: "Intellectually Naive", ap: -1, category: "negative", short_desc: "Intelligence score decreases by 1 (min 1).", long_desc: "You decrease your Intelligence score by 1 (minimum score of 1)." },
            { id: "aerimpi-skybound-fear", name: "Skybound Fear", ap: -1, category: "negative", short_desc: "Disadv. on saves vs fear when on solid ground.", long_desc: "You have disadvantage on saving throws against fear effects when standing on solid ground." },
            { id: "aerimpi-fragile-frame", name: "Fragile Frame", ap: -2, category: "negative", short_desc: "Take 1 extra damage die per 10ft fallen.", long_desc: "When you take falling damage, you take 1 additional damage die per 10 feet fallen." }
        ]
    },
    "dragonborn": {
        name: "Dragonborn",
        description: "Dragonborn draw on the power of dragon gods or dragons, reflected in their scales and breath weapon.",
        base_stats_override: {}, // Medium, 30ft Speed, Humanoid
        base_ability_scores: {
            description: "+1 Str, +1 Cha, -1 Con"
        },
        traits: [
            // Core Choice Placeholder
            {
                id: "dragonborn-ancestry-choice-note", name: "Draconic Ancestry Choice", ap: 0, category: "core_choice",
                short_desc: "REQUIRED: Choose Dragon Type (affects other traits).",
                long_desc: "You MUST choose one Dragon Type (e.g., Red, Silver, Copper, etc.) when creating your character. This choice determines the damage type/shape for your Draconic Resistance and Breath Weapon traits, and your Draconic Heritage. Make the choice below on the relevant traits."
            },
            // Default Package Meta-Trait
            {
                id: "dragonborn-default-package", name: "Default Dragonborn Package", ap: 5, category: "default_package",
                short_desc: "Standard Dragonborn with resistance, breath, armor, and heritage.",
                long_desc: "Selects the following traits for 5 AP (Requires Draconic Ancestry Choice):\n- Draconic Resistance (2 AP - Requires Choice)\n- Breath Weapon (2 AP - Requires Choice)\n- Natural Armor (1 AP)\n- Draconic Heritage (0 AP - Minor - Requires Choice)",
                is_default_package: true,
                default_package_traits: ["dragonborn-draconic-resistance", "dragonborn-breath-weapon", "dragonborn-natural-armor", "dragonborn-draconic-heritage"]
            },
            // Default Components with Suboptions
            {
                id: "dragonborn-draconic-resistance", name: "Draconic Resistance", ap: 2, category: "default_component",
                short_desc: "Resistance to damage type of chosen Draconic Ancestry.",
                long_desc: "You gain resistance to the damage type associated with your chosen Draconic Ancestry. Choose the type below.",
                suboptions: [ // Simplified list, add all from table if needed
                    { id: "acid", name: "Acid (Black/Copper)", description: "Resistance to Acid damage." },
                    { id: "cold", name: "Cold (Silver/White)", description: "Resistance to Cold damage." },
                    { id: "fire", name: "Fire (Brass/Gold/Red)", description: "Resistance to Fire damage." },
                    { id: "force", name: "Force (Titanium)", description: "Resistance to Force damage." },
                    { id: "lightning", name: "Lightning (Blue/Bronze)", description: "Resistance to Lightning damage." },
                    { id: "necrotic", name: "Necrotic (Lead)", description: "Resistance to Necrotic damage." },
                    { id: "poison", name: "Poison (Green/Steel)", description: "Resistance to Poison damage." },
                    { id: "psychic", name: "Psychic (Mercury/Tin)", description: "Resistance to Psychic damage." },
                    { id: "radiant", name: "Radiant (Platinum/Zinc)", description: "Resistance to Radiant damage." },
                    { id: "slashing", name: "Slashing (Iron)", description: "Resistance to Slashing damage." }
                    // Thunder is missing from table, add if applicable
                ]
            },
            {
                id: "dragonborn-breath-weapon", name: "Breath Weapon", ap: 2, category: "default_component",
                short_desc: "Action exhale energy (damage/shape by Ancestry). Uses = Prof Bonus/LR.",
                long_desc: "You can use your action to exhale destructive energy. Your chosen Draconic Ancestry determines the damage type and shape (Line or Cone). Creatures in the area make a saving throw (DC 8 + Con mod + Prof Bonus; Dex for Line, Con/Dex for Cone). Damage: 1d10 (1st), 2d10 (5th), 3d10 (11th), 4d10 (17th) on failed save, half on success. Uses equal Proficiency Bonus per long rest. Choose the type below (should match Resistance).",
                 suboptions: [ // Must match Resistance options
                    { id: "acid", name: "Acid (Line - Black/Copper)", description: "Exhale Acid in a 5x30 ft line (Dex save)." },
                    { id: "cold", name: "Cold (Cone - Silver/White)", description: "Exhale Cold in a 15 ft cone (Con save)." },
                    { id: "fire", name: "Fire (Cone - Brass/Gold/Red)", description: "Exhale Fire in a 15 ft cone (Dex save)." },
                    { id: "force", name: "Force (Line - Titanium)", description: "Exhale Force in a 5x30 ft line (Dex save)." },
                    { id: "lightning", name: "Lightning (Line - Blue/Bronze)", description: "Exhale Lightning in a 5x30 ft line (Dex save)." },
                    { id: "necrotic", name: "Necrotic (Cone - Lead)", description: "Exhale Necrotic energy in a 15 ft cone (Con save)." },
                    { id: "poison", name: "Poison (Cone/Line - Green/Steel)", description: "Exhale Poison in a 15 ft cone (Green, Con save) or 5x30 ft line (Steel, Con save)." }, // Combined for simplicity
                    { id: "psychic", name: "Psychic (Cone - Mercury/Tin)", description: "Exhale Psychic energy in a 15 ft cone (Wis save - typical for psychic)." },
                    { id: "radiant", name: "Radiant (Cone - Platinum/Zinc)", description: "Exhale Radiant energy in a 15 ft cone (Con save)." },
                    { id: "slashing", name: "Slashing (Line - Iron)", description: "Exhale Slashing force in a 5x30 ft line (Dex save)." }
                ]
            },
            {
                id: "dragonborn-natural-armor", name: "Natural Armor", ap: 1, category: "default_component",
                short_desc: "AC is 13 + Dex mod when unarmored (can use shield).",
                long_desc: "You have tough, scaly skin. When you aren't wearing armor, your AC is 13 + your Dexterity modifier. You can use a shield and still gain this benefit."
            },
            {
                id: "dragonborn-draconic-heritage", name: "Draconic Heritage", ap: 0, category: "minor",
                short_desc: "Appearance reflects chosen dragon type (Chromatic/Metallic/Other).",
                long_desc: "Your appearance reflects your chosen dragon type (e.g., scale color, horn shape). Choose your primary heritage type below (should align with your Ancestry choice). This choice is primarily for flavor but may interact with specific Expanded Traits or GM rulings. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)",
                 suboptions: [
                    { id: "chromatic", name: "Chromatic", description: "Heritage traces to a Chromatic Dragon (Black, Blue, Green, Red, White)." },
                    { id: "metallic", name: "Metallic", description: "Heritage traces to a Metallic Dragon (Brass, Bronze, Copper, Gold, Silver, Platinum, etc.)." },
                    { id: "other", name: "Other", description: "Heritage traces to a less common dragon type (Gem, Planar, etc. - GM discretion)." }
                ]
            },
            // Expanded Traits
            {
                id: "dragonborn-thick-skinned", name: "Thick-Skinned", ap: 2, category: "expanded",
                short_desc: "+1 AC when unarmored (stacks with Natural Armor).",
                long_desc: "When you aren't wearing armor, you gain a +1 bonus to your AC. (Note: This stacks with Natural Armor if taken)."
            },
            {
                id: "dragonborn-second-breath", name: "Second Breath", ap: 1, category: "expanded",
                short_desc: "Regain one use of Breath Weapon on short rest.",
                long_desc: "You regain one expended use of your Breath Weapon whenever you finish a short rest."
            },
            {
                id: "dragonborn-concussive-breath", name: "Concussive Breath", ap: 1, category: "expanded",
                short_desc: "Creatures failing save vs Breath Weapon pushed 10ft.",
                long_desc: "Creatures that fail their saving throw against your Breath Weapon are also pushed 10 feet away from you (if Cone) or pushed 10 feet back along the line (if Line)."
            },
            {
                id: "dragonborn-draconic-affinity", name: "Draconic Affinity", ap: 2, category: "expanded",
                short_desc: "Take damage of Ancestry type -> next Breath Weapon deals +1d10.",
                long_desc: "When you take damage of the type associated with your Draconic Ancestry, your next use of your Breath Weapon before the end of your next turn deals an additional 1d10 damage."
            },
            {
                id: "dragonborn-dying-breath", name: "Dying Breath", ap: 1, category: "expanded",
                short_desc: "Reaction when reduced to 0 HP: use Breath Weapon.",
                long_desc: "When you are reduced to 0 hit points but not killed outright, you can use your reaction to immediately use your Breath Weapon."
            },
            {
                id: "dragonborn-draconic-ward", name: "Draconic Ward", ap: 1, category: "expanded",
                short_desc: "When stabilized at 0 HP, regain HP = prof bonus (1/SR).",
                long_desc: "When you are stabilized while at 0 hit points, you regain hit points equal to your proficiency bonus. This can occur once per short rest."
            },
            {
                id: "dragonborn-draconic-protection", name: "Draconic Protection", ap: 1, category: "expanded",
                short_desc: "Ally reduced to 0 HP gains PD/MD bonus = prof bonus.",
                long_desc: "When an ally you can see within 100 feet is reduced to 0 hit points, they gain a bonus to their Physical Defense (PD) and Mental Defense (MD) equal to your proficiency bonus until the end of the current combat or until they regain hit points. (Requires GM definition of PD/MD)."
            },
            {
                id: "dragonborn-draconic-flight", name: "Draconic Flight", ap: 2, category: "expanded",
                short_desc: "Manifest energy wings (bonus action), Fly Speed = walking speed (no heavy armor).",
                long_desc: "You manifest wings of draconic energy. You gain a Fly Speed equal to your walking speed. You cannot use this flying speed if you are wearing heavy armor. You can manifest or dismiss these wings as a bonus action."
            },
            // Negative Traits
            {
                id: "dragonborn-guardians-bond", name: "Guardian's Bond", ap: -1, category: "negative",
                short_desc: "1/SR: If reduced to 0 HP, auto-fail first death save.",
                long_desc: "Once per short rest, if you are reduced to 0 hit points and are making death saving throws, you automatically fail the first death saving throw you make during that stabilization period."
            }
        ]
    },
    "gnome": {
        name: "Gnome",
        description: "Gnomes are clever, curious, and crafty folk whose size belies the depth of their ingenuity.",
        base_stats_override: {
            size: "Small",
            speed: 25
        },
        base_ability_scores: {
            description: "+1 Dex, +1 Int, -1 Con"
        },
        traits: [
            // Base Minor Trait
            {
                id: "gnome-gnome-cunning", name: "Gnome Cunning", ap: 0, category: "minor",
                short_desc: "Adv. on Int, Wis, Cha saves vs magic.",
                long_desc: "You have advantage on all Intelligence, Wisdom, and Charisma saving throws against magic. (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source)"
            },
            // --- Subrace Default Packages ---
            {
                id: "gnome-forest-package", name: "Default Forest Gnome Package", ap: 5, category: "default_package",
                short_desc: "Nature whisperer and illusionist. Includes Gnome Cunning.",
                long_desc: "Selects the following traits for 5 AP:\n- Gnome Cunning (0 AP - Minor)\n- Nature Whisperer (2 AP)\n- Speak with Small Beasts (1 AP)\n- Natural Illusionist (1 AP)\n- Woodcarver's Skill (1 AP)",
                is_default_package: true,
                default_package_traits: ["gnome-gnome-cunning", "gnome-nature-whisperer", "gnome-speak-with-small-beasts", "gnome-natural-illusionist", "gnome-woodcarvers-skill"]
            },
            {
                id: "gnome-rock-package", name: "Default Rock Gnome Package", ap: 5, category: "default_package",
                short_desc: "Artificer and tinker. Includes Gnome Cunning.",
                long_desc: "Selects the following traits for 5 AP:\n- Gnome Cunning (0 AP - Minor)\n- Artificer's Lore (1 AP)\n- Tinker (1 AP - Requires Choice)\n- Skilled Merchant (2 AP)\n- Mason’s Aptitude (1 AP)",
                is_default_package: true,
                default_package_traits: ["gnome-gnome-cunning", "gnome-artificers-lore", "gnome-tinker", "gnome-skilled-merchant", "gnome-masons-aptitude"]
            },
            {
                id: "gnome-deep-package", name: "Default Deep Gnome Package", ap: 4, category: "default_package", // 4 AP after negative
                short_desc: "Stealthy underdark dweller. Includes Gnome Cunning & Sunlight Sensitivity.",
                long_desc: "Selects the following traits for 4 AP (needs +1 AP from another source):\n- Gnome Cunning (0 AP - Minor)\n- Superior Darkvision (Gnome) (2 AP)\n- Stone Camouflage (1 AP)\n- Svirfneblin Magic (1 AP)\n- Stone Sense (1 AP)\n- Sunlight Sensitivity (Gnome) (-1 AP)",
                is_default_package: true,
                default_package_traits: ["gnome-gnome-cunning", "gnome-superior-darkvision", "gnome-stone-camouflage", "gnome-svirfneblin-magic", "gnome-stone-sense", "gnome-sunlight-sensitivity"]
            },
            {
                id: "gnome-desert-package", name: "Default Desert Gnome Package", ap: 5, category: "default_package",
                short_desc: "Heat resistant sand shaper. Includes Gnome Cunning.",
                long_desc: "Selects the following traits for 5 AP:\n- Gnome Cunning (0 AP - Minor)\n- No Stranger to the Sun (2 AP)\n- Flame-Hardened Skin (2 AP)\n- Sand Shaper (1 AP)",
                is_default_package: true,
                default_package_traits: ["gnome-gnome-cunning", "gnome-no-stranger-to-the-sun", "gnome-flame-hardened-skin", "gnome-sand-shaper"]
            },
            {
                id: "gnome-arctic-package", name: "Default Arctic Gnome Package", ap: 4, category: "default_package", // 4 AP after negative
                short_desc: "Cold resistant snow burrower. Includes Gnome Cunning & Sunlight Sensitivity.",
                long_desc: "Selects the following traits for 4 AP (needs +1 AP from another source):\n- Gnome Cunning (0 AP - Minor)\n- Snow Born (2 AP)\n- Snow Burrow (2 AP)\n- Ice Magic (1 AP)\n- Sunlight Sensitivity (Gnome) (-1 AP)",
                is_default_package: true,
                default_package_traits: ["gnome-gnome-cunning", "gnome-snow-born", "gnome-snow-burrow", "gnome-ice-magic", "gnome-sunlight-sensitivity"]
            },
            {
                id: "gnome-crystal-package", name: "Default Crystal Gnome Package", ap: 5, category: "default_package",
                short_desc: "Truesight and light magic. Includes Gnome Cunning.",
                long_desc: "Selects the following traits for 5 AP:\n- Gnome Cunning (0 AP - Minor)\n- Crystal Clear Vision (2 AP)\n- Resonance Crystal (2 AP)\n- Light Weaver (1 AP)",
                is_default_package: true,
                default_package_traits: ["gnome-gnome-cunning", "gnome-crystal-clear-vision", "gnome-resonance-crystal", "gnome-light-weaver"]
            },

            // --- Component/Expanded Traits ---
            // Forest Gnome Components
            { id: "gnome-nature-whisperer", name: "Nature Whisperer", ap: 2, category: "expanded", short_desc: "Adv. on Animal Handling/Nature checks (plants/animals).", long_desc: "You have advantage on Wisdom (Animal Handling) and Intelligence (Nature) checks related to identifying plants and animals or diagnosing natural afflictions/diseases." },
            { id: "gnome-speak-with-small-beasts", name: "Speak with Small Beasts", ap: 1, category: "expanded", short_desc: "Communicate simple ideas with Small or smaller beasts.", long_desc: "Through sounds and gestures, you can communicate simple ideas with Small or smaller beasts." },
            { id: "gnome-natural-illusionist", name: "Natural Illusionist", ap: 1, category: "expanded", short_desc: "Know Minor Illusion cantrip (Int).", long_desc: "You know the Minor Illusion cantrip. Intelligence is your spellcasting ability for it." },
            { id: "gnome-woodcarvers-skill", name: "Woodcarver's Skill", ap: 1, category: "expanded", short_desc: "Proficiency with woodcarver's tools.", long_desc: "You gain proficiency with woodcarver's tools." },
            // Rock Gnome Components
            { id: "gnome-artificers-lore", name: "Artificer's Lore", ap: 1, category: "expanded", short_desc: "Double proficiency on History checks for magic/alchemical/tech items.", long_desc: "Whenever you make an Intelligence (History) check related to magic items, alchemical objects, or technological devices, you can add twice your proficiency bonus, instead of any proficiency bonus you normally apply." },
            {
                id: "gnome-tinker", name: "Tinker", ap: 1, category: "expanded",
                short_desc: "Proficiency with tinker's tools, create small clockwork devices.",
                long_desc: "You have proficiency with artisan's tools (tinker's tools). Using those tools, you can spend 1 hour and 10 gp worth of materials to construct a Tiny clockwork device (AC 5, 1 HP). The device ceases to function after 24 hours (unless repaired), or when dismantled. You can have up to three active. Choose the type of device you can make:",
                suboptions: [
                    { id: "toy", name: "Clockwork Toy", description: "A toy animal, monster, or person that moves 5 feet across the ground on each of your turns in a random direction." },
                    { id: "lighter", name: "Fire Starter", description: "Produces a miniature flame, which you can use to light a candle, torch, or campfire. Using the device requires your action." },
                    { id: "musicbox", name: "Music Box", description: "Plays a single song at a moderate volume when opened." }
                ]
            },
            { id: "gnome-skilled-merchant", name: "Skilled Merchant", ap: 2, category: "expanded", short_desc: "Use Int/Wis/Cha and double prof bonus for checks when selling own goods.", long_desc: "When selling goods or services you personally created or significantly improved, you can use your Intelligence, Wisdom, or Charisma modifier (your choice) for any Charisma (Persuasion), Charisma (Deception), or Charisma (Performance) check made during the transaction, and you add double your proficiency bonus to the check." },
            { id: "gnome-masons-aptitude", name: "Mason’s Aptitude", ap: 1, category: "expanded", short_desc: "Proficiency with mason's tools.", long_desc: "You gain proficiency with mason's tools." },
            // Deep Gnome Components
            { id: "gnome-superior-darkvision", name: "Superior Darkvision (Gnome)", ap: 2, category: "expanded", short_desc: "Darkvision radius becomes 120 feet.", long_desc: "Your Darkvision has a radius of 120 feet." },
            { id: "gnome-stone-camouflage", name: "Stone Camouflage", ap: 1, category: "expanded", short_desc: "Adv. on Stealth checks to hide in rocky terrain.", long_desc: "You have advantage on Dexterity (Stealth) checks made to hide in rocky terrain." },
            { id: "gnome-svirfneblin-magic", name: "Svirfneblin Magic", ap: 1, category: "expanded", short_desc: "Message cantrip, Disguise Self (3rd), Nondetection (5th) 1/LR (Int).", long_desc: "You know the Message cantrip. At 3rd level, you can cast Disguise Self once per long rest. At 5th level, you can cast Nondetection (self only) once per long rest. Intelligence is your spellcasting ability." },
            { id: "gnome-stone-sense", name: "Stone Sense", ap: 1, category: "expanded", short_desc: "Adv. on checks to notice unusual stonework/passages/instability.", long_desc: "You have advantage on Intelligence (Investigation) or Wisdom (Perception) checks to notice unusual stonework, hidden passages in stone, or instability in stone structures." },
            // Desert Gnome Components
            { id: "gnome-no-stranger-to-the-sun", name: "No Stranger to the Sun", ap: 2, category: "expanded", short_desc: "Resistance to fire damage, adapted to hot climates.", long_desc: "You have resistance to fire damage. You are naturally adapted to hot climates, as described in chapter 5 of the Dungeon Master's Guide." },
            { id: "gnome-flame-hardened-skin", name: "Flame-Hardened Skin", ap: 2, category: "expanded", short_desc: "Take fire damage -> gain AC bonus = prof bonus until start of next turn (1/round).", long_desc: "When you take fire damage, your skin temporarily hardens. You gain a bonus to your AC equal to your proficiency bonus until the start of your next turn. This effect can only occur once per round." },
            { id: "gnome-sand-shaper", name: "Sand Shaper", ap: 1, category: "expanded", short_desc: "Mold Earth cantrip, Earth Tremor (3rd), Wall of Sand (5th) 1/LR (Int).", long_desc: "You know the Mold Earth cantrip. At 3rd level, you can cast Earth Tremor once per long rest. At 5th level, you can cast Wall of Sand once per long rest. Intelligence is your spellcasting ability." },
            // Arctic Gnome Components
            { id: "gnome-snow-born", name: "Snow Born", ap: 2, category: "expanded", short_desc: "Resistance to cold damage, adapted to cold climates.", long_desc: "You have resistance to cold damage. You are naturally adapted to cold climates, as described in chapter 5 of the Dungeon Master's Guide." },
            { id: "gnome-snow-burrow", name: "Snow Burrow", ap: 2, category: "expanded", short_desc: "Bonus action burrow (15ft speed) in deep snow, gain total cover.", long_desc: "While in snow at least 1 foot deep, you can use a bonus action to burrow into it. You gain a burrowing speed of 15 feet through snow. While burrowed, you have total cover. You can emerge as a bonus action." },
            { id: "gnome-ice-magic", name: "Ice Magic", ap: 1, category: "expanded", short_desc: "Shape Water (ice/snow only) cantrip, Armor of Agathys (3rd), Sleet Storm (5th) 1/LR (Int).", long_desc: "You know the Shape Water cantrip (can only affect ice or snow). At 3rd level, you can cast Armor of Agathys (cast at 1st level) once per long rest. At 5th level, you can cast Sleet Storm once per long rest. Intelligence is your spellcasting ability." },
            // Crystal Gnome Components
            { id: "gnome-crystal-clear-vision", name: "Crystal Clear Vision", ap: 2, category: "expanded", short_desc: "Truesight 5ft, adv. vs Blinded & seeing through illusions/shapechanging (30ft).", long_desc: "You have Truesight out to 5 feet. You have advantage on saving throws against being Blinded and on checks made to see through illusions or shapechanging effects within 30 feet." },
            { id: "gnome-resonance-crystal", name: "Resonance Crystal", ap: 2, category: "expanded", short_desc: "Personal crystal focus grants minor benefit/active ability (Prof Bonus/LR).", long_desc: "You possess a personal crystal that acts as a spellcasting focus for you. Based on its gem type (GM discretion, e.g., Amethyst for psychic resistance, Emerald for healing boost, Ruby for fire evocation), it grants a minor passive benefit or an active ability usable a number of times equal to your proficiency bonus per long rest." },
            { id: "gnome-light-weaver", name: "Light Weaver", ap: 1, category: "expanded", short_desc: "Light cantrip (control radius), Color Spray (3rd), Daylight (5th) 1/LR (Int).", long_desc: "You know the Light cantrip, and can mentally control its radius (up to the normal maximum) as a bonus action. At 3rd level, you can cast Color Spray once per long rest. At 5th level, you can cast Daylight once per long rest. Intelligence is your spellcasting ability." },

            // General Expanded
            { id: "gnome-escape-artist", name: "Escape Artist", ap: 2, category: "expanded", short_desc: "Adv. on checks/saves vs Grappled or Restrained.", long_desc: "You have advantage on ability checks and saving throws made to avoid or escape being Grappled or Restrained." },
            { id: "gnome-magnified-vision", name: "Magnified Vision", ap: 1, category: "expanded", short_desc: "Adv. on Investigation checks to examine things within 5ft.", long_desc: "You have advantage on Intelligence (Investigation) checks made to examine something you are holding or that is within 5 feet of you." },
            { id: "gnome-mental-clarity", name: "Mental Clarity", ap: 2, category: "expanded", short_desc: "Adv. on saves vs Dazed or Stunned.", long_desc: "You have advantage on saving throws against being Dazed or Stunned (if these conditions exist in your game)." },
            { id: "gnome-strong-minded", name: "Strong-Minded", ap: 1, category: "expanded", short_desc: "+1 Mental Defense (MD) (Requires MD).", long_desc: "Your Mental Defense (MD) increases by 1. (Requires GM definition of MD)." },
            { id: "gnome-predict-weather", name: "Predict Weather", ap: 0, category: "minor", short_desc: "Accurately predict weather for next hour (1 mile).", long_desc: "You can accurately predict the natural weather conditions for the next hour within a 1-mile radius. You are never caught off guard by mundane weather changes and don't suffer disadvantage on checks due to normal weather (like rain or wind). (Counts as one of your Minor Traits - all Minor Traits must be from the same ancestry source, replaces Gnome Cunning)." },
            { id: "gnome-mana-increase", name: "Mana Increase", ap: 1, category: "expanded", short_desc: "Max Mana Points (MP) + Prof Bonus (Requires MP).", long_desc: "Your maximum Mana Points (MP) increase by an amount equal to your proficiency bonus. (Requires GM definition of MP)." },
            { id: "gnome-trapper", name: "Trapper", ap: 1, category: "expanded", short_desc: "Proficiency with thieves' tools, adv. detecting/disarming traps.", long_desc: "You gain proficiency with thieves' tools. You have advantage on Wisdom (Perception) or Intelligence (Investigation) checks made to detect traps, and on Dexterity checks made using thieves' tools to disarm traps or set simple traps (like tripwires or snares)." },
            { id: "gnome-lightning-insulation", name: "Lightning Insulation", ap: 2, category: "expanded", short_desc: "Resistance to lightning damage, natural lightning misses you.", long_desc: "You have resistance to lightning damage. Natural lightning strikes targeting an area you are in automatically miss you." },
            { id: "gnome-trade-expertise", name: "Trade Expertise (Gnome)", ap: 1, category: "expanded", short_desc: "Choose Crafting/Subterfuge Trade; Mastery Cap & Level +1.", long_desc: "Choose a Crafting or Subterfuge trade. Your Mastery Cap and Mastery Level both increase by 1. (Requires GM definition of Trades/Mastery)." },
            { id: "gnome-storm-knowledge", name: "Storm Knowledge", ap: 1, category: "expanded", short_desc: "Adv. on Survival checks during storms, Nature checks on weather.", long_desc: "You have advantage on Wisdom (Survival) checks made during storms (rain, snow, wind) and on Intelligence (Nature) checks related to weather phenomena." },

            // Negative Traits
            { id: "gnome-sunlight-sensitivity", name: "Sunlight Sensitivity (Gnome)", ap: -1, category: "negative", short_desc: "Disadv. on attacks/Perception in direct sunlight.", long_desc: "You have disadvantage on attack rolls and on Wisdom (Perception) checks that rely on sight when you, the target of your attack, or whatever you are trying to perceive is in direct sunlight." },
            { id: "gnome-small-sized", name: "Small-Sized", ap: -1, category: "negative", short_desc: "Your size is Small.", long_desc: "Your size is Small. (Note: Redundant with base Gnome size)." },
            { id: "gnome-short-legged", name: "Short-Legged", ap: -2, category: "negative", short_desc: "Speed reduced by 5 feet.", long_desc: "Your speed is reduced by 5 feet." }, // Base speed is already 25ft
            { id: "gnome-agility-decrease", name: "Agility Decrease", ap: -1, category: "negative", short_desc: "Dexterity score decreased by 1 (min 1).", long_desc: "Your Dexterity score is decreased by 1 (minimum score of 1)." },
            {
                id: "gnome-elemental-vulnerability", name: "Elemental Vulnerability", ap: -1, category: "negative",
                short_desc: "Choose Fire, Cold, or Lightning; gain vulnerability.",
                long_desc: "Choose one damage type below. You have vulnerability to damage of that type.",
                suboptions: [
                    { id: "fire", name: "Fire Vulnerability", description: "You have vulnerability to Fire damage." },
                    { id: "cold", name: "Cold Vulnerability", description: "You have vulnerability to Cold damage." },
                    { id: "lightning", name: "Lightning Vulnerability", description: "You have vulnerability to Lightning damage." }
                ]
            },
            { id: "gnome-oblivious", name: "Oblivious", ap: -1, category: "negative", short_desc: "Disadv. on Perception checks for hidden things not in line of sight.", long_desc: "You have disadvantage on Wisdom (Perception) checks made to detect hidden creatures or objects that are not directly in your line of sight." }
        ]
    },
    "goliath": {
        name: "Goliath",
        description: "Goliaths hail from mountain peaks, descended from giants, possessing great might and endurance.",
        base_stats_override: {}, // Medium, 30ft Speed, Humanoid
        base_ability_scores: {
            description: "+1 Str, +1 Con, -1 Int"
        },
        traits: [
            // Base Goliath Traits (Core Components - Total 2 AP)
            {
                id: "goliath-powerful-build", name: "Powerful Build", ap: 1, category: "default_component",
                short_desc: "Count as size larger for carry/push/drag/lift, adv. escaping grapples.",
                long_desc: "You count as one Size larger when determining your carrying capacity and the weight you can push, drag, or lift. You have advantage on Strength (Athletics) checks made to escape a grapple."
            },
            {
                id: "goliath-mountain-born", name: "Mountain Born", ap: 1, category: "default_component",
                short_desc: "Acclimated to high altitude and cold climates.",
                long_desc: "You’re acclimated to high altitude, including elevations above 20,000 feet. You’re also naturally adapted to cold climates, as described in chapter 5 of the Dungeon Master’s Guide."
            },

            // Giant Ancestry Choices (Core Choice - Choose ONE for 3 AP)
            {
                id: "goliath-giant-ancestry-note", name: "Giant Ancestry Choice", ap: 0, category: "core_choice", // Special category
                short_desc: "REQUIRED: Choose ONE Giant Ancestry trait (3 AP).",
                long_desc: "You MUST choose ONE of the following Giant Ancestry traits, each costing 3 AP. This choice reflects your giant bloodline and grants specific abilities and resistances. Combine with the two Base Goliath Traits (Powerful Build, Mountain Born) for a total of 5 AP."
            },
            {
                id: "goliath-clouds-jaunt", name: "Cloud’s Jaunt (Giant Ancestry)", ap: 3, category: "expanded", // Categorized as expanded so it's selectable
                short_desc: "Bonus action teleport 30ft (Prof Bonus/LR), Force resistance.",
                long_desc: "As a bonus action, you can magically teleport up to 30 feet to an unoccupied space you can see. You can use this ability a number of times equal to your proficiency bonus per long rest. You also gain resistance to Force damage."
            },
            {
                id: "goliath-fires-burn", name: "Fire’s Burn (Giant Ancestry)", ap: 3, category: "expanded",
                short_desc: "Add 1d10 fire damage to Str attack (Prof Bonus/LR), Fire resistance.",
                long_desc: "When you hit a target with an attack roll using Strength, you can cause the attack to deal an additional 1d10 fire damage to the target. You can use this ability a number of times equal to your proficiency bonus per long rest. You gain resistance to Fire damage."
            },
            {
                id: "goliath-frosts-chill", name: "Frost’s Chill (Giant Ancestry)", ap: 3, category: "expanded",
                short_desc: "Add 1d6 cold damage & slow target on Str attack (Prof Bonus/LR), Cold resistance.",
                long_desc: "When you hit a target with an attack roll using Strength, you can cause the attack to deal an additional 1d6 cold damage and reduce the target's speed by 10 feet until the start of your next turn. You can use this ability a number of times equal to your proficiency bonus per long rest. You have resistance to Cold damage."
            },
            {
                id: "goliath-hills-tumble", name: "Hill’s Tumble (Giant Ancestry)", ap: 3, category: "expanded",
                short_desc: "Force Str save vs prone on Str attack (Prof Bonus/LR), nonmagical Bludgeoning resistance.",
                long_desc: "When you hit a Large or smaller creature with an attack roll using Strength, you can force it to make a Strength saving throw (DC = 8 + your proficiency bonus + your Strength modifier). On a failed save, the creature falls prone. You can use this ability a number of times equal to your proficiency bonus per long rest. You have resistance to Bludgeoning damage from nonmagical attacks."
            },
            {
                id: "goliath-stones-endurance", name: "Stone’s Endurance (Giant Ancestry)", ap: 3, category: "expanded",
                short_desc: "Reaction reduce damage by 1d12 + Con mod (Prof Bonus/LR), adv. vs exhaustion.",
                long_desc: "When you take damage, you can use your reaction to roll a d12. Add your Constitution modifier to the number rolled, and reduce the damage by that total. You can use this ability a number of times equal to your proficiency bonus per long rest. You have advantage on saving throws against exhaustion."
            },
            {
                id: "goliath-storms-thunder", name: "Storm’s Thunder (Giant Ancestry)", ap: 3, category: "expanded",
                short_desc: "Reaction when damaged: force attacker Con save or take 1d8 thunder (Prof Bonus/LR), Thunder resistance.",
                long_desc: "When a creature within 60 feet that you can see deals damage to you, you can use your reaction to force that creature to make a Constitution saving throw (DC = 8 + your proficiency bonus + your Constitution modifier). On a failed save, the creature takes 1d8 thunder damage. You can use this ability a number of times equal to your proficiency bonus per long rest. You have resistance to Thunder damage."
            },

            // Expanded Traits
            {
                id: "goliath-giants-fortitude", name: "Giant’s Fortitude", ap: 2, category: "expanded",
                short_desc: "Prereq: Stone's Endurance. Use reaction even if damage isn't reduced, regain uses on SR.",
                long_desc: "Prerequisite: Stone's Endurance trait. You can use your Stone's Endurance reaction even if the damage would not be reduced (e.g., if the damage is very high). Additionally, you regain all expended uses when you finish a short or long rest."
            },
            {
                id: "goliath-strong-body", name: "Strong Body", ap: 2, category: "expanded",
                short_desc: "1/combat reaction: reduce PD damage by Str/Dex mod (Requires PD).",
                long_desc: "Once per combat, when you take damage that targets your Physical Defense (PD), you can use your reaction to reduce the damage taken by an amount equal to your Strength or Dexterity modifier (your choice, minimum of 1). (Requires GM definition of PD)."
            },
            {
                id: "goliath-mighty-leap", name: "Mighty Leap", ap: 1, category: "expanded",
                short_desc: "Use Str for jump distance, Str for fall damage reduction.",
                long_desc: "When you make a long jump or high jump, you can use your Strength score instead of your Dexterity score to calculate the distance. When you fall, you can use your Strength score instead of Dexterity to calculate fall damage reduction if using optional falling rules."
            },
            {
                id: "goliath-brute", name: "Brute", ap: 1, category: "expanded",
                short_desc: "Bonus action Shove or Grapple (Prof Bonus/SR).",
                long_desc: "A number of times per short rest equal to your proficiency bonus, you can take the Shove or Grapple action as a bonus action."
            },
            {
                id: "goliath-titanic-toss", name: "Titanic Toss", ap: 1, category: "expanded",
                short_desc: "Adv. on Athletics to throw creature, no disadv. at long range with thrown weapons.",
                long_desc: "You have advantage on Strength (Athletics) checks made to throw another creature. When making a ranged attack with a thrown weapon, you don't suffer disadvantage due to attacking at long range."
            },
            {
                id: "goliath-unstoppable", name: "Unstoppable", ap: 1, category: "expanded",
                short_desc: "Adv. on saves vs Slowed or Stunned.",
                long_desc: "You have advantage on saving throws against being Slowed or Stunned (if Stunned condition exists)."
            },
            // Negative Traits
            {
                id: "goliath-clumsiness", name: "Clumsiness", ap: -2, category: "negative",
                short_desc: "Disadv. on all Acrobatics and Stealth checks.",
                long_desc: "You have disadvantage on all Dexterity (Acrobatics) and Dexterity (Stealth) checks."
            },
            {
                id: "goliath-heavy-riser", name: "Heavy Riser", ap: -1, category: "negative",
                short_desc: "Standing from prone costs 20ft movement.",
                long_desc: "Standing up from prone costs you 20 feet of movement instead of half your speed."
            }
        ]
    },
    "kobold": {
        name: "Kobold",
        description: "Small, reptilian humanoids known for their cunning, pack tactics, and draconic heritage.",
        base_stats_override: {
            size: "Small",
            speed: 30 // Note: Small but keeps 30ft speed
        },
        base_ability_scores: {
            description: "+1 Dex, +1 Int, -1 Str"
        },
        traits: [
            // Base Trait
            {
                id: "kobold-darkvision", name: "Darkvision", ap: 1, category: "default_component",
                short_desc: "See 60ft in dim/darkness.", long_desc: "You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if it were dim light."
            },
            // Default Package Meta-Trait (4 AP + Negative Trait)
            {
                id: "kobold-default-package", name: "Default Kobold Package", ap: 4, category: "default_package", // 1+2+1+1-1 = 4
                short_desc: "Includes sprint, resilience, pack tactics, groveling, and sunlight sensitivity.",
                long_desc: "Selects the following traits for 4 AP (needs +1 AP from another source):\n- Darkvision (1 AP)\n- Skittering Sprint (1 AP)\n- Draconic Resilience (Kobold) (2 AP)\n- Pack Tactics (1 AP)\n- Grovel, Cower, and Beg (1 AP)\n- Sunlight Sensitivity (Kobold) (-1 AP)", // Added Darkvision to base package
                is_default_package: true,
                default_package_traits: ["kobold-darkvision", "kobold-skittering-sprint", "kobold-draconic-resilience", "kobold-pack-tactics", "kobold-grovel-cower-beg", "kobold-sunlight-sensitivity"]
            },
            // Default Components
            {
                id: "kobold-skittering-sprint", name: "Skittering Sprint", ap: 1, category: "default_component",
                short_desc: "Disengage action increases speed by 15ft (straight line).", long_desc: "When you use the Disengage action on your turn, your walking speed increases by 15 feet until the end of your turn. You must move in a relatively straight line."
            },
            {
                id: "kobold-draconic-resilience", name: "Draconic Resilience (Kobold)", ap: 2, category: "default_component",
                short_desc: "-1 HP/level (min 1). Reaction when dropping to 0 HP: Dex save (DC 5+dmg) to drop to 1 HP instead (Prof Bonus/LR).", long_desc: "You gain 1 fewer hit point per level (minimum 1 HP per level). When you take damage that would reduce you to 0 HP, you can use your reaction to make a Dexterity saving throw with a DC equal to 5 + the damage taken. On a success, you drop to 1 HP instead. You can use this feature a number of times equal to your Proficiency Bonus per long rest."
            },
            {
                id: "kobold-pack-tactics", name: "Pack Tactics", ap: 1, category: "default_component",
                short_desc: "Adv. on attack roll vs creature if ally is within 5ft.", long_desc: "You have advantage on an attack roll against a creature if at least one of your allies is within 5 feet of the creature and the ally isn't incapacitated."
            },
            {
                id: "kobold-grovel-cower-beg", name: "Grovel, Cower, and Beg", ap: 1, category: "default_component",
                short_desc: "Action: Allies gain adv. on attacks vs enemies within 10ft (1/SR or LR).", long_desc: "As an action on your turn, you can cower pathetically to distract nearby foes. Until the end of your next turn, your allies gain advantage on attack rolls against enemies within 10 feet of you that can see you. Once you use this trait, you can't use it again until you finish a short or long rest."
            },
            // Expanded Traits
            {
                id: "kobold-draconic-legacy", name: "Draconic Legacy", ap: 2, category: "expanded",
                short_desc: "Learn one Sorcerer cantrip (Cha).", long_desc: "Choose one cantrip from the Sorcerer spell list. You learn that cantrip. Charisma is your spellcasting ability for it."
            },
            {
                id: "kobold-dauntless-spirit", name: "Dauntless Spirit", ap: 1, category: "expanded",
                short_desc: "Adv. on saves vs Frightened.", long_desc: "You have advantage on saving throws against being Frightened."
            },
            {
                id: "kobold-kobold-ingenuity", name: "Kobold Ingenuity", ap: 1, category: "expanded",
                short_desc: "Proficiency in Deception, Investigation, Stealth, or Survival.", long_desc: "You gain proficiency in one of the following skills of your choice: Deception, Investigation, Stealth, or Survival."
            },
            {
                id: "kobold-trap-sense", name: "Trap Sense", ap: 1, category: "expanded",
                short_desc: "Adv. on Perception/Investigation checks to detect traps.", long_desc: "You have advantage on Wisdom (Perception) and Intelligence (Investigation) checks made to detect traps."
            },
            {
                id: "kobold-burrower", name: "Burrower", ap: 1, category: "expanded",
                short_desc: "Burrow speed 15ft through loose earth/sand/gravel.", long_desc: "You gain a burrowing speed of 15 feet through loose earth, sand, or gravel."
            },
            {
                id: "kobold-alone-united", name: "Alone-United", ap: 1, category: "expanded",
                short_desc: "Forgo Advantage on a roll to use Help as Bonus Action.", long_desc: "If you have Advantage on an attack roll, ability check, or saving throw, you can forgo the Advantage for that roll to use the Help action as a Bonus Action on your current turn, targeting an ally within 5 feet."
            },
            {
                id: "kobold-mind-for-scraps", name: "Mind for Scraps", ap: 1, category: "expanded",
                short_desc: "Use proficient tools without physical tools (improvised). Produce common gear (Prof Bonus/LR).", long_desc: "You can make ability checks requiring artisan's tools you are proficient with even if you don't have the physical tools, by improvising with scavenged materials (GM permitting). Additionally, a number of times per long rest equal to your Proficiency Bonus, you can produce common adventuring gear items like ball bearings, caltrops, or pitons as if you had them, consuming them on use."
            },
            {
                id: "kobold-shared-space", name: "Shared Space", ap: 1, category: "expanded",
                short_desc: "Can end turn occupying same space as willing Small ally.", long_desc: "You can end your turn occupying the same space as another willing Small ally."
            },
            {
                id: "kobold-burning-blood", name: "Burning Blood", ap: 2, category: "expanded",
                short_desc: "Cast Burning Hands (1st level) Prof Bonus times/LR (Choose Ability).",
                long_desc: "You can cast Burning Hands as a 1st-level spell a number of times per long rest equal to your Proficiency Bonus. Choose your spellcasting ability for this spell below.",
                suboptions: [
                    { id: "int", name: "Intelligence", description: "Intelligence is your spellcasting ability for Burning Hands." },
                    { id: "wis", name: "Wisdom", description: "Wisdom is your spellcasting ability for Burning Hands." },
                    { id: "cha", name: "Charisma", description: "Charisma is your spellcasting ability for Burning Hands." }
                ]
            },
            {
                id: "kobold-improvised-brutality", name: "Improvised Brutality", ap: 1, category: "expanded",
                short_desc: "Proficient with improvised weapons; non-heavy/2H ones gain finesse, deal 1d6.", long_desc: "You are proficient with improvised weapons. When you wield an improvised weapon that is not heavy or two-handed, it gains the finesse property for you and deals 1d6 damage of an appropriate type (bludgeoning, piercing, or slashing)."
            },
            {
                id: "kobold-muzzle-snap", name: "Muzzle Snap", ap: 1, category: "expanded",
                short_desc: "Adv. on Intimidation checks vs creatures exactly one size larger.", long_desc: "You have Advantage on Charisma (Intimidation) checks made against creatures that are exactly one size larger than you (typically Medium)."
            },
            {
                id: "kobold-cursed-rebirth", name: "Cursed Rebirth", ap: 2, category: "expanded",
                short_desc: "If you die, soul reincarnates into newborn Kobold (retain memory/personality, level 1). Immune to revivify/raise dead. (1/LR).", long_desc: "If you die, your soul attempts to reincarnate into a suitable newborn Kobold body within your tribe or community (if one exists). You retain your memories and personality but start at level 1 in a new body (GM discretion on specifics). You are immune to magic that would return you to life (like Revivify or Raise Dead). This trait can only function once per long rest (meaning if you die again quickly, you stay dead)."
            },
            {
                id: "kobold-charm-of-the-doomed", name: "Charm of the Doomed", ap: 2, category: "expanded",
                short_desc: "Cast Charm Person (1st level) Prof Bonus times/LR (Cha).", long_desc: "You may cast Charm Person as a 1st-level spell up to your Proficiency Bonus times per long rest. Charisma is your spellcasting ability for this spell."
            },
            {
                id: "kobold-gifted-performer", name: "Gifted Performer", ap: 1, category: "expanded",
                short_desc: "Proficiency in Performance and Persuasion.", long_desc: "You gain proficiency in both the Performance and Persuasion skills."
            },
            // Negative Trait
            {
                id: "kobold-sunlight-sensitivity", name: "Sunlight Sensitivity (Kobold)", ap: -1, category: "negative",
                short_desc: "Disadv. on attacks/Perception in direct sunlight.", long_desc: "You have disadvantage on attack rolls and on Wisdom (Perception) checks that rely on sight when you, the target of your attack, or whatever you are trying to perceive is in direct sunlight."
            }
        ]
    },
    "tiefling": {
        name: "Tiefling",
        description: "Tieflings bear the mark of an infernal heritage, granting them unique abilities and often facing prejudice.",
        base_stats_override: {}, // Medium, 30ft Speed, Humanoid
        base_ability_scores: {
            description: "+1 Cha, +1 Con, -1 Wis"
        },
        traits: [
            // Base Trait
            {
                id: "tiefling-darkvision", name: "Darkvision", ap: 1, category: "default_component",
                short_desc: "See 60ft in dim/darkness.", long_desc: "You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if it were dim light."
            },
            // Default Package Meta-Trait
            {
                id: "tiefling-default-package", name: "Default Tiefling Package (Infernal Legacy)", ap: 5, category: "default_package",
                short_desc: "Standard infernal heritage. Includes Darkvision.",
                long_desc: "Selects the following traits for 5 AP:\n- Darkvision (1 AP)\n- Fiendish Resistance (Fire) (2 AP)\n- Infernal Legacy (Thaumaturgy, Hellish Rebuke, Darkness) (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-fiendish-resistance-fire", "tiefling-infernal-legacy"]
            },
            // Default Components
            {
                id: "tiefling-fiendish-resistance-fire", name: "Fiendish Resistance (Fire)", ap: 2, category: "default_component",
                short_desc: "Resistance to Fire damage.", long_desc: "You have Resistance to Fire damage."
            },
            {
                id: "tiefling-infernal-legacy", name: "Infernal Legacy", ap: 2, category: "default_component",
                short_desc: "Thaumaturgy cantrip, Hellish Rebuke (3rd, 2nd-level), Darkness (5th) 1/LR (Cha).", long_desc: "You know the Thaumaturgy cantrip. At 3rd level, you can cast Hellish Rebuke as a 2nd-level spell once per long rest. At 5th level, you can cast Darkness once per long rest. Charisma is your spellcasting ability for these spells."
            },

            // --- Subrace Legacy Packages (Replace Default) ---
            // Note: These packages are 4 AP + 1 AP Darkvision = 5 AP total.
            {
                id: "tiefling-legacy-pride-package", name: "Legacy of Pride Package (Asmodeus)", ap: 4, category: "default_package",
                short_desc: "Commanding presence, fire resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Fire) (2 AP)\n- Commanding Presence (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-fire", "tiefling-commanding-presence"]
            },
            {
                id: "tiefling-legacy-greed-package", name: "Legacy of Greed Package (Mammon)", ap: 4, category: "default_package",
                short_desc: "Finds valuables, fire resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Fire) (2 AP)\n- Find What is Valuable (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-fire", "tiefling-find-what-is-valuable"]
            },
             {
                id: "tiefling-legacy-lust-package", name: "Legacy of Lust Package (Fierna/Glasya)", ap: 4, category: "default_package",
                short_desc: "Seductive magic, fire resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Fire) (2 AP)\n- Seductive Spell (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-fire", "tiefling-seductive-spell"]
            },
            {
                id: "tiefling-legacy-envy-package", name: "Legacy of Envy Package (Levistus)", ap: 4, category: "default_package",
                short_desc: "Icy magic, cold resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Cold) (2 AP)\n- Covetous Magic (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-cold", "tiefling-covetous-magic"]
            },
            {
                id: "tiefling-legacy-gluttony-package", name: "Legacy of Gluttony Package (Baalzebul)", ap: 4, category: "default_package",
                short_desc: "Corrupting magic, poison resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Poison) (2 AP)\n- Corrupting Magic (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-poison", "tiefling-corrupting-magic"]
            },
            {
                id: "tiefling-legacy-wrath-package", name: "Legacy of Wrath Package (Zariel)", ap: 4, category: "default_package",
                short_desc: "Smite magic, fire resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Fire) (2 AP)\n- Infernal Wrath (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-fire", "tiefling-infernal-wrath"]
            },
            {
                id: "tiefling-legacy-sloth-package", name: "Legacy of Sloth Package (Belial/Dispater)", ap: 4, category: "default_package",
                short_desc: "Deceptive magic, fire resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 4 AP (add Darkvision for 5 AP total):\n- Fiendish Resistance (Fire) (2 AP)\n- Deceptive Magic (2 AP)",
                is_default_package: true,
                default_package_traits: ["tiefling-fiendish-resistance-fire", "tiefling-deceptive-magic"]
            },
             {
                id: "tiefling-legacy-lilith-package", name: "Legacy of Lilith Package", ap: 5, category: "default_package", // 1+2+1+1
                short_desc: "Necrotic grasp, fiendish magnetism.",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Fiendish Resistance (Necrotic) (1 AP)\n- Lilith’s Grasp (2 AP)\n- Fiendish Magnetism (1 AP)", // Arcane Heritage removed
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-fiendish-resistance-necrotic", "tiefling-liliths-grasp", "tiefling-fiendish-magnetism"]
            },
             {
                id: "tiefling-legacy-deceiver-package", name: "Legacy of the Deceiver Package", ap: 5, category: "default_package", // 1+2+1+1
                short_desc: "Master of disguise, psychic resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Fiendish Resistance (Psychic) (1 AP)\n- Master of Disguise (2 AP)\n- Silver Veil (1 AP)", // Illusive Edge removed
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-fiendish-resistance-psychic", "tiefling-master-of-disguise", "tiefling-silver-veil"]
            },
             {
                id: "tiefling-legacy-elements-package", name: "Legacy of the Elements Package", ap: 5, category: "default_package", // 1+2+2+0
                short_desc: "Elemental magic and resistance (Requires Choice).",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Elemental Resistance (2 AP - Requires Choice)\n- Elemental Magic (2 AP - Requires Choice)\n- Elemental Choice (0 AP - Placeholder)",
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-elemental-resistance", "tiefling-elemental-magic"] // Choice handled in components
            },
             {
                id: "tiefling-legacy-shadow-package", name: "Legacy of Shadow Package", ap: 5, category: "default_package", // 1+1+2+1
                short_desc: "Shadow blade, stealth focus.",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Fiendish Resistance (Necrotic) (1 AP)\n- Blade of Gloom (2 AP)\n- Shadow Walker (1 AP)", // Fade into Darkness removed
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-fiendish-resistance-necrotic", "tiefling-blade-of-gloom", "tiefling-shadow-walker"]
            },
             {
                id: "tiefling-legacy-celestial-package", name: "Legacy of the Celestial Package", ap: 5, category: "default_package", // 1+2+2
                short_desc: "Healing light, radiant resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Celestial Resistance (Radiant) (2 AP)\n- Healing Light (2 AP)", // Blessed Will removed
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-celestial-resistance-radiant", "tiefling-healing-light"]
            },
             {
                id: "tiefling-legacy-beast-package", name: "Legacy of the Beast Touched Package", ap: 5, category: "default_package", // 1+1+2+1
                short_desc: "Natural weapons, primal instincts.",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Fiendish Resistance (Poison) (1 AP)\n- Natural Weapon (2 AP - Requires Choice)\n- Primal Instinct (1 AP - Requires Choice)", // Wild Magic removed
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-fiendish-resistance-poison", "tiefling-natural-weapon", "tiefling-primal-instinct"]
            },
             {
                id: "tiefling-legacy-chaos-package", name: "Legacy of Chaos Package", ap: 5, category: "default_package", // 1+1+1+2
                short_desc: "Chaotic magic, psychic resistance.",
                long_desc: "Replaces Default Package. Selects the following traits for 5 AP (includes Darkvision):\n- Darkvision (1 AP)\n- Fiendish Resistance (Psychic) (1 AP)\n- Chaos Bolt (1 AP)\n- Confusing Magic (2 AP)", // Wild Effect removed
                is_default_package: true,
                default_package_traits: ["tiefling-darkvision", "tiefling-fiendish-resistance-psychic", "tiefling-chaos-bolt", "tiefling-confusing-magic"]
            },


            // --- Legacy Component Traits (also available individually) ---
            // Pride
            { id: "tiefling-commanding-presence", name: "Commanding Presence", ap: 2, category: "expanded", short_desc: "Thaumaturgy cantrip, Command (1st), Suggestion (5th) 1/LR (Cha).", long_desc: "You know the Thaumaturgy cantrip. You can cast Command as a 1st-level spell once per long rest. At 5th level, you can cast Suggestion once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-superiority-aura", name: "Superiority Aura", ap: 1, category: "expanded", short_desc: "Adv. on saves vs Charmed.", long_desc: "You have advantage on saving throws against being Charmed." },
            // Greed
            { id: "tiefling-find-what-is-valuable", name: "Find What is Valuable", ap: 2, category: "expanded", short_desc: "Mage Hand cantrip, Identify (1st), Locate Object (5th) 1/LR (Cha).", long_desc: "You know the Mage Hand cantrip. You can cast Identify once per long rest. At 5th level, you can cast Locate Object once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-gold-sense", name: "Gold Sense", ap: 1, category: "expanded", short_desc: "Adv. on checks to detect/appraise valuables.", long_desc: "You have advantage on Intelligence (Investigation) or Wisdom (Perception) checks made to detect or appraise precious metals, gems, or art objects." },
            // Lust
            { id: "tiefling-seductive-spell", name: "Seductive Spell", ap: 2, category: "expanded", short_desc: "Friends cantrip, Charm Person (1st), Enthrall (5th) 1/LR (Cha).", long_desc: "You know the Friends cantrip. You can cast Charm Person as a 1st-level spell once per long rest. At 5th level, you can cast Enthrall once per long rest. Charisma is your spellcasting ability." },
            {
                id: "tiefling-alluring", name: "Alluring", ap: 1, category: "expanded",
                short_desc: "Proficiency in Deception or Persuasion.",
                long_desc: "You gain proficiency in one skill. Choose below:",
                suboptions: [
                    { id: "deception", name: "Deception", description: "You gain proficiency in the Deception skill." },
                    { id: "persuasion", name: "Persuasion", description: "You gain proficiency in the Persuasion skill." }
                ]
            },
            // Envy
            { id: "tiefling-fiendish-resistance-cold", name: "Fiendish Resistance (Cold)", ap: 2, category: "expanded", short_desc: "Resistance to Cold damage.", long_desc: "You have Resistance to Cold damage." },
            { id: "tiefling-covetous-magic", name: "Covetous Magic", ap: 2, category: "expanded", short_desc: "Ray of Frost cantrip, Armor of Agathys (1st), Detect Thoughts (5th) 1/LR (Cha).", long_desc: "You know the Ray of Frost cantrip. You can cast Armor of Agathys as a 1st-level spell once per long rest. At 5th level, you can cast Detect Thoughts once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-watchful-mind", name: "Watchful Mind", ap: 1, category: "expanded", short_desc: "Proficiency in Insight.", long_desc: "You gain proficiency in the Insight skill." },
            // Gluttony
            { id: "tiefling-fiendish-resistance-poison", name: "Fiendish Resistance (Poison)", ap: 1, category: "expanded", short_desc: "Resistance to Poison damage.", long_desc: "You have Resistance to Poison damage." }, // Reduced cost to 1 AP
            { id: "tiefling-corrupting-magic", name: "Corrupting Magic", ap: 2, category: "expanded", short_desc: "Poison Spray cantrip, Ray of Sickness (1st), Ray of Enfeeblement (5th) 1/LR (Cha).", long_desc: "You know the Poison Spray cantrip. You can cast Ray of Sickness as a 1st-level spell once per long rest. At 5th level, you can cast Ray of Enfeeblement once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-resilient-gut", name: "Resilient Gut", ap: 1, category: "expanded", short_desc: "Adv. on saves vs Poisoned.", long_desc: "You have advantage on saving throws against being Poisoned." },
            // Wrath
            { id: "tiefling-infernal-wrath", name: "Infernal Wrath", ap: 2, category: "expanded", short_desc: "Produce Flame cantrip, Searing Smite (1st), Branding Smite (5th, 2nd-level) 1/LR (Cha).", long_desc: "You know the Produce Flame cantrip. You can cast Searing Smite as a 1st-level spell once per long rest. At 5th level, you can cast Branding Smite as a 2nd-level spell once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-fiendish-fury", name: "Fiendish Fury", ap: 1, category: "expanded", short_desc: "Proficiency in Intimidation.", long_desc: "You gain proficiency in the Intimidation skill." },
            // Sloth
            { id: "tiefling-deceptive-magic", name: "Deceptive Magic", ap: 2, category: "expanded", short_desc: "Minor Illusion cantrip, Disguise Self (1st), Invisibility (5th) 1/LR (Cha).", long_desc: "You know the Minor Illusion cantrip. You can cast Disguise Self once per long rest. At 5th level, you can cast Invisibility once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-apathy-shield", name: "Apathy Shield", ap: 1, category: "expanded", short_desc: "Reaction: gain resistance to one instance of damage (1/SR or LR).", long_desc: "When you take damage, you can use your reaction to gain resistance to that instance of damage. You can use this trait once per short or long rest." },
            // Lilith
            { id: "tiefling-fiendish-resistance-necrotic", name: "Fiendish Resistance (Necrotic)", ap: 1, category: "expanded", short_desc: "Resistance to Necrotic damage.", long_desc: "You have Resistance to Necrotic damage." },
            { id: "tiefling-liliths-grasp", name: "Lilith’s Grasp", ap: 2, category: "expanded", short_desc: "Chill Touch cantrip, Hex (1st), Suggestion (5th) 1/LR (Cha).", long_desc: "You know the Chill Touch cantrip. You can cast Hex as a 1st-level spell once per long rest. At 5th level, you can cast Suggestion once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-fiendish-magnetism", name: "Fiendish Magnetism", ap: 1, category: "expanded", short_desc: "Adv. on Intimidation/Persuasion vs fiends.", long_desc: "You have advantage on Charisma (Intimidation) and Charisma (Persuasion) checks when interacting with fiends or creatures significantly influenced by fiendish powers." },
            { id: "tiefling-arcane-heritage", name: "Arcane Heritage", ap: 1, category: "expanded", short_desc: "Proficiency in Arcana.", long_desc: "You gain proficiency in the Arcana skill." },
            // Deceiver
            { id: "tiefling-fiendish-resistance-psychic", name: "Fiendish Resistance (Psychic)", ap: 1, category: "expanded", short_desc: "Resistance to Psychic damage.", long_desc: "You have Resistance to Psychic damage." },
            { id: "tiefling-master-of-disguise", name: "Master of Disguise", ap: 2, category: "expanded", short_desc: "Minor Illusion cantrip, Disguise Self at will, Invisibility (5th) 1/LR (Cha).", long_desc: "You know the Minor Illusion cantrip. You can cast Disguise Self at will, without expending a spell slot. At 5th level, you can cast Invisibility once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-silver-veil", name: "Silver Veil", ap: 1, category: "expanded", short_desc: "Proficiency in Deception.", long_desc: "You gain proficiency in the Deception skill." },
            { id: "tiefling-illusive-edge", name: "Illusive Edge", ap: 1, category: "expanded", short_desc: "Adv. on Deception checks while under illusion effect.", long_desc: "You have advantage on Charisma (Deception) checks made while you are under the effect of an illusion spell (like Disguise Self or Minor Illusion)." },
            // Elements
            {
                id: "tiefling-elemental-resistance", name: "Elemental Resistance", ap: 2, category: "expanded",
                short_desc: "Resistance to chosen element (Acid, Cold, Lightning, Thunder).",
                long_desc: "You gain resistance to one damage type. Choose below.",
                suboptions: [
                    { id: "acid", name: "Acid Resistance", description: "Resistance to Acid damage." },
                    { id: "cold", name: "Cold Resistance", description: "Resistance to Cold damage." },
                    { id: "lightning", name: "Lightning Resistance", description: "Resistance to Lightning damage." },
                    { id: "thunder", name: "Thunder Resistance", description: "Resistance to Thunder damage." }
                ]
            },
            {
                id: "tiefling-elemental-magic", name: "Elemental Magic", ap: 2, category: "expanded",
                short_desc: "Cantrip, 1st-level spell (3rd), 2nd-level spell (5th) based on element (1/LR, Cha).",
                long_desc: "You learn spells based on an element. Choose the element below (should match Elemental Resistance). Cantrip: Acid Splash/Ray of Frost/Shocking Grasp/Thunderclap. 3rd Lvl (1/LR): Chromatic Orb (type)/Ice Knife/Thunderwave/Witch Bolt. 5th Lvl (1/LR): Dragon's Breath (type)/Gust of Wind/Maximilian's Earthen Grasp/Snilloc's Snowball Swarm. Charisma is your spellcasting ability.",
                 suboptions: [
                    { id: "acid", name: "Acid Magic", description: "Cantrip: Acid Splash. 3rd: Chromatic Orb (Acid). 5th: Dragon's Breath (Acid)." },
                    { id: "cold", name: "Cold Magic", description: "Cantrip: Ray of Frost. 3rd: Ice Knife. 5th: Snilloc's Snowball Swarm." },
                    { id: "lightning", name: "Lightning Magic", description: "Cantrip: Shocking Grasp. 3rd: Witch Bolt. 5th: Dragon's Breath (Lightning)." },
                    { id: "thunder", name: "Thunder Magic", description: "Cantrip: Thunderclap. 3rd: Thunderwave. 5th: Gust of Wind (Thematically related)." } // Adjusted 5th level spell for Thunder
                ]
            },
            { id: "tiefling-elemental-surge", name: "Elemental Surge", ap: 1, category: "expanded", short_desc: "1/LR add Cha mod to one damage roll of chosen element spell.", long_desc: "Once per long rest, when you cast a spell that deals damage of your chosen elemental type, you can add your Charisma modifier to one damage roll of that spell." },
            // Shadow
            { id: "tiefling-blade-of-gloom", name: "Blade of Gloom", ap: 2, category: "expanded", short_desc: "True Strike cantrip, Shadow Blade (2nd level) 1/LR (Cha, Conc).", long_desc: "You know the True Strike cantrip. You can cast Shadow Blade as a 2nd-level spell once per long rest. Charisma is your spellcasting ability. Requires concentration." },
            { id: "tiefling-fade-into-darkness", name: "Fade into Darkness", ap: 1, category: "expanded", short_desc: "Adv. on Stealth checks in dim light/darkness.", long_desc: "You have advantage on Dexterity (Stealth) checks made while in dim light or darkness." },
            { id: "tiefling-shadow-walker", name: "Shadow Walker", ap: 1, category: "expanded", short_desc: "Proficiency in Stealth.", long_desc: "You gain proficiency in the Stealth skill." },
            // Celestial
            { id: "tiefling-celestial-resistance-radiant", name: "Celestial Resistance (Radiant)", ap: 2, category: "expanded", short_desc: "Resistance to Radiant damage.", long_desc: "You have Resistance to Radiant damage." },
            { id: "tiefling-healing-light", name: "Healing Light", ap: 2, category: "expanded", short_desc: "Light cantrip, Cure Wounds (1st), Lesser Restoration (5th) 1/LR (Cha).", long_desc: "You know the Light cantrip. You can cast Cure Wounds as a 1st-level spell once per long rest. At 5th level, you can cast Lesser Restoration once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-blessed-will", name: "Blessed Will", ap: 1, category: "expanded", short_desc: "Adv. on saves vs Frightened or Charmed.", long_desc: "You have advantage on saving throws against being Frightened or Charmed." },
            // Beast Touched
            {
                id: "tiefling-natural-weapon", name: "Natural Weapon", ap: 2, category: "expanded",
                short_desc: "Grow claws, fangs, or horns (Choose one).",
                long_desc: "You grow claws, fangs, horns, or some other natural weapon. Choose one below:",
                suboptions: [
                    { id: "claws", name: "Claws", description: "Your unarmed strikes deal 1d6 slashing damage and have the Finesse property." },
                    { id: "fangs", name: "Fangs", description: "Your unarmed strikes deal 1d6 piercing damage. If you hit with a fang attack while grappling a creature, the attack deals an extra 1d6 damage." },
                    { id: "horns", name: "Horns", description: "Your unarmed strikes deal 1d6 piercing damage. If you move at least 10 feet straight toward a target and then hit it with a horn attack on the same turn, the target takes an extra 1d6 piercing damage." }
                ]
            },
            {
                id: "tiefling-primal-instinct", name: "Primal Instinct", ap: 1, category: "expanded",
                short_desc: "Choose: Perception/smell OR speak with specific beast type.",
                long_desc: "Choose one benefit below:",
                 suboptions: [
                    { id: "perception", name: "Keen Senses", description: "Gain proficiency in Perception and advantage on checks relying on smell." },
                    { id: "speak", name: "Beast Speaker", description: "Gain the ability to speak with a specific type of beast (e.g., canines, felines, reptiles - GM choice)." }
                ]
            },
            { id: "tiefling-wild-magic", name: "Wild Magic", ap: 1, category: "expanded", short_desc: "Learn one 1st-level Druid/Ranger spell (1/LR, Cha).", long_desc: "You learn one 1st-level spell from the Druid or Ranger spell list, often related to your beast type (e.g., Jump, Speak with Animals, Animal Friendship). You can cast it once per long rest. Charisma is your spellcasting ability." },
            // Chaos
            { id: "tiefling-chaos-bolt", name: "Chaos Bolt", ap: 1, category: "expanded", short_desc: "Know Chaos Bolt spell (treat as cantrip, scales).", long_desc: "You know the Chaos Bolt spell (treat as a cantrip you can cast at will, dealing 1d8 damage + 1d6 element, scaling like a normal cantrip). Charisma is your spellcasting ability." },
            { id: "tiefling-confusing-magic", name: "Confusing Magic", ap: 2, category: "expanded", short_desc: "Tasha's Hideous Laughter (1st), Confusion (5th) 1/LR (Cha).", long_desc: "You can cast Tasha's Hideous Laughter once per long rest. At 5th level, you can cast Confusion once per long rest. Charisma is your spellcasting ability." },
            { id: "tiefling-wild-effect", name: "Wild Effect", ap: 1, category: "expanded", short_desc: "1/LR when casting spell (1st+): roll d8, on 1 trigger minor chaos.", long_desc: "Once per long rest, when you cast a spell of 1st level or higher, roll a d8. On a 1, roll on the Wild Magic Surge table (if available) or trigger a minor, harmless chaotic effect (GM's choice, e.g., glowing eyes, spectral butterflies, temporary skin color change)." },

            // --- General Expanded Traits ---
            {
                id: "tiefling-infernal-wings", name: "Infernal Wings", ap: 2, category: "expanded",
                short_desc: "Manifest/dismiss wings (bonus action), fly speed 30ft.", long_desc: "As a Bonus Action, you can manifest or dismiss a pair of leathery, bat-like wings. While manifested, you gain a flying speed of 30 feet. You can’t manifest your wings while wearing armor unless the armor is made to accommodate them, and clothing not made to accommodate your wings might be destroyed when you manifest them."
            },
            {
                id: "tiefling-infernal-eyes", name: "Infernal Eyes", ap: 1, category: "expanded",
                short_desc: "Eyes glow faintly, adv. on Perception (sight) in dim/darkness.", long_desc: "Your eyes glow faintly in the dark. You have advantage on Wisdom (Perception) checks that rely on sight made in dim light or darkness."
            },
            {
                id: "tiefling-silver-tongue", name: "Silver Tongue", ap: 1, category: "expanded",
                short_desc: "1/LR gain adv. on one Deception or Persuasion check.", long_desc: "Once per Long Rest, you can gain advantage on one Charisma (Deception) or Charisma (Persuasion) check."
            },
            {
                id: "tiefling-hells-endurance", name: "Hell’s Endurance", ap: 2, category: "expanded",
                short_desc: "Adv. on Con saves vs Exhaustion or to maintain concentration.", long_desc: "You gain advantage on Constitution saving throws made to resist gaining Exhaustion or to maintain concentration on spells when you take damage."
            },
            {
                id: "tiefling-fiendish-memory", name: "Fiendish Memory", ap: 1, category: "expanded",
                short_desc: "Adv. on History/Religion checks about fiends/Hells/pacts.", long_desc: "You have advantage on Intelligence (History) or Intelligence (Religion) checks made to recall information about fiends, the Nine Hells, infernal pacts, or related forbidden lore."
            },
            {
                id: "tiefling-burning-step", name: "Burning Step", ap: 1, category: "expanded",
                short_desc: "Dash action leaves harmless flame trail (1 fire damage).", long_desc: "When you take the Dash action, you can choose to leave behind a faint trail of harmless, flickering flames until the start of your next turn. Creatures that enter or start their turn in a space you moved through during that Dash action take 1 fire damage (this can only damage a creature once per turn)."
            },
            {
                id: "tiefling-blood-of-fire", name: "Blood of Fire", ap: 2, category: "expanded",
                short_desc: "Prereq: Fire Resistance. Drop to 0 HP -> nearby creatures Dex save or take fire damage = level.", long_desc: "Prerequisite: Resistance to Fire damage. When you are reduced to 0 HP but not killed outright, creatures within 5 feet of you must succeed on a Dexterity saving throw (DC = 8 + Con modifier + Prof bonus) or take fire damage equal to your level as your blood momentarily ignites."
            },
            {
                id: "tiefling-wicked-insight", name: "Wicked Insight", ap: 1, category: "expanded",
                short_desc: "Adv. on Insight checks to discern lies/motives/manipulation.", long_desc: "You have advantage on Wisdom (Insight) checks made to discern lies, hidden motives, or attempts at emotional manipulation."
            },
            {
                id: "tiefling-charred-resistance", name: "Charred Resistance", ap: 1, category: "expanded",
                short_desc: "While bloodied, gain resistance to non-magical bludgeoning.", long_desc: "While you are bloodied (at half HP or less), you gain resistance to non-magical bludgeoning damage as your skin toughens like burnt hide."
            },
            {
                id: "tiefling-hexbrand", name: "Hexbrand", ap: 1, category: "expanded",
                short_desc: "Bonus action mark creature (30ft, 1 min). Next hit deals +Prof Bonus damage (1/LR).", long_desc: "As a bonus action, you can place an infernal mark on a creature you can see within 30 feet. The mark lasts for 1 minute or until you use this feature again. The next time you hit the marked creature with an attack roll before the mark expires, the attack deals additional damage equal to your proficiency bonus. You can use this feature once per long rest."
            },
            {
                id: "tiefling-fearsome-legacy", name: "Fearsome Legacy", ap: 1, category: "expanded",
                short_desc: "Reduce creature to 0 HP -> reaction force Wis save vs Frightened on nearby creatures (1/LR).", long_desc: "When you reduce a creature to 0 HP with an attack or spell, you can use your reaction to force creatures of your choice that you can see within 10 feet of you to make a Wisdom saving throw (DC = 8 + Cha modifier + Prof bonus). On a failed save, a creature is frightened of you until the end of your next turn. You can use this feature once per long rest."
            },

            // --- Negative Traits ---
            {
                id: "tiefling-radiant-weakness", name: "Radiant Weakness", ap: -1, category: "negative",
                short_desc: "Vulnerability to radiant damage.", long_desc: "You have vulnerability to radiant damage."
            },
            {
                id: "tiefling-divine-dampening", name: "Divine Dampening", ap: -1, category: "negative",
                short_desc: "Regain 1 fewer HP per die from celestial/divine healing.", long_desc: "Whenever you regain hit points from a spell or magical effect originating from a celestial or a divine spellcaster (Cleric, Paladin), you regain 1 fewer hit point per die rolled (minimum 1 HP regained)."
            },
            {
                id: "tiefling-cursed-bloodline", name: "Cursed Bloodline", ap: -1, category: "negative",
                short_desc: "Auto-fail first death save after dropping to 0 HP in combat.", long_desc: "You automatically fail the first death saving throw you make after being reduced to 0 HP in any combat encounter."
            },
            {
                id: "tiefling-unwelcome-presence", name: "Unwelcome Presence", ap: -1, category: "negative",
                short_desc: "Disadv. on Persuasion vs celestials or devout LG NPCs.", long_desc: "You have disadvantage on Charisma (Persuasion) checks made to interact with celestials or NPCs explicitly sworn to lawful good deities or causes (e.g., devout paladins, temple priests of good gods)."
            },
            {
                id: "tiefling-brittle-ego", name: "Brittle Ego", ap: -1, category: "negative",
                short_desc: "Cannot take reactions while Frightened.", long_desc: "While you are affected by the Frightened condition, you cannot take reactions."
            },
            {
                id: "tiefling-shadowmark", name: "Shadowmark", ap: -1, category: "negative",
                short_desc: "Easily detected by divination magic (adv. for detector/auto-success).", long_desc: "Your infernal nature is easily detected by magic. Creatures attempting to detect your presence using divination magic (like Detect Magic, See Invisibility, or scrying) have advantage on their checks or automatically succeed if no check is required. You have disadvantage on saving throws against such detection effects."
            },
            {
                id: "tiefling-unholy-temper", name: "Unholy Temper", ap: -1, category: "negative",
                short_desc: "While bloodied, disadv. on saves vs taunts/forced attacks.", long_desc: "While you are bloodied (at half HP or less), you have disadvantage on saving throws against being taunted or effects that would force you to attack a specific creature (like a Goading Attack)."
            },
            {
                id: "tiefling-abyssal-itch", name: "Abyssal Itch", ap: -1, category: "negative",
                short_desc: "Disadv. on saves vs magical sleep or speed reduction.", long_desc: "You have disadvantage on saving throws against magical effects that would put you to sleep or reduce your speed (such as the Slow spell or certain fey enchantments)."
            }
        ]
    }
};

        // --- State Variables ---
        let selectedAncestry1 = null;
        let selectedAncestry2 = null;
        let selectedTraits = []; // Stores objects like { ...traitData, selectedSuboptionId: '...' }
        let currentAP = 0;
        const totalAP = 5;
        let minorTraitAncestrySource = null;
        let negativeAPGain = 0;
        const maxNegativeAPGain = 2;

        // --- DOM Elements ---
        const ancestry1Select = document.getElementById('ancestry1');
        const ancestry2Select = document.getElementById('ancestry2');
        const availableTraitsList = document.getElementById('available-traits-list');
        const selectedTraitsContainer = document.getElementById('selected-traits-list');
        const apTracker = document.getElementById('ap-tracker');
        const generateSummaryBtn = document.getElementById('generate-summary');
        const copySummaryBtn = document.getElementById('copy-summary');
        const summaryOutput = document.getElementById('summary-output');
        const themeToggleBtn = document.getElementById('theme-toggle');

        // --- Initialization ---
        function initialize() {
            populateAncestrySelects();
            setupEventListeners();
            applyInitialTheme();
            renderAvailableTraits();
            renderSelectedTraits();
            updateAPDisplay();
        }

        function populateAncestrySelects() {
            const ancestries = Object.keys(ancestryData);
            ancestries.sort().forEach(key => {
                const option1 = document.createElement('option');
                option1.value = key;
                option1.textContent = ancestryData[key].name;
                ancestry1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = key;
                option2.textContent = ancestryData[key].name;
                ancestry2Select.appendChild(option2.cloneNode(true));
            });
        }

        function setupEventListeners() {
            ancestry1Select.addEventListener('change', handleAncestryChange);
            ancestry2Select.addEventListener('change', handleAncestryChange);
            availableTraitsList.addEventListener('click', handleAvailableListClick);
            selectedTraitsContainer.addEventListener('click', handleSelectedListClick); // Handles remove and radio clicks
            generateSummaryBtn.addEventListener('click', generateSummary);
            copySummaryBtn.addEventListener('click', copySummary);
            themeToggleBtn.addEventListener('click', toggleTheme);
        }

        // --- Event Handlers ---
        function handleAncestryChange() {
            selectedAncestry1 = ancestry1Select.value || null;
            selectedAncestry2 = ancestry2Select.value || null;

            if (selectedAncestry1 && selectedAncestry1 === selectedAncestry2) {
                ancestry2Select.value = "";
                selectedAncestry2 = null;
            }

            selectedTraits = selectedTraits.filter(trait => {
                const traitSourceKey = trait.id.split('-')[0];
                const isFromSelectedAncestry = traitSourceKey === selectedAncestry1 || traitSourceKey === selectedAncestry2;
                if (trait.category === 'minor' && !isFromSelectedAncestry) return false;
                return isFromSelectedAncestry;
            });

            recalculateStateFromSelection();
            renderAvailableTraits();
            renderSelectedTraits();
            updateAPDisplay();
        }

        function handleAvailableListClick(event) {
            const target = event.target;
            if (target.classList.contains('btn-add')) {
                handleAddTrait(target.dataset.traitId);
            } else if (target.classList.contains('btn-details')) {
                toggleTraitDetails(target.dataset.traitId);
            }
        }

        function handleSelectedListClick(event) {
            const target = event.target;
            if (target.classList.contains('btn-remove')) {
                handleRemoveTrait(target.dataset.traitId);
            } else if (target.matches('input[type="radio"].suboption-radio')) { // Check if it's one of our radio buttons
                handleSuboptionChange(target);
            }
        }


        function handleAddTrait(traitId) {
            const trait = findTrait(traitId);
            if (!trait) return;

            if (trait.is_default_package) {
                addDefaultPackage(trait);
            } else {
                 addSingleTrait(trait);
            }

            renderAvailableTraits();
            renderSelectedTraits();
            updateAPDisplay();
        }

        function toggleTraitDetails(traitId) {
            const longDescElement = availableTraitsList.querySelector(`.trait-desc.long[data-trait-id="${traitId}"]`);
            const detailsButton = availableTraitsList.querySelector(`.btn-details[data-trait-id="${traitId}"]`);
            if (longDescElement) {
                longDescElement.classList.toggle('hidden');
                if (detailsButton) {
                    detailsButton.textContent = longDescElement.classList.contains('hidden') ? 'Details' : 'Hide';
                }
            }
        }

         function addSingleTrait(trait) {
            if (!canAddTrait(trait)) {
                if (trait.category === 'minor' && minorTraitAncestrySource && minorTraitAncestrySource !== trait.id.split('-')[0]) {
                    alert(`Cannot add Minor Trait '${trait.name}'. All Minor Traits must come from the same ancestry ('${ancestryData[minorTraitAncestrySource]?.name || 'Unknown'}').`);
                } else if (currentAP + trait.ap > totalAP) {
                     alert(`Cannot add trait '${trait.name}'. Exceeds AP limit (${totalAP}).`);
                } else if (trait.ap < 0 && (negativeAPGain + Math.abs(trait.ap) > maxNegativeAPGain)) {
                     alert(`Cannot add Negative Trait '${trait.name}'. Exceeds Negative AP gain limit (${maxNegativeAPGain}).`);
                }
                return;
            }

            const traitToAdd = { ...trait }; // Clone trait data

            if (trait.category === 'minor' && minorTraitAncestrySource === null) {
                minorTraitAncestrySource = trait.id.split('-')[0];
            }

            if (trait.ap < 0) {
                negativeAPGain += Math.abs(trait.ap);
            }

            if (trait.suboptions && trait.suboptions.length > 0) {
                traitToAdd.selectedSuboptionId = trait.suboptions[0].id; // Default to first suboption
            }

            selectedTraits.push(traitToAdd);
            currentAP += trait.ap;
        }

        function addDefaultPackage(packageTrait) {
            const components = packageTrait.default_package_traits
                .map(id => findTrait(id))
                .filter(t => t !== null);

            let potentialAP = currentAP;
            let potentialNegativeGain = negativeAPGain;
            let potentialMinorSource = minorTraitAncestrySource;
            let canAddAll = true;
            let neededComponents = [];

            for (const component of components) {
                 if (selectedTraits.some(st => st.id === component.id)) continue;

                 neededComponents.push(component);
                 const componentSourceKey = component.id.split('-')[0];

                if (potentialAP + component.ap > totalAP) {
                    canAddAll = false; break;
                }
                 potentialAP += component.ap;

                 if (component.category === 'minor') {
                    if (potentialMinorSource === null) {
                        potentialMinorSource = componentSourceKey;
                    } else if (potentialMinorSource !== componentSourceKey) {
                        canAddAll = false; break;
                    }
                }

                if (component.ap < 0) {
                     if (potentialNegativeGain + Math.abs(component.ap) > maxNegativeAPGain) {
                        canAddAll = false; break;
                    }
                     potentialNegativeGain += Math.abs(component.ap);
                }
            }


            if (canAddAll) {
                neededComponents.forEach(component => {
                    addSingleTrait(component);
                });
            } else {
                alert(`Cannot add default package: Violates AP limit (${totalAP}), Minor Trait source rule, or Negative Trait AP gain limit (${maxNegativeAPGain}). Add components individually.`);
            }
        }


        function handleRemoveTrait(traitId) {
            const index = selectedTraits.findIndex(t => t.id === traitId);

            if (index > -1) {
                const removedTrait = selectedTraits[index];

                currentAP -= removedTrait.ap;
                if (removedTrait.ap < 0) {
                    negativeAPGain -= Math.abs(removedTrait.ap);
                }

                selectedTraits.splice(index, 1);

                if (removedTrait.category === 'minor') {
                    const remainingMinors = selectedTraits.filter(t => t.category === 'minor');
                    if (remainingMinors.length === 0) {
                        minorTraitAncestrySource = null;
                    }
                }

                renderAvailableTraits();
                renderSelectedTraits();
                updateAPDisplay();
            }
        }

        function handleSuboptionChange(radioElement) {
            const traitId = radioElement.name.replace('suboption-', ''); // Get trait ID from radio group name
            const selectedSuboptionId = radioElement.value;

            const traitIndex = selectedTraits.findIndex(t => t.id === traitId);
            if (traitIndex > -1) {
                selectedTraits[traitIndex].selectedSuboptionId = selectedSuboptionId;
                // No visual re-render needed here as all options are visible
                // Summary will pick up the change next time it's generated
                console.log(`Trait ${traitId} suboption changed to ${selectedSuboptionId}`);
            }
        }

        // --- Core Logic ---
        function findTrait(traitId) {
            const sourceAncestry = traitId.split('-')[0];
            if (ancestryData[sourceAncestry]) {
                const trait = ancestryData[sourceAncestry].traits.find(t => t.id === traitId);
                return trait ? JSON.parse(JSON.stringify(trait)) : null; // Deep copy
            }
            return null;
        }

         function canAddTrait(trait) {
            if (!trait) return false;
            if (currentAP + trait.ap > totalAP) return false;
            if (selectedTraits.some(st => st.id === trait.id)) return false;
            if (trait.ap < 0 && (negativeAPGain + Math.abs(trait.ap) > maxNegativeAPGain)) return false;

            if (trait.category === 'minor') {
                const traitSourceKey = trait.id.split('-')[0];
                if (minorTraitAncestrySource !== null && minorTraitAncestrySource !== traitSourceKey) {
                    return false;
                }
            }
            return true;
        }

        function recalculateStateFromSelection() {
            currentAP = 0;
            negativeAPGain = 0;
            minorTraitAncestrySource = null;
            let foundMinorSource = null;

            selectedTraits.forEach(trait => {
                currentAP += trait.ap;
                if (trait.ap < 0) {
                    negativeAPGain += Math.abs(trait.ap);
                }
                if (trait.category === 'minor') {
                    const traitSourceKey = trait.id.split('-')[0];
                    if (foundMinorSource === null) {
                        foundMinorSource = traitSourceKey;
                    } else if (foundMinorSource !== traitSourceKey) {
                        console.warn("Inconsistent minor trait sources found.");
                    }
                }
            });
            minorTraitAncestrySource = foundMinorSource;
        }


        // --- Rendering ---
        function renderAvailableTraits() {
            availableTraitsList.innerHTML = '';

            const availableAncestries = [selectedAncestry1, selectedAncestry2].filter(a => a);
            if (availableAncestries.length === 0) {
                availableTraitsList.innerHTML = '<li class="trait-item">Select one or two ancestries above.</li>';
                return;
            }

            let traitsToDisplay = [];
            availableAncestries.forEach(ancestryKey => {
                if (ancestryData[ancestryKey]) {
                    ancestryData[ancestryKey].traits.forEach(trait => {
                        // Get original trait data for accurate check
                        const originalTrait = ancestryData[ancestryKey].traits.find(t => t.id === trait.id);
                        traitsToDisplay.push({ ...originalTrait, sourceName: ancestryData[ancestryKey].name });
                    });
                }
            });

            traitsToDisplay.sort((a, b) => {
                const categoryOrder = { "default_package": 0, "minor": 1, "negative": 2, "default_component": 3, "expanded": 4 };
                const orderA = categoryOrder[a.category] ?? 5;
                const orderB = categoryOrder[b.category] ?? 5;
                if (orderA !== orderB) return orderA - orderB;
                return a.name.localeCompare(b.name);
            });

            if (traitsToDisplay.length === 0) {
                 availableTraitsList.innerHTML = '<li class="trait-item">No traits available for selected ancestries.</li>';
                 return;
            }

            traitsToDisplay.forEach(trait => {
                const li = document.createElement('li');
                li.classList.add('trait-item');

                const isSelected = selectedTraits.some(st => st.id === trait.id);
                // Pass the actual trait object from data to canAddTrait
                const canAdd = !isSelected && canAddTrait(trait);

                let apClass = 'zero';
                if (trait.ap > 0) apClass = 'positive';
                if (trait.ap < 0) apClass = 'negative';

                const detailsHiddenClass = 'hidden';
                const detailsButtonText = 'Details';
                const requiresChoice = trait.suboptions ? ' (Requires Choice)' : '';

                li.innerHTML = `
                    <div class="trait-header">
                        <span class="trait-name">${trait.name} ${trait.category === 'minor' ? '(Minor)' : ''} ${trait.is_default_package ? '(Package)' : ''} ${trait.category === 'negative' ? '(Negative)' : ''}</span>
                        <span class="trait-ap ${apClass}">${trait.ap < 0 ? '+' : ''}${Math.abs(trait.ap)} AP</span>
                    </div>
                    <div class="trait-desc">${trait.short_desc}${requiresChoice}</div>
                    <div class="trait-desc long ${detailsHiddenClass}" data-trait-id="${trait.id}">${trait.long_desc}</div>
                    <div class="trait-actions">
                        <button class="btn-add" data-trait-id="${trait.id}" ${canAdd ? '' : 'disabled'}>
                            ${isSelected ? 'Selected' : 'Add'}
                        </button>
                        <button class="btn-details" data-trait-id="${trait.id}">${detailsButtonText}</button>
                    </div>
                    <div class="trait-source-tag">${trait.sourceName}</div>
                `;
                availableTraitsList.appendChild(li);
            });
        }

        function renderSelectedTraits() {
            selectedTraitsContainer.innerHTML = '';

            if (selectedTraits.length === 0) {
                selectedTraitsContainer.innerHTML = '<div class="trait-item">No traits selected yet.</div>';
                return;
            }

            const groupedTraits = {
                minor: [],
                default_component: [],
                expanded: [],
                negative: []
            };

            selectedTraits.forEach(trait => {
                const categoryKey = trait.category === 'default_component' ? 'default_component' : trait.category;
                if (groupedTraits[categoryKey]) {
                    groupedTraits[categoryKey].push(trait);
                } else {
                     if (!groupedTraits.other) groupedTraits.other = [];
                     groupedTraits.other.push(trait);
                }
            });

            const categoryOrder = [
                { key: 'minor', title: 'Minor Traits' },
                { key: 'default_component', title: 'Default / Core Traits' },
                { key: 'expanded', title: 'Expanded Traits' },
                { key: 'negative', title: 'Negative Traits' },
                { key: 'other', title: 'Other Traits' }
            ];

            categoryOrder.forEach(catInfo => {
                const traitsInCategory = groupedTraits[catInfo.key];
                if (traitsInCategory && traitsInCategory.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.classList.add('selected-traits-category');

                    const title = document.createElement('h3');
                    title.textContent = catInfo.title;
                    categoryDiv.appendChild(title);

                    const ul = document.createElement('ul');
                    ul.classList.add('trait-list');
                    ul.style.maxHeight = 'none';
                    ul.style.overflowY = 'visible';

                    traitsInCategory.sort((a, b) => a.name.localeCompare(b.name));

                    traitsInCategory.forEach(trait => {
                        const li = document.createElement('li');
                        li.classList.add('trait-item');
                        const sourceAncestryName = ancestryData[trait.id.split('-')[0]]?.name || 'Unknown';

                        let apClass = 'zero';
                        if (trait.ap > 0) apClass = 'positive';
                        if (trait.ap < 0) apClass = 'negative';

                        let suboptionHTML = '';
                        let mainDescHTML = `<div class="trait-desc long">${trait.long_desc}</div>`; // Default

                        if (trait.suboptions && trait.suboptions.length > 0) {
                            mainDescHTML = ''; // Don't show main desc if suboptions exist
                            suboptionHTML = `<ul class="suboption-list">`;
                            trait.suboptions.forEach(sub => {
                                const radioId = `suboption-${trait.id}-${sub.id}`;
                                suboptionHTML += `
                                    <li>
                                        <input type="radio"
                                               id="${radioId}"
                                               name="suboption-${trait.id}"
                                               value="${sub.id}"
                                               class="suboption-radio"
                                               ${sub.id === trait.selectedSuboptionId ? 'checked' : ''}>
                                        <label for="${radioId}">${sub.name}</label>
                                        <span class="suboption-item-desc">${sub.description}</span>
                                    </li>
                                `;
                            });
                            suboptionHTML += `</ul>`;
                        }


                        li.innerHTML = `
                            <div class="trait-header">
                                <span class="trait-name">${trait.name}</span>
                                <span class="trait-ap ${apClass}">${trait.ap < 0 ? '+' : ''}${Math.abs(trait.ap)} AP</span>
                            </div>
                            ${mainDescHTML}
                            ${suboptionHTML}
                            <div class="trait-actions">
                                <button class="btn-remove" data-trait-id="${trait.id}">Remove</button>
                            </div>
                            <div class="trait-source-tag">${sourceAncestryName}</div>
                        `;
                        ul.appendChild(li);
                    });
                    categoryDiv.appendChild(ul);
                    selectedTraitsContainer.appendChild(categoryDiv);
                }
            });
        }


        function updateAPDisplay() {
            apTracker.textContent = `AP: ${currentAP} / ${totalAP}`;
            apTracker.classList.remove('over-limit', 'at-limit');
            if (currentAP > totalAP) {
                apTracker.classList.add('over-limit');
            } else if (currentAP === totalAP) {
                 apTracker.classList.add('at-limit');
            }
        }

        // --- Summary ---
        function generateSummary() {
            let summary = "Hiraeth Ancestry Summary\n";
            summary += "=========================\n\n";

            // Base Stats (Defaults)
            let size = "Medium";
            let speed = 30;
            let creatureType = "Humanoid";
            // TODO: Add logic here if traits modify these

            summary += "Base Stats:\n";
            summary += `- Creature Type: ${creatureType}\n`;
            summary += `- Size: ${size}\n`;
            summary += `- Speed: ${speed} feet\n\n`;

            // Selected Ancestries
            summary += "Selected Ancestries:\n";
            const ancestryNames = [selectedAncestry1, selectedAncestry2]
                .filter(a => a)
                .map(key => ancestryData[key]?.name || 'Unknown');
            summary += `- ${ancestryNames.join(' / ') || 'None Selected'}\n\n`;

             // Base Ability Scores
             summary += "Base Ability Scores (Apply BEFORE trait modifiers):\n";
             let scoreApplied = false;
             [selectedAncestry1, selectedAncestry2].filter(a => a).forEach(key => {
                 if (ancestryData[key]?.base_ability_scores?.description) {
                     summary += `- ${ancestryData[key].name}: ${ancestryData[key].base_ability_scores.description}\n`;
                     scoreApplied = true;
                 }
             });
             if (!scoreApplied) {
                 summary += "- (Using default ability scores or scores determined by class/background)\n";
             }
             summary += "\n";


            // Selected Traits (Categorized)
            summary += `Selected Traits (${currentAP}/${totalAP} AP):\n`;
            if (selectedTraits.length > 0) {
                const grouped = {};
                 selectedTraits.forEach(trait => {
                    const category = trait.category === 'default_component' ? 'default' : trait.category;
                    if (!grouped[category]) grouped[category] = [];
                    grouped[category].push(trait);
                 });

                 const categoryOrder = ['minor', 'default', 'expanded', 'negative'];
                 categoryOrder.forEach(catKey => {
                     if (grouped[catKey] && grouped[catKey].length > 0) {
                         summary += `\n--- ${catKey.replace('_', ' ').toUpperCase()} TRAITS ---\n`;
                         grouped[catKey].sort((a, b) => a.name.localeCompare(b.name));
                         grouped[catKey].forEach(trait => {
                            const sourceName = ancestryData[trait.id.split('-')[0]]?.name || 'Unknown';
                            let traitName = trait.name;
                            let subDesc = trait.long_desc.split('\n')[0]; // Default summary

                            // Check for selected suboption using the trait object from selectedTraits array
                            if (trait.selectedSuboptionId && trait.suboptions) {
                                // Find the original trait data to get suboption details
                                const originalTraitData = findTrait(trait.id);
                                const suboption = originalTraitData?.suboptions?.find(sub => sub.id === trait.selectedSuboptionId);
                                if (suboption) {
                                    traitName += `: ${suboption.name}`; // Append suboption name
                                    subDesc = suboption.description; // Use suboption description
                                }
                            }

                            summary += `- ${traitName} (${trait.ap} AP) [${sourceName}]\n`;
                            summary += `  * ${subDesc}\n`;
                         });
                     }
                 });

            } else {
                summary += "- None\n";
            }
            summary += "\n";

             // Rule Reminders
            summary += "Reminders:\n";
            if (minorTraitAncestrySource) {
                 const sourceName = ancestryData[minorTraitAncestrySource]?.name || 'Unknown';
                 const minorTraitCount = selectedTraits.filter(t => t.category === 'minor').length;
                 summary += `- Minor Trait(s) Selected (${minorTraitCount}) - All from: ${sourceName}\n`;
            } else {
                 summary += "- No Minor Traits selected.\n";
            }
             summary += `- AP from Negative Traits: ${negativeAPGain} (Max ${maxNegativeAPGain})\n`;
             if (currentAP !== totalAP) {
                 summary += `- WARNING: Current AP (${currentAP}) does not equal target AP (${totalAP}).\n`;
             }


            summaryOutput.value = summary;
        }

        function copySummary() {
            if (summaryOutput.value) {
                summaryOutput.select();
                summaryOutput.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    copySummaryBtn.textContent = 'Copied!';
                    setTimeout(() => { copySummaryBtn.textContent = 'Copy Summary'; }, 1500);
                } catch (err) {
                    console.error('Failed to copy summary: ', err);
                    alert('Failed to copy summary. Please copy manually.');
                }
            } else {
                alert('Generate the summary first before copying.');
            }
        }

        // --- Theme Switching ---
        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.body.setAttribute('data-theme', savedTheme);
            themeToggleBtn.textContent = savedTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
             themeToggleBtn.textContent = newTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        }

        // --- Run Initialization ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>

</body>
</html>