<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiraeth Ancestry Point Calculator</title>
    <!-- Google Font: EB Garamond -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">

    <style>
        /* --- Theme Variables (Copied from previous version) --- */
        :root {
            /* Light Mode */
            --bg-primary-light: #fdfaf6;
            --bg-secondary-light: #f4f0eb;
            --text-primary-light: #6b2c25;
            --text-secondary-light: #bb9b73;
            --accent-color-light: #a0522d; /* Sienna */
            --border-color-light: #dcd3c8;
            --highlight-bg-light: rgba(212, 163, 106, 0.2);
            --active-bg-light: rgba(189, 137, 77, 0.4);
            --shadow-color-light: rgba(107, 44, 37, 0.15);
            --glass-bg-light: rgba(253, 250, 246, 0.8);
            --glass-border-light: rgba(160, 82, 45, 0.3);
            --valid-color-light: #198754;
            --invalid-color-light: #dc3545;
            --invalid-bg-light: rgba(220, 53, 69, 0.1);
            --minor-trait-color-light: #8f7d68;
            --negative-trait-color-light: #c85a12;
            --button-bg-light: rgba(244, 240, 235, 0.7);
            --button-text-light: var(--text-primary-light);
            --button-border-light: var(--glass-border-light);
            --disabled-opacity: 0.5;

            /* Dark Mode */
            --bg-primary-dark: #222034;
            --bg-secondary-dark: #1b1830;
            --text-primary-dark: #e8e6f2;
            --text-secondary-dark: #b9b8e0;
            --accent-color-dark: #eda94d; /* Gold/Orange */
            --border-color-dark: #524f6c;
            --highlight-bg-dark: rgba(237, 174, 73, 0.2);
            --active-bg-dark: rgba(66, 159, 227, 0.3);
            --shadow-color-dark: rgba(0, 0, 0, 0.3);
            --glass-bg-dark: rgba(34, 33, 50, 0.8);
            --glass-border-dark: rgba(245, 67, 91, 0.3);
            --valid-color-dark: #20c997;
            --invalid-color-dark: #f17c70;
            --invalid-bg-dark: rgba(241, 124, 112, 0.15);
            --minor-trait-color-dark: #a09ec0;
            --negative-trait-color-dark: #ffc107;
            --button-bg-dark: rgba(52, 58, 64, 0.7);
            --button-text-dark: var(--text-primary-dark);
            --button-border-dark: var(--glass-border-dark);
            /* --disabled-opacity is same */

            /* Apply Defaults */
            --bg-primary: var(--bg-primary-light);
            --bg-secondary: var(--bg-secondary-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --accent-color: var(--accent-color-light);
            --border-color: var(--border-color-light);
            --highlight-bg: var(--highlight-bg-light);
            --active-bg: var(--active-bg-light);
            --shadow-color: var(--shadow-color-light);
            --glass-bg: var(--glass-bg-light);
            --glass-border: var(--glass-border-light);
            --valid-color: var(--valid-color-light);
            --invalid-color: var(--invalid-color-light);
            --invalid-bg: var(--invalid-bg-light);
            --minor-trait-color: var(--minor-trait-color-light);
            --negative-trait-color: var(--negative-trait-color-light);
            --button-bg: var(--button-bg-light);
            --button-text: var(--button-text-light);
            --button-border: var(--button-border-light);
        }

        body.dark-theme {
            --bg-primary: var(--bg-primary-dark);
            --bg-secondary: var(--bg-secondary-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --accent-color: var(--accent-color-dark);
            --border-color: var(--border-color-dark);
            --highlight-bg: var(--highlight-bg-dark);
            --active-bg: var(--active-bg-dark);
            --shadow-color: var(--shadow-color-dark);
            --glass-bg: var(--glass-bg-dark);
            --glass-border: var(--glass-border-dark);
            --valid-color: var(--valid-color-dark);
            --invalid-color: var(--invalid-color-dark);
            --invalid-bg: var(--invalid-bg-dark);
            --minor-trait-color: var(--minor-trait-color-dark);
            --negative-trait-color: var(--negative-trait-color-dark);
            --button-bg: var(--button-bg-dark);
            --button-text: var(--button-text-dark);
            --button-border: var(--button-border-dark);
        }

        /* --- Base & Container --- */
        html, body {
            height: 100%; margin: 0; padding: 0;
            font-family: 'EB Garamond', serif;
            background-color: var(--bg-primary); color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 25px auto;
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px var(--shadow-color);
            border: 1px solid var(--glass-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* --- Typography --- */
        h1 {
            text-align: center;
            margin-bottom: 1.2em;
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--accent-color);
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 0.5em;
        }
        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1em;
            margin-top: 0;
            color: var(--accent-color);
            padding-bottom: 0.3em;
            border-bottom: 1px solid var(--glass-border);
        }
        h3.trait-category {
            font-size: 1.3rem;
            font-weight: 700;
            margin-top: 2em;
            margin-bottom: 0.8em;
            color: var(--text-primary);
            border-bottom: 1px dotted var(--border-color);
            padding-bottom: 0.4em;
        }
        p { margin-bottom: 1.2em; font-size: 1.1rem; }

        /* --- Buttons --- */
        button {
            padding: 10px 15px;
            background-color: var(--button-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: var(--button-text);
            border: 1px solid var(--button-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'EB Garamond', serif;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            margin-right: 8px;
            box-shadow: 0 1px 3px var(--shadow-color);
        }
        button:hover {
            border-color: var(--accent-color);
            background-color: var(--highlight-bg);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            background-color: transparent;
        }
        .theme-toggle-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: var(--accent-color);
            color: var(--bg-primary);
            border: none;
            z-index: 1000;
            padding: 8px 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        body.dark-theme .theme-toggle-button {
             color: var(--bg-secondary);
        }
        .theme-toggle-button:hover {
             opacity: 0.9;
             background-color: var(--accent-color);
        }

        /* --- Ancestry Selector --- */
        .ancestry-selector {
            margin-bottom: 2.5em;
            padding: 20px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background-color: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        .ancestry-selector h3 {
             margin-top: 0;
             margin-bottom: 0.8em;
             font-size: 1.4rem;
             color: var(--text-primary);
             border-bottom: none;
             padding-bottom: 0;
        }
        .ancestry-selector label {
            margin-right: 20px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 8px;
            font-size: 1.1rem;
            transition: color 0.2s ease;
        }
        .ancestry-selector input[type="checkbox"] {
             margin-right: 6px;
             accent-color: var(--accent-color);
             transform: scale(1.1);
             vertical-align: middle;
        }
        .ancestry-selector label:hover {
            color: var(--accent-color);
        }

        /* --- Side-by-Side Layout --- */
        #trait-form { display: block; }
        #trait-form.two-columns {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        #trait-form.two-columns .ancestry-section.visible {
            flex: 1;
            min-width: 350px;
            border-top: none;
            padding-top: 0;
            margin-top: 0;
            background-color: transparent;
            border-left: none;
            padding-left: 0;
            padding-right: 0;
        }
         #trait-form.two-columns .ancestry-section.visible:first-of-type {
             padding-right: 15px;
         }
         #trait-form.two-columns .ancestry-section.visible:last-of-type {
             padding-left: 15px;
             border-left: 1px solid var(--glass-border);
         }

        .ancestry-section {
            margin-top: 2.5em;
            border-top: 1px solid var(--glass-border);
            padding-top: 2em;
            display: none;
        }
        .ancestry-section.visible { display: block; }

        /* Responsive stacking */
        @media (max-width: 900px) {
            .container { max-width: 95%; margin: 15px auto; padding: 20px; }
            #trait-form.two-columns {
                flex-direction: column;
                gap: 0;
            }
             #trait-form.two-columns .ancestry-section.visible {
                 min-width: 100%;
                 border-left: none;
                 padding-left: 0;
                 padding-right: 0;
                 margin-top: 2.5em;
                 border-top: 1px solid var(--glass-border);
                 padding-top: 2em;
             }
             #trait-form.two-columns .ancestry-section.visible:first-of-type {
                 margin-top: 0;
                 border-top: none;
                 padding-top: 0;
             }
             h1 { font-size: 2rem; }
             h2 { font-size: 1.6rem; }
        }

        /* --- Trait Items --- */
        .trait-list { list-style: none; padding: 0; }
        .trait-item {
            margin-bottom: 1em;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-secondary);
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        body.dark-theme .trait-item {
             background-color: rgba(255, 255, 255, 0.03);
             border-color: rgba(255, 255, 255, 0.1);
        }
        .trait-item:hover {
            background-color: var(--highlight-bg);
            border-color: var(--accent-color);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        .trait-item.disabled {
            opacity: var(--disabled-opacity);
            cursor: not-allowed;
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .trait-item.disabled:hover {
             background-color: var(--bg-secondary);
             border-color: var(--border-color);
             box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        body.dark-theme .trait-item.disabled {
             background-color: rgba(255, 255, 255, 0.03);
             border-color: rgba(255, 255, 255, 0.1);
        }
        body.dark-theme .trait-item.disabled:hover {
             background-color: rgba(255, 255, 255, 0.03);
             border-color: rgba(255, 255, 255, 0.1);
        }
        .trait-item.disabled label { cursor: not-allowed; }

        .trait-item > label { display: flex; align-items: flex-start; cursor: pointer; }
        .trait-item input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 6px;
            flex-shrink: 0;
            accent-color: var(--accent-color);
            transform: scale(1.1);
        }
        .trait-details { flex-grow: 1; }
        .trait-name { font-weight: 600; font-size: 1.15rem; display: inline; }
        .trait-cost {
            font-style: normal;
            margin-left: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            opacity: 0.9;
        }
        .trait-cost.minor { color: var(--minor-trait-color); }
        .trait-cost.negative { color: var(--negative-trait-color); font-weight: 600; }
        .trait-cost.positive { color: var(--text-secondary); }
        .trait-description {
            font-size: 1rem;
            margin-top: 6px;
            color: var(--text-primary);
            opacity: 0.9;
            line-height: 1.6;
        }
        .trait-description ul { margin-top: 0.6em; margin-left: 25px; }
        .trait-description li { margin-bottom: 0.4em; }

        /* Aasimar Revelation Options */
        .revelation-options {
            display: none;
            margin-top: 12px;
            padding-top: 10px;
            padding-left: 10px;
            font-size: 1rem;
            border-top: 1px dashed var(--border-color);
        }
        .revelation-options label {
            display: block;
            margin-bottom: 6px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
         .revelation-options input[type="radio"] {
            margin-right: 8px;
            accent-color: var(--accent-color);
            vertical-align: middle;
         }
         .revelation-options label:hover {
             color: var(--accent-color);
         }
        .trait-item input[type="checkbox"]:checked ~ .trait-details .revelation-options { display: block; }

        /* --- AP Tracker & Validation --- */
        .ap-tracker {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 600;
            transition: border-color 0.3s ease, color 0.3s ease;
            background-color: var(--glass-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .ap-tracker.valid { border-color: var(--valid-color); color: var(--valid-color); }
        .ap-tracker.invalid { border-color: var(--invalid-color); color: var(--invalid-color); }
        #validation-messages {
            margin-top: 0.5em;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 1rem;
            min-height: 45px;
            background-color: var(--invalid-bg);
            border: 1px solid var(--invalid-color);
            display: none;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #validation-messages.visible { display: block; }
        #validation-messages ul { list-style-position: inside; padding-left: 5px; margin: 0; }
        #validation-messages li { color: var(--invalid-color); margin-bottom: 0.3em; font-weight: 500; }
        #validation-messages li:last-child { margin-bottom: 0; }
        .ap-tracker.valid + #validation-messages { display: none; }


        /* --- Base Info Box --- */
        .base-info {
            background-color: var(--bg-secondary);
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 2em;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.04);
        }
        body.dark-theme .base-info {
             background-color: rgba(255, 255, 255, 0.02);
             border-color: rgba(255, 255, 255, 0.1);
        }
        .base-info strong { color: var(--accent-color); font-weight: 600; }
        .base-info ul { list-style-position: inside; padding-left: 5px; margin-top: 0.7em; margin-bottom: 0; }
        .base-info li { margin-bottom: 0.3em; }


        /* --- Summary Section --- */
        .summary-section {
            margin-top: 3em;
            padding-top: 2em;
            border-top: 1px solid var(--glass-border);
        }
        .summary-section h3 {
             font-size: 1.6rem;
             color: var(--text-primary);
             margin-bottom: 0.8em;
        }
        #summary-output {
            width: 100%;
            min-height: 200px;
            margin-top: 10px;
            padding: 15px;
            font-family: 'EB Garamond', serif;
            font-size: 1.1rem;
            line-height: 1.7;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            resize: vertical;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.06);
        }
        body.dark-theme #summary-output {
             background-color: var(--bg-secondary-dark);
             border-color: var(--border-color-dark);
        }
        .summary-controls { margin-top: 15px; text-align: right; }

        /* Loading/Error Message */
        #loading-error {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: var(--invalid-color);
        }

    </style>
</head>
<body>

    <!-- Moved Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle-button">Toggle Theme</button>

    <div class="container">
        <h1>Hiraeth Ancestry Calculator</h1>

        <p>Select one or two ancestries below to choose traits from. You start with <strong>5 Ancestry Points (AP)</strong>. Your total cost must equal exactly 5 AP at character creation. You can gain a maximum of 2 AP from Negative Traits.
        <br><strong>Minor Traits (0 AP):</strong> If you select only <strong>one</strong> ancestry, you may choose a maximum of <strong>one</strong> Minor Trait. If you select <strong>two</strong> ancestries, you may choose one or more Minor Traits, but they must <strong>all</strong> come from the <strong>same single ancestry</strong>.</p>

        <!-- Ancestry Selector (Populated by JS) -->
        <div id="ancestry-selector" class="ancestry-selector">
            <h3>Select Ancestries (Choose 1 or 2):</h3>
            <!-- Checkboxes added dynamically -->
        </div>

        <!-- AP Tracker and Validation -->
        <div id="ap-tracker" class="ap-tracker">
            Total AP Spent: <span id="current-ap">0</span> / 5
        </div>
        <div id="validation-messages"></div> <!-- Errors appear here -->
        <div id="loading-error"></div> <!-- Loading/Error messages -->

        <!-- Trait Forms Container (Populated by JS) -->
        <form id="trait-form">
            <!-- Race sections added dynamically -->
        </form>

        <!-- Summary Section -->
        <section class="summary-section">
            <h3>Selection Summary</h3>
            <textarea id="summary-output" readonly placeholder="Click 'Show Summary' to generate your selection details here..."></textarea>
            <div class="summary-controls">
                 <button id="show-summary-button">Show Summary</button>
                 <button id="copy-summary-button">Copy Summary</button>
            </div>
        </section>

    </div> <!-- End Container -->

    <!-- Templates -->
    <template id="ancestry-checkbox-template">
        <label>
            <input type="checkbox" name="ancestry-choice" value=""> <span class="ancestry-name">Race Name</span>
        </label>
    </template>

    <template id="race-section-template">
         <section class="ancestry-section" data-ancestry-id="">
            <h2 class="race-name-display">Race Name</h2>
            <div class="base-info">
                <strong>Base Traits:</strong>
                <ul>
                    <!-- Base info list items added dynamically -->
                </ul>
            </div>
            <!-- Trait Categories (populated dynamically) -->
            <div class="trait-category-container minor-traits">
                <h3 class="trait-category">Minor Traits</h3>
                <ul class="trait-list"></ul>
            </div>
            <div class="trait-category-container default-traits">
                 <h3 class="trait-category">Default Traits</h3>
                 <ul class="trait-list"></ul>
            </div>
            <div class="trait-category-container expanded-traits">
                <h3 class="trait-category">Expanded Traits</h3>
                <ul class="trait-list"></ul>
            </div>
            <div class="trait-category-container negative-traits">
                <h3 class="trait-category">Negative Traits (Grant AP)</h3>
                <ul class="trait-list"></ul>
            </div>
        </section>
    </template>

    <template id="trait-item-template">
         <!-- Corrected: The LI is the .trait-item -->
        <li class="trait-item">
            <label>
                <input type="checkbox" name="ancestry-trait" data-ap="" data-type="" data-trait-name="" data-ancestry="">
                <div class="trait-details">
                    <span class="trait-name">Trait Name</span>
                    <span class="trait-cost">(X AP)</span>
                    <p class="trait-description">Trait description goes here.</p>
                    <!-- Placeholder for subtypes -->
                    <div class="revelation-options" style="display: none;"></div>
                </div>
            </label>
        </li>
    </template>

    <template id="revelation-option-template">
        <label>
            <input type="radio" name="" value=""> <span class="subtype-label">Subtype Name</span>
        </label>
    </template>


    <script>
        // --- DOM References ---
        const traitForm = document.getElementById('trait-form');
        const ancestrySelector = document.getElementById('ancestry-selector');
        const currentApSpan = document.getElementById('current-ap');
        const apTrackerDiv = document.getElementById('ap-tracker');
        const validationMessagesDiv = document.getElementById('validation-messages');
        const themeToggleButton = document.getElementById('theme-toggle');
        const showSummaryButton = document.getElementById('show-summary-button');
        const copySummaryButton = document.getElementById('copy-summary-button');
        const summaryOutput = document.getElementById('summary-output');
        const loadingErrorDiv = document.getElementById('loading-error');
        const body = document.body;

        // Templates
        const ancestryCheckboxTemplate = document.getElementById('ancestry-checkbox-template');
        const raceSectionTemplate = document.getElementById('race-section-template');
        const traitItemTemplate = document.getElementById('trait-item-template');
        const revelationOptionTemplate = document.getElementById('revelation-option-template');

        // --- Constants ---
        const STARTING_AP = 5;
        const MAX_NEGATIVE_AP_GAIN = 2;
        const MAX_MINOR_TRAITS_SINGLE_ANCESTRY = 1;
        const MAX_ANCESTRIES = 2;
        const RACE_DATA_URL = 'races.json'; // Path to your JSON file

        // --- Global State ---
        let allRaceData = []; // To store the fetched race data
        let visibleRaceSections = {}; // To track dynamically added sections

        // --- Helper Functions ---
        function getTraitName(checkbox) {
            return checkbox.dataset.traitName || 'Unknown Trait';
        }

        function setTraitDisabled(checkbox, isDisabled) {
            const item = checkbox.closest('.trait-item'); // Target the LI
            if (item) {
                item.classList.toggle('disabled', isDisabled);
                checkbox.disabled = isDisabled;
            } else {
                console.warn("Could not find parent .trait-item for checkbox:", checkbox.id);
            }
        }

        // --- UI Population ---
        function populateAncestrySelector(races) {
            // Ensure the container exists before clearing/appending
            const selectorContainer = document.getElementById('ancestry-selector');
             if (!selectorContainer) {
                 console.error("Ancestry selector container not found!");
                 loadingErrorDiv.textContent = 'Error: Ancestry selector container missing in HTML.';
                 return;
             }
            selectorContainer.innerHTML = '<h3>Select Ancestries (Choose 1 or 2):</h3>'; // Clear existing
            races.forEach(race => {
                if (!ancestryCheckboxTemplate) {
                     console.error("Ancestry checkbox template not found!");
                     return;
                }
                const clone = ancestryCheckboxTemplate.content.cloneNode(true);
                const label = clone.querySelector('label');
                const input = clone.querySelector('input');
                const span = clone.querySelector('.ancestry-name');

                if (!label || !input || !span) {
                     console.error("Template structure error in ancestry checkbox template.");
                     return;
                }

                input.value = race.id;
                input.id = `select-${race.id}`;
                label.htmlFor = input.id;
                span.textContent = race.name;

                selectorContainer.appendChild(clone);
            });
            // Add event listener after populating
            selectorContainer.addEventListener('change', handleAncestrySelectionChange);
        }

        function createRaceSection(race) {
             if (!raceSectionTemplate || !traitItemTemplate || !revelationOptionTemplate) {
                 console.error("One or more HTML templates are missing!");
                 loadingErrorDiv.textContent = 'Error: Required HTML templates are missing.';
                 return; // Stop execution if templates aren't found
             }

            const sectionClone = raceSectionTemplate.content.cloneNode(true);
            const sectionElement = sectionClone.querySelector('.ancestry-section');
            const baseInfoList = sectionClone.querySelector('.base-info ul');
            const raceNameDisplay = sectionClone.querySelector('.race-name-display');

            if (!sectionElement || !baseInfoList || !raceNameDisplay) {
                 console.error("Template structure error in race section template.");
                 return;
            }


            sectionElement.id = `${race.id}-section`;
            sectionElement.dataset.ancestryId = race.id;
            raceNameDisplay.textContent = race.name;

            // Populate Base Info
            baseInfoList.innerHTML = '';
            if (race.baseInfo) {
                for (const [key, value] of Object.entries(race.baseInfo)) {
                    if (value) {
                        const li = document.createElement('li');
                        const keyFormatted = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        li.innerHTML = `<strong>${keyFormatted}:</strong> ${value}`;
                        baseInfoList.appendChild(li);
                    }
                }
            }

            // Group traits by type
            const traitsByType = { minor: [], default: [], expanded: [], negative: [] };
            (race.traits || []).forEach(trait => {
                if (traitsByType[trait.type]) {
                    traitsByType[trait.type].push(trait);
                } else {
                    console.warn(`Unknown trait type "${trait.type}" for trait "${trait.name}" in race "${race.name}"`);
                }
            });

            // Populate Trait Lists
            for (const [type, traits] of Object.entries(traitsByType)) {
                const categoryContainer = sectionClone.querySelector(`.trait-category-container.${type}-traits`);
                const listElement = categoryContainer?.querySelector('.trait-list');

                if (!listElement || !categoryContainer) {
                     console.warn(`Could not find list container for type "${type}" in race "${race.name}"`);
                     continue;
                }

                if (traits.length === 0) {
                    categoryContainer.style.display = 'none';
                    continue;
                } else {
                     categoryContainer.style.display = '';
                }


                traits.forEach(trait => {
                    const traitClone = traitItemTemplate.content.cloneNode(true);
                    // *** CORRECTED SELECTOR ***
                    const listItem = traitClone.querySelector('.trait-item'); // Select the LI element
                    const label = traitClone.querySelector('label');
                    const input = traitClone.querySelector('input');
                    const nameSpan = traitClone.querySelector('.trait-name');
                    const costSpan = traitClone.querySelector('.trait-cost');
                    const descP = traitClone.querySelector('.trait-description');
                    const revelationOptionsDiv = traitClone.querySelector('.revelation-options');

                    if (!listItem || !label || !input || !nameSpan || !costSpan || !descP || !revelationOptionsDiv) {
                         console.error("Template structure error in trait item template for trait:", trait.name);
                         return; // Skip this trait if template is broken
                    }

                    input.id = trait.id;
                    input.dataset.ap = trait.ap;
                    input.dataset.type = trait.type;
                    input.dataset.traitName = trait.name;
                    input.dataset.ancestry = race.id;
                    label.htmlFor = input.id;

                    nameSpan.textContent = trait.name;
                    costSpan.textContent = `(${trait.ap > 0 ? '+' : ''}${trait.ap} AP)`;
                    costSpan.className = 'trait-cost';
                    if (trait.ap === 0) costSpan.classList.add('minor');
                    if (trait.ap < 0) costSpan.classList.add('negative');
                    if (trait.ap > 0) costSpan.classList.add('positive');

                    descP.textContent = trait.description;

                    // Handle subtypes
                    if (trait.subtypes && trait.subtypes.length > 0) {
                        revelationOptionsDiv.innerHTML = '';
                        revelationOptionsDiv.id = `${trait.id}-options`;
                        trait.subtypes.forEach(subtype => {
                            const subtypeClone = revelationOptionTemplate.content.cloneNode(true);
                            const subtypeLabel = subtypeClone.querySelector('label');
                            const subtypeInput = subtypeClone.querySelector('input');
                            const subtypeSpan = subtypeClone.querySelector('.subtype-label');

                             if (!subtypeLabel || !subtypeInput || !subtypeSpan) {
                                 console.error("Template structure error in revelation option template.");
                                 return;
                             }

                            subtypeInput.name = `${trait.id}-choice`;
                            subtypeInput.value = subtype.value;
                            subtypeInput.id = `${trait.id}-${subtype.value.toLowerCase().replace(/\s+/g, '-')}`;
                            subtypeLabel.htmlFor = subtypeInput.id;
                            subtypeSpan.textContent = subtype.label;

                            revelationOptionsDiv.appendChild(subtypeClone);
                        });
                         revelationOptionsDiv.style.display = '';
                         input.addEventListener('change', calculateAndValidateAP);
                         revelationOptionsDiv.addEventListener('change', calculateAndValidateAP);

                    } else {
                        revelationOptionsDiv.remove();
                    }

                    // Append the actual list item (LI)
                    listElement.appendChild(listItem);
                });
            }

            traitForm.appendChild(sectionClone);
            visibleRaceSections[race.id] = sectionElement;
        }

        // --- Event Handlers ---
        function handleAncestrySelectionChange() {
            const selectedCheckboxes = ancestrySelector.querySelectorAll('input[name="ancestry-choice"]:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            let selectedCount = selectedCheckboxes.length;

            ancestrySelector.querySelectorAll('input[name="ancestry-choice"]:not(:checked)').forEach(cb => {
                cb.disabled = selectedCount >= MAX_ANCESTRIES;
            });

            Object.keys(visibleRaceSections).forEach(id => {
                 if (visibleRaceSections[id]) { // Check if section exists
                    visibleRaceSections[id].classList.toggle('visible', selectedIds.includes(id));
                 }
            });

            traitForm.classList.toggle('two-columns', selectedCount === 2);

            calculateAndValidateAP();
        }

        // --- Core Calculation & Validation ---
        function calculateAndValidateAP() {
            // Reset disabled state for all visible traits first
            traitForm.querySelectorAll('.ancestry-section.visible input[name="ancestry-trait"]').forEach(cb => {
                setTraitDisabled(cb, false);
            });

            const checkedTraits = traitForm.querySelectorAll('.ancestry-section.visible input[name="ancestry-trait"]:checked');
            const allVisibleCheckboxes = traitForm.querySelectorAll('.ancestry-section.visible input[name="ancestry-trait"]');

            let totalAP = 0;
            let minorTraitCount = 0;
            let negativeAPGain = 0;
            const validationMessages = [];
            let isSelectionValid = true;
            const selectedMinorTraits = [];

            checkedTraits.forEach(trait => {
                const apCost = parseInt(trait.dataset.ap, 10);
                const traitType = trait.dataset.type;

                totalAP += apCost;

                if (traitType === 'minor') {
                    minorTraitCount++;
                    selectedMinorTraits.push(trait);
                } else if (traitType === 'negative') {
                    negativeAPGain += Math.abs(apCost);
                }
            });

            // --- Validation Checks & Disabling Logic ---
            const selectedAncestryCount = ancestrySelector.querySelectorAll('input[name="ancestry-choice"]:checked').length;

            if (selectedAncestryCount === 0) {
                 validationMessages.push(`Please select at least one ancestry.`);
                 isSelectionValid = false;
            }
            if (totalAP !== STARTING_AP) {
                validationMessages.push(`Total AP must be exactly ${STARTING_AP}. Current: ${totalAP}`);
                isSelectionValid = false;
            }
            if (negativeAPGain > MAX_NEGATIVE_AP_GAIN) {
                validationMessages.push(`Max ${MAX_NEGATIVE_AP_GAIN} AP gain from Negative Traits allowed. Gained: ${negativeAPGain}`);
                isSelectionValid = false;
                allVisibleCheckboxes.forEach(cb => {
                    if (cb.dataset.type === 'negative' && !cb.checked) {
                        setTraitDisabled(cb, true);
                    }
                });
            }

            // Minor Trait Checks & Disabling
            if (selectedAncestryCount === 1) {
                if (minorTraitCount >= MAX_MINOR_TRAITS_SINGLE_ANCESTRY) {
                    if (minorTraitCount > MAX_MINOR_TRAITS_SINGLE_ANCESTRY) {
                         validationMessages.push(`Max ${MAX_MINOR_TRAITS_SINGLE_ANCESTRY} Minor Trait allowed when only one ancestry is selected. Selected: ${minorTraitCount}`);
                         isSelectionValid = false;
                    }
                    allVisibleCheckboxes.forEach(cb => {
                        if (cb.dataset.type === 'minor' && !cb.checked) {
                            setTraitDisabled(cb, true);
                        }
                    });
                }
            } else if (selectedAncestryCount === 2) {
                if (minorTraitCount > 0) {
                    const minorTraitOrigins = new Set();
                    selectedMinorTraits.forEach(trait => {
                        if (trait.dataset.ancestry) {
                            minorTraitOrigins.add(trait.dataset.ancestry);
                        }
                    });

                    if (minorTraitOrigins.size > 1) {
                        validationMessages.push(`Minor Traits must all come from the same ancestry when two ancestries are chosen.`);
                        isSelectionValid = false;
                        // Disable ALL minor traits if mixed origins are selected
                         allVisibleCheckboxes.forEach(cb => {
                            if (cb.dataset.type === 'minor' && !cb.checked) {
                                setTraitDisabled(cb, true);
                            }
                        });
                    } else {
                        // Disable minor traits from the *other* ancestry
                        const origin = minorTraitOrigins.values().next().value;
                        allVisibleCheckboxes.forEach(cb => {
                            if (cb.dataset.type === 'minor' && cb.dataset.ancestry !== origin) {
                                setTraitDisabled(cb, true);
                            }
                        });
                    }
                }
            }

            // Check Aasimar Revelation subtype (if Aasimar section exists and is visible)
            const aasimarSection = document.getElementById('aasimar-section');
            if (aasimarSection && aasimarSection.classList.contains('visible')) {
                const revelationCheckbox = document.getElementById('aasimar-celestial-revelation');
                if (revelationCheckbox && revelationCheckbox.checked) {
                    const subtypeRadioName = `${revelationCheckbox.id}-choice`;
                    const selectedSubtype = document.querySelector(`input[name="${subtypeRadioName}"]:checked`);
                    if (!selectedSubtype) {
                         validationMessages.push(`Please select a Celestial Revelation subtype.`);
                         isSelectionValid = false;
                    }
                }
            }


            // --- Update Display ---
            currentApSpan.textContent = totalAP;
            apTrackerDiv.classList.remove('valid', 'invalid');
            validationMessagesDiv.classList.remove('visible');

            if (isSelectionValid) {
                 apTrackerDiv.classList.add('valid');
            } else {
                 apTrackerDiv.classList.add('invalid');
                 validationMessagesDiv.innerHTML = `<ul>${validationMessages.map(msg => `<li>${msg}</li>`).join('')}</ul>`;
                 validationMessagesDiv.classList.add('visible');
            }

            showSummaryButton.disabled = !isSelectionValid;
            copySummaryButton.disabled = !isSelectionValid || summaryOutput.value.trim() === '';
        }

        // --- Summary & Export ---
        function generateSummary() {
            if (!apTrackerDiv.classList.contains('valid')) {
                summaryOutput.value = "Please fix validation errors before generating summary.";
                copySummaryButton.disabled = true;
                return;
            }

            let summary = "Hiraeth Ancestry Summary\n";
            summary += "=========================\n\n";

            const selectedCheckboxes = ancestrySelector.querySelectorAll('input[name="ancestry-choice"]:checked');
            summary += "Ancestries: ";
            const ancestryNames = [];
            selectedCheckboxes.forEach(cb => {
                const race = allRaceData.find(r => r.id === cb.value);
                if (race) ancestryNames.push(race.name);
            });
            summary += ancestryNames.join(' / ') + "\n\n";

            summary += "Traits Selected:\n";
            const checkedTraits = traitForm.querySelectorAll('.ancestry-section.visible input[name="ancestry-trait"]:checked');
            if (checkedTraits.length === 0) {
                summary += "- None\n";
            } else {
                checkedTraits.forEach(trait => {
                    const traitName = getTraitName(trait);
                    const apCost = parseInt(trait.dataset.ap, 10);
                    summary += `- ${traitName} (${apCost > 0 ? '+' : ''}${apCost} AP)`;

                    // Check for Aasimar Revelation specifically by ID
                    if (trait.id === 'aasimar-celestial-revelation') {
                         const subtypeRadioName = `${trait.id}-choice`;
                         const selectedSubtype = document.querySelector(`input[name="${subtypeRadioName}"]:checked`);
                        if (selectedSubtype) {
                            summary += ` [Subtype: ${selectedSubtype.value}]`;
                        } else {
                             summary += ` [Subtype: NOT SELECTED]`;
                        }
                    }
                    summary += "\n";
                });
            }

            summary += "\n-------------------------\n";
            summary += `Total AP Spent: ${currentApSpan.textContent} / ${STARTING_AP}\n`;
            summary += "=========================\n";

            summaryOutput.value = summary;
            copySummaryButton.disabled = false;
        }

        async function copySummary() {
            if (!summaryOutput.value || copySummaryButton.disabled) return;
            try {
                await navigator.clipboard.writeText(summaryOutput.value);
                copySummaryButton.textContent = 'Copied!';
                setTimeout(() => { copySummaryButton.textContent = 'Copy Summary'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                copySummaryButton.textContent = 'Copy Failed';
                 setTimeout(() => { copySummaryButton.textContent = 'Copy Summary'; }, 2000);
            }
        }

        // --- Theme Toggle ---
        function toggleTheme() {
            body.classList.toggle('dark-theme');
            localStorage.setItem('theme', body.classList.contains('dark-theme') ? 'dark' : 'light');
            themeToggleButton.textContent = body.classList.contains('dark-theme') ? "Light Mode" : "Dark Mode";
        }

        // --- Initialization ---
        async function initializeApp() {
            loadingErrorDiv.textContent = 'Loading race data...';
            try {
                const response = await fetch(RACE_DATA_URL);
                if (!response.ok) {
                    // Attempt to provide more specific feedback for common GitHub Pages issues
                    if (response.status === 404) {
                         throw new Error(`HTTP error! status: ${response.status} (Not Found). Make sure '${RACE_DATA_URL}' exists in the same directory as index.html and the filename case matches exactly.`);
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                allRaceData = await response.json();
                loadingErrorDiv.textContent = ''; // Clear loading message

                if (!Array.isArray(allRaceData) || allRaceData.length === 0) {
                     throw new Error("Fetched data is not a valid race array or is empty.");
                }

                // Populate UI
                populateAncestrySelector(allRaceData);
                allRaceData.forEach(createRaceSection); // Create all sections initially (hidden)

                // Add global listener for trait changes AFTER sections are created
                traitForm.addEventListener('change', calculateAndValidateAP);

                // Set initial theme
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    body.classList.add('dark-theme');
                    themeToggleButton.textContent = "Light Mode";
                } else {
                     body.classList.remove('dark-theme');
                     themeToggleButton.textContent = "Dark Mode";
                }

                // Initial validation and button states
                updateVisibleSections(); // This calls calculateAndValidateAP
                copySummaryButton.disabled = true;
                showSummaryButton.disabled = !apTrackerDiv.classList.contains('valid');

            } catch (error) {
                console.error('Failed to load or process race data:', error);
                loadingErrorDiv.textContent = `Error loading race data: ${error.message}. Please check the file and console for details.`;
                // Disable controls if data fails to load
                ancestrySelector.innerHTML = '<h3>Error Loading Races</h3>';
                showSummaryButton.disabled = true;
                copySummaryButton.disabled = true;
            }
        }

        // --- Event Listeners ---
        themeToggleButton.addEventListener('click', toggleTheme);
        showSummaryButton.addEventListener('click', generateSummary);
        copySummaryButton.addEventListener('click', copySummary);

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>